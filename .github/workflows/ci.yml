name: ci

on:
  push:
    branches: [main, feat/**, fix/**, chore/**]
  pull_request:

jobs:
  lint_unit:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "npm"
      - name: Install dependencies (prefer clean install)
        run: |
          if npm ci; then
            echo "npm ci succeeded"
          else
            echo "npm ci failed – falling back to npm install"
            npm install
          fi
      - name: Build artifacts with integrity (sanity)
        run: npm run artifacts:build:integrity
      - name: Precheck plugins and manifests
        run: npm run ci:precheck
      - name: Lint
        run: npm run lint
      - name: Unit tests
        run: npm test

  e2e_cypress:
    runs-on: ubuntu-latest
    needs: lint_unit
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "npm"
      - name: Install dependencies (prefer clean install)
        run: |
          if npm ci; then
            echo "npm ci succeeded"
          else
            echo "npm ci failed – falling back to npm install"
            npm install
          fi
      - name: Cache Cypress binary
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/Cypress
          key: cypress-${{ runner.os }}-${{ hashFiles('package-lock.json') }}
      - name: Build + Preview + Cypress E2E (Chrome)
        run: npm run e2e:cypress:chrome
      # Always print captured app logs to job output for debugging
      - name: Print app logs (.logs)
        if: always()
        run: |
          echo "--- Begin .logs ---"
          if [ -d ".logs" ]; then
            for f in .logs/*; do
              echo "----- $f -----" && cat "$f" || true
            done
          else
            echo "No .logs directory found"
          fi
          echo "--- End .logs ---"
      - name: Upload Cypress videos on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: cypress-videos
          path: cypress/videos
          if-no-files-found: ignore
      - name: Upload Cypress screenshots on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: cypress-screenshots
          path: cypress/screenshots
          if-no-files-found: ignore
      - name: Upload E2E artifacts on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-artifacts
          path: cypress/artifacts
          if-no-files-found: ignore
      # Always upload .logs as artifact for post-run inspection
      - name: Upload app logs (.logs)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: app-logs
          path: .logs
          if-no-files-found: warn

name: ci

# Monorepo-aware CI pipeline
# - Installs all workspace packages via npm workspaces
# - Runs lint, test, and E2E across host and packages
# - Caches node_modules and Cypress binary for faster builds

on:
  push:
    branches: [main, feat/**, fix/**, chore/**]
  pull_request:

jobs:
  lint_unit:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "npm"
      - name: Install dependencies (prefer clean install)
        run: |
          if npm ci --legacy-peer-deps; then
            echo "npm ci succeeded"
          else
            echo "npm ci failed – falling back to npm install"
            npm install --legacy-peer-deps
          fi
      - name: Build artifacts with integrity (sanity)
        run: npm run artifacts:build:integrity
      - name: Precheck plugins and manifests
        run: npm run ci:precheck
      - name: Lint
        run: npm run lint
      - name: Unit tests
        run: npm test

  e2e_cypress:
    runs-on: ubuntu-latest
    needs: lint_unit
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "npm"
      - name: Install dependencies (prefer clean install)
        run: |
          if npm ci --legacy-peer-deps; then
            echo "npm ci succeeded"
          else
            echo "npm ci failed – falling back to npm install"
            npm install --legacy-peer-deps
          fi
      - name: Cache Cypress binary
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/Cypress
          key: cypress-${{ runner.os }}-${{ hashFiles('package-lock.json') }}
      - name: Build + Preview + Cypress E2E
        run: npm run e2e:cypress
      - name: Print app logs on failure
        if: failure()
        run: |
          echo "=== .logs (if present) ==="
          if [ -d ".logs" ]; then
            ls -la .logs || true
            for f in ./.logs/*.log; do
              [ -e "$f" ] || continue
              echo "::group::$f"
              tail -n 400 "$f" || true
              echo "::endgroup::"
            done
          else
            echo "No .logs directory found."
          fi
          echo "=== cypress/artifacts (if present) ==="
          if [ -d "cypress/artifacts" ]; then
            find cypress/artifacts -type f -name "*.log" | while read -r f; do
              echo "::group::$f"
              tail -n 400 "$f" || true
              echo "::endgroup::"
            done
          else
            echo "No cypress/artifacts directory found."
          fi

      - name: Upload Cypress videos on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: cypress-videos
          path: cypress/videos
          if-no-files-found: ignore
      - name: Upload Cypress screenshots on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: cypress-screenshots
          path: cypress/screenshots
          if-no-files-found: ignore
      - name: Upload E2E artifacts on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-artifacts
          path: cypress/artifacts
          if-no-files-found: ignore
      - name: Upload app logs on failure (.logs)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: app-logs
          path: .logs
          include-hidden-files: true
          if-no-files-found: ignore


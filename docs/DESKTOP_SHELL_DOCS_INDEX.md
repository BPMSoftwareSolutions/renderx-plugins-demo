# Desktop Shell Upgrade — Documentation Index (Authoritative)

Purpose: Curate exactly what future agents should read and follow for the NATIVE Avalonia desktop shell upgrade, and flag any misleading or transitional docs.

Scope: This index covers the native Avalonia thin-host, conductor/HostSDK parity, and manifest‑driven plugin decoupling. WebView2 and web-only guidance is explicitly marked as Deprecated/Out of Scope.

---
## Primary Documentation = Guardrails + ESLint + Unit Tests (Canonical)

These are the sources of truth. Narrative docs are secondary to what the guardrails and tests enforce.

- Roslyn Analyzer (Desktop gate)
  - Path: src/RenderX.Shell.Avalonia.Analyzers
  - Rules: SHELL001 (thin host), SHELL002 (no hardcoded plugin controls/imports in MainWindow)
  - Run: dotnet build src/RenderX.Shell.Avalonia/RenderX.Shell.Avalonia.csproj

- ESLint Rules (Web/packages gate)
  - Paths: eslint-rules/*.js and docs/eslint-rules/**
  - Run: npm run lint

- Unit & E2E Tests (Behavioral contract)
  - Web/unit+integration: tests/*.spec.ts(x) → Run: npm test
  - Cypress E2E: cypress/e2e/** → Run: npm run e2e:cypress
  - Desktop .NET tests: src/RenderX.Shell.Avalonia.E2ETests/** → Run: dotnet test
    • Note: src/RenderX.Shell.Avalonia.Minimal.Tests/** targets WebView2 legacy and is transitional/caution

High‑signal tests to consult for intended behaviors:
- tests/topics-manifest-guard.spec.ts
- tests/no-local-interactions.spec.ts
- tests/no-local-topics-merge.spec.ts
- tests/lint-mountability.spec.ts
- tests/json-interactions-generation.spec.ts
- tests/test-plugin-loader.spec.tsx
- cypress/e2e/00-startup-plugins-loaded.cy.ts


## Read First (Authoritative)

- ARCHITECTURE_RULES_FOR_AGENTS.md
  - Canonical rules enforced by Roslyn: SHELL001 (thin host), SHELL002 (plugin decoupling)
  - Correct vs incorrect patterns and parity table

- docs/adr/ADR-0015-SHELL-THIN-HOST-ARCHITECTURE.md
  - Decision: Shell stays a thin host consuming SDKs (no re-implementation)

- docs/adr/ADR-0023 — Host SDK and Plugin Decoupling.md
  - Decision: Decouple plugins from the host; use manifest-driven loading

- docs/adr/ADR-0024-Desktop-Plugin-Decoupling.md
  - Decision: Desktop mirrors web’s dynamic plugin loading using SlotContainer + IPluginLoader

- DESKTOP_JSON_ARTIFACTS_AND_TDD_GUIDE.md
  - How JSON artifacts (manifest, interactions, topics, components, sequences) are produced/consumed
  - Pre-build steps and TDD workflow (Roslyn validation)

- SHELL002_VIOLATIONS_GUIDE.md
  - Current violations and the exact steps to fix via IPluginLoader + SlotContainer

---

## Phase Plan & Where to Work

- Issue #372 — Phase 3A: Event Routing & Conductor Execution (wire SDK services)
- Issue #375 — Phase 3B: Plugin Decoupling Architecture (IPluginLoader + SlotContainer)
- Issue #373 — Phase 4: Cleanup (blocked by 3A & 3B)

Use the checklists inside each issue. 3B contains the manifest/TDD steps you must run.

---

## Guardrails (What enforces the rules)

- Roslyn Analyzer (desktop authoritative)
  - Project: src/RenderX.Shell.Avalonia.Analyzers
  - Rules: SHELL001 (thin host), SHELL002 (no hardcoded plugin controls/imports in MainWindow)
  - How to run: dotnet build the desktop shell project (fails fast on violations)

- ESLint (web reference only)
  - Applies to packages under packages/** (web/React plugins and tools)
  - Use as reference for JSON single‑source‑of‑truth patterns, not as desktop enforcement

---

## JSON Artifacts — Source of Truth and Consumption

- plugin-manifest.json (Single source of truth for plugin discovery)
  - Desktop target structure: { ui: { slot, assembly, type }, runtime: { assembly, type, method } }
  - Loader: IPluginLoader (desktop) resolves assembly/type and instantiates controls via reflection
  - Transitional note: The file at src/RenderX.Shell.Avalonia/wwwroot/plugins/plugin-manifest.json currently uses web-style "module/export" entries for the test harness. Do NOT treat this as authoritative for native plugin loading. Replace with assembly/type once PluginLoader lands (Phase 3B).

- interaction-manifest.json (Routes interaction keys → plugin sequences)
  - Generated by scripts/generate-interaction-manifest.js (npm run pre:manifests)
  - Consumed by conductor/EventRouter at runtime

- topics-manifest.json (Declares topics and schemas)
  - Generated by scripts/generate-topics-manifest.js
  - Consumed by EventRouter/topic validation

- json-components/ and json-sequences/
  - Synced from catalog/ and/or npm packages via scripts/sync-json-*.js
  - Consumed by plugins (e.g., canvas) and by conductor for sequence execution

Principle: Never hardcode what should come from JSON manifests. Prefer plugin‑served data; keep host-side JSON as transitional build artifacts only.

---

## Desktop TDD Workflow (Follow this order)

1) Prepare artifacts (Node)
   - npm run pre:manifests
   - Verify wwwroot/* manifests exist (plugin, interaction, topics) as needed for runtime

2) Run analyzer (Desktop)
   - dotnet build src/RenderX.Shell.Avalonia/RenderX.Shell.Avalonia.csproj
   - Expect RED (SHELL002 violations) before implementing loader/slots

3) Implement Phase 3B (Native loader)
   - IPluginLoader (interface) + PluginLoader (reflection)
   - SlotContainer control in XAML tree (6 slots)
   - MainWindow: remove plugin imports/new; initialize slots from manifest

4) Verify GREEN
   - dotnet build … → 0 SHELL001/2 violations
   - Launch app: slots populate from manifest (no hardcoded controls)

---

## Document Map — Authority Levels and Caveats

Authoritative (Do follow):
- ARCHITECTURE_RULES_FOR_AGENTS.md — Canonical rules enforced by Roslyn
- docs/adr/ADR-0015-SHELL-THIN-HOST-ARCHITECTURE.md — Thin host decision
- docs/adr/ADR-0023 — Host SDK and Plugin Decoupling.md — Decoupling decision
- docs/adr/ADR-0024-Desktop-Plugin-Decoupling.md — Desktop plugin loading decision
- DESKTOP_JSON_ARTIFACTS_AND_TDD_GUIDE.md — JSON/TDD/guardrails, up to date
- SHELL002_VIOLATIONS_GUIDE.md — Exact steps to resolve current violations
- DESKTOP_VS_WEB_ARCHITECTURE_PARITY.md — Accurate parity mapping (PanelSlot ⇄ SlotContainer)

Guidance (Helpful context; confirm details against Authoritative):
- DESKTOP_DECOUPLING_ARCHITECTURE.md — Strategy overview; follow rules above when in doubt
- ARCHITECTURE_ENFORCEMENT_INDEX.md / CHECKLIST.md / SUMMARY.md — Meta-docs on enforcement
- CLARIFICATION_COMPLETE.md / ARCHITECTURE_CLARIFICATION_SUMMARY.md — Context and intent
- GITHUB_ISSUES_CLEANUP_COMPLETE.md — Issue plan clarity, not technical authority

Transitional / Caution (Do not rely on as source of truth):
- src/RenderX.Shell.Avalonia/wwwroot/plugins/plugin-manifest.json — Web-style (module/export) test harness manifest; not the native loader format. Replace with assembly/type entries during Phase 3B.
- DESKTOP_ARCHITECTURE_DIAGNOSTIC.md — UI/layout troubleshooting (not architecture rules)
- Any doc suggesting WebView2 or WebViewHost — Out of scope for native desktop; Avalonia native only
- Older SHELL_UPGRADE_* summaries — Use for history only; defer to Authoritative docs above
- src/RenderX.Shell.Avalonia.Tests/README.md — Mentions WebView; treat as transitional. Prefer Roslyn/ADRs/docs in this index.
- src/RenderX.Shell.Avalonia.Minimal.Tests/** — Legacy WebView2 tests; not authoritative for native Avalonia


Deprecated / Out of Scope for Desktop Native:
- docs/MINIMAL_WEBVIEW2_FINDINGS.md — WebView2 architecture will be removed in Phase 4

---

## Quick Links

- Phase 3A Issue: #372 — Event Routing & Conductor Execution
- Phase 3B Issue: #375 — Plugin Decoupling (IPluginLoader + SlotContainer)
- Phase 4 Issue: #373 — Cleanup (blocked)

---

## If You Find a Conflict

- Prefer: ADRs → Architecture Rules → Phase Issues (acceptance criteria)
- Update the misleading doc immediately and note the change in the Phase issue
- If behavior differs from ADRs, open a new ADR update PR

---

## Non‑Goals (Explicitly not part of this phase)

- Implementing or reviving WebViewHost/WebView2
- Hardcoding plugin controls into MainWindow
- Forking JSON artifacts in the host (keep plugin‑served data authoritative)

---

## One‑page Summary for the Next Agent

- Native Avalonia thin host; consume MusicalConductor.Avalonia + RenderX.HostSDK.Avalonia via DI
- UI plugins load dynamically from plugin‑manifest.json through IPluginLoader + SlotContainer
- Runtime handlers/sequences register via conductor/plugin manager
- JSON manifests are the single source of truth; never hardcode
- Roslyn analyzer (SHELL001/2) is the gate; follow TDD: RED → GREEN → VERIFY


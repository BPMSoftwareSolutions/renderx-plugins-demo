/*
 Convert a log-analysis JSON summary into a human-readable Markdown report.
 Usage:
   node scripts/generate-md-report.js <path-to-json>
 If no path is provided, the script will pick the latest file matching outputs/log-analysis-*.json
 Output: writes outputs/log-analysis-<stamp>.md
*/

import fs from 'fs';
import path from 'path';

function pickLatestJson(outDir) {
  if (!fs.existsSync(outDir)) return null;
  const files = fs.readdirSync(outDir).filter((f) => f.startsWith('log-analysis-') && f.endsWith('.json'));
  if (!files.length) return null;
  files.sort();
  return path.join(outDir, files[files.length - 1]);
}

function humanDuration(ms) {
  if (!ms) return '0s';
  const s = Math.floor(ms / 1000);
  if (s < 60) return `${s}s`;
  const m = Math.floor(s / 60);
  const rem = s % 60;
  return `${m}m ${rem}s`;
}

function generateMd(json) {
  const lines = [];
  lines.push(`# Log Analysis Report`);
  lines.push('');
  lines.push(`**Source file:** ${json.file}`);
  lines.push('');
  lines.push(`- **Total lines:** ${json.totalLines}`);
  lines.push(`- **Time range:** ${json.earliest ?? 'N/A'} â†’ ${json.latest ?? 'N/A'}`);
  lines.push(`- **Duration:** ${humanDuration(json.durationMs)}`);
  lines.push('');

  lines.push('## Plugins');
  lines.push('');
  lines.push(`- Mount attempts: ${json.pluginMounts.attempts}`);
  lines.push(`- Mount successes: ${json.pluginMounts.successes}`);
  lines.push('');
  const pNames = Object.keys(json.pluginMounts.byPlugin || {});
  if (pNames.length) {
    lines.push('| Plugin | Mounted | Attempts |');
    lines.push('|---|---:|---:|');
    for (const name of pNames.sort()) {
      const p = json.pluginMounts.byPlugin[name];
      lines.push(`| ${name} | ${p.successes || 0} | ${p.attempts || 0} |`);
    }
    lines.push('');
  }

  lines.push('## Sequences');
  lines.push('');
  lines.push(`- Registered sequences: ${json.sequences.registered}`);
  const seqEntries = Object.entries(json.sequences.byName || {}).sort((a, b) => b[1] - a[1]).slice(0, 20);
  if (seqEntries.length) {
    lines.push('');
    lines.push('Top sequences:');
    for (const [name, cnt] of seqEntries) lines.push(`- ${name}: ${cnt}`);
    lines.push('');
  }

  lines.push('## Topics / Subscriptions');
  lines.push('');
  lines.push(`- Total topic subscriptions: ${json.topics.subscribed}`);
  const topicEntries = Object.entries(json.topics.byTopic || {}).sort((a, b) => b[1] - a[1]).slice(0, 30);
  if (topicEntries.length) {
    lines.push('');
    lines.push('Top topics:');
    for (const [topic, cnt] of topicEntries) lines.push(`- ${topic}: ${cnt}`);
    lines.push('');
  }

  lines.push('## CSS-related events');
  lines.push('');
  lines.push(`- css:inject subscriptions: ${json.css?.injectTopics ?? 0}`);
  lines.push(`- control:panel:css:* subscriptions: ${json.css?.controlPanelEvents ?? 0}`);
  lines.push('');

  lines.push('---');
  lines.push('Generated by scripts/generate-md-report.js');
  return lines.join('\n');
}

function main() {
  const args = process.argv.slice(2);
  const outDir = path.resolve(process.cwd(), 'outputs');
  let jsonPath = args[0] ? path.resolve(process.cwd(), args[0]) : pickLatestJson(outDir);
  if (!jsonPath || !fs.existsSync(jsonPath)) {
    console.error('No JSON summary found. Provide a path to an analysis JSON or ensure outputs/log-analysis-*.json exists.');
    process.exit(1);
  }

  const raw = fs.readFileSync(jsonPath, 'utf8');
  const json = JSON.parse(raw);

  const md = generateMd(json);

  const stamp = new Date().toISOString().replace(/[:.]/g, '-');
  const outPath = path.join(outDir, `log-analysis-${stamp}.md`);
  fs.writeFileSync(outPath, md, 'utf8');
  console.log(`Markdown report written to: ${outPath}`);
}

main();

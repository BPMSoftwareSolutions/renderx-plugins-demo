const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/ConductorLogger-D8vqlgz1.js","assets/global-CMa2Rm43.js","assets/EventRouter-DUQzZvsb.js","assets/global-DVG2pnu0.css"])))=>i.map(i=>d[i]);
import{_ as O}from"./global-CMa2Rm43.js";const T={PIANISSIMO:"pp",PIANO:"p",MEZZO_PIANO:"mp",MEZZO_FORTE:"mf",FORTE:"f",FORTISSIMO:"ff"},y={IMMEDIATE:"immediate",AFTER_BEAT:"after-beat",DELAYED:"delayed",SYNCHRONIZED:"synchronized",ON_BEAT:"on-beat"},d={CONDUCTOR_INITIALIZED:"conductor-initialized",CONDUCTOR_DESTROYED:"conductor-destroyed",CONDUCTOR_RESET:"conductor-reset",SEQUENCE_DEFINED:"sequence-defined",SEQUENCE_UNDEFINED:"sequence-undefined",SEQUENCE_REGISTERED:"sequence-registered",SEQUENCE_UNREGISTERED:"sequence-unregistered",SEQUENCE_STARTED:"sequence-started",SEQUENCE_COMPLETED:"sequence-completed",SEQUENCE_FAILED:"sequence-failed",SEQUENCE_CANCELLED:"sequence-cancelled",SEQUENCE_PAUSED:"sequence-paused",SEQUENCE_RESUMED:"sequence-resumed",BEAT_STARTED:"beat-started",BEAT_COMPLETED:"beat-completed",BEAT_FAILED:"beat-failed",MOVEMENT_STARTED:"movement-started",MOVEMENT_COMPLETED:"movement-completed",MOVEMENT_FAILED:"movement-failed",SEQUENCE_QUEUED:"sequence-queued",SEQUENCE_DEQUEUED:"sequence-dequeued",QUEUE_PROCESSED:"queue-processed",STATISTICS_UPDATED:"statistics-updated"},f={HIGH:"HIGH",NORMAL:"NORMAL",CHAINED:"CHAINED"};class B{constructor(){this.events={},this.debugMode=!0,this.subscriptionCounter=0,this.eventCounts={}}subscribe(e,t,n){if(this.events[e]||(this.events[e]=[]),n?.pluginId&&this.events[e].find(r=>r.pluginId===n.pluginId)){const r=` from plugin ${n.pluginId}`;return console.warn(`ðŸš« EventBus: Duplicate subscription blocked for "${e}"${r}`),()=>{this.unsubscribe(e,t)}}const s={id:`sub_${this.subscriptionCounter++}`,eventName:e,callback:t,subscribedAt:new Date,pluginId:n?.pluginId,context:n};if(this.events[e].push(s),this.debugMode){const i=n?.pluginId?` (plugin: ${n.pluginId})`:"";console.log(`ðŸ“¡ EventBus: Subscribed to "${e}" (${this.events[e].length} total subscribers)${i}`)}return()=>{this.unsubscribe(e,t)}}unsubscribe(e,t){if(!this.events[e])return;const n=this.events[e].findIndex(s=>s.callback===t);if(n>-1){const s=this.events[e][n];if(this.events[e].splice(n,1),this.debugMode){const i=s.pluginId?` (plugin: ${s.pluginId})`:"";console.log(`ðŸ“¡ EventBus: Unsubscribed from "${e}" (${this.events[e].length} remaining subscribers)${i}`)}this.events[e].length===0&&delete this.events[e]}}emit(e,t){return this.eventCounts[e]=(this.eventCounts[e]||0)+1,this.events[e]&&[...this.events[e]].forEach((s,i)=>{try{const r=s.callback(t);r&&typeof r.catch=="function"&&r.catch(o=>{const c=s.pluginId?` (plugin: ${s.pluginId})`:"";console.error(`ðŸ“¡ EventBus: Async error in subscriber ${i} for "${e}"${c}:`,o)})}catch(r){const o=s.pluginId?` (plugin: ${s.pluginId})`:"";console.error(`ðŸ“¡ EventBus: Error in subscriber ${i} for "${e}"${o}:`,r)}}),Promise.resolve()}async emitAsync(e,t){if(this.eventCounts[e]=(this.eventCounts[e]||0)+1,!this.events[e])return;const s=[...this.events[e]].map((i,r)=>{try{const o=i.callback(t);return Promise.resolve(o)}catch(o){const c=i.pluginId?` (plugin: ${i.pluginId})`:"";return console.error(`ðŸ“¡ EventBus: Error in subscriber ${r} for "${e}"${c}:`,o),Promise.resolve()}});await Promise.allSettled(s)}clearEvent(e){this.events[e]&&(delete this.events[e],this.debugMode&&console.log(`ðŸ“¡ EventBus: Cleared all subscribers for "${e}"`))}clearAll(){this.events={},this.eventCounts={},this.debugMode&&console.log("ðŸ“¡ EventBus: Cleared all subscribers")}getDebugInfo(){const e={};let t=0;return Object.keys(this.events).forEach(s=>{e[s]=this.events[s].length,t+=this.events[s].length}),{totalEvents:Object.values(this.eventCounts).reduce((s,i)=>s+i,0),totalSubscriptions:t,eventCounts:{...this.eventCounts},subscriptionCounts:e}}hasSubscribers(e){return!!(this.events[e]&&this.events[e].length>0)}getSubscriberCount(e){return this.events[e]?.length||0}setDebugMode(e){this.debugMode=e,console.log(`ðŸ“¡ EventBus: Debug mode ${e?"enabled":"disabled"}`)}}class G extends B{constructor(e=null){super(),this.externalConductor=null,this.sequences=new Map,this.priorities=new Map,this.dependencies=new Map,this.currentSequences=new Map,this.completedEvents=new Set,this.metrics={eventsProcessed:0,sequencesExecuted:0,averageLatency:0,raceConditionsDetected:0},this.tempo=120,e?(console.log("ðŸŽ¼ EventBus: Using external conductor for unified sequence system"),this.externalConductor=e,this.sequences=e.sequences||new Map):(console.log("ðŸŽ¼ EventBus: Using internal conductor (legacy mode)"),this.sequences=new Map)}emit(e,t,n={}){const s=performance.now();if(n.sequence)return this.emitInSequence(e,t,n),Promise.resolve();const i=this.priorities.get(e)||"mp",r=this.dependencies.get(e)||[];return r.length>0&&!this.dependenciesMet(r,n.context)?(this.queueForDependencies(e,t,n,r),Promise.resolve()):(this.executeWithTiming(e,t,n,i),this.updateMetrics(e,s),Promise.resolve())}executeWithTiming(e,t,n,s){switch(n.timing||"immediate"){case"immediate":this.executeEvent(e,t,s);break;case"after-beat":setTimeout(()=>this.executeEvent(e,t,s),0);break;case"next-measure":setTimeout(()=>this.executeEvent(e,t,s),0);break;case"delayed":const r=this.calculateDelay(n.beats||1);setTimeout(()=>this.executeEvent(e,t,s),r);break;case"wait-for-signal":this.queueForSignal(e,t,n.signal,s);break;default:this.executeEvent(e,t,s)}}executeEvent(e,t,n){super.emit(e,t),this.completedEvents.add(e)}emitInSequence(e,t,n){if(this.externalConductor&&this.externalConductor.startSequence)return console.log(`ðŸŽ¼ EventBus: Delegating to external conductor for sequence event "${e}"`),this.externalConductor.startSequence(n.sequence,t,n.context);super.emit(e,t)}dependenciesMet(e,t){return e.every(n=>this.completedEvents.has(n))}queueForDependencies(e,t,n,s){console.log(`ðŸŽ¼ EventBus: Queueing ${e} for dependencies:`,s),setTimeout(()=>{this.dependenciesMet(s,n.context)&&this.emit(e,t,{...n,timing:"immediate"})},50)}queueForSignal(e,t,n,s){console.log(`ðŸŽ¼ EventBus: Queueing ${e} for signal: ${n}`);const i=()=>{this.completedEvents.has(n)?this.executeEvent(e,t,s):setTimeout(i,10)};i()}calculateDelay(e){const t=60/this.tempo*1e3;return e*t}updateMetrics(e,t){const n=performance.now()-t;this.metrics.eventsProcessed++;const s=.1;this.metrics.averageLatency=this.metrics.averageLatency*(1-s)+n*s}connectToMainConductor(e){console.log("ðŸŽ¼ EventBus: Connecting to main conductor for unified sequence system"),this.externalConductor=e,e.sequences?(this.sequences=e.sequences,console.log(`ðŸŽ¼ EventBus: Connected to main conductor with ${this.sequences.size} sequences`)):console.warn("ðŸš¨ EventBus: Main conductor does not have sequences property")}getBasicMetrics(){return{...this.metrics}}resetMetrics(){this.metrics={eventsProcessed:0,sequencesExecuted:0,averageLatency:0,raceConditionsDetected:0}}setTempo(e){this.tempo=e}getTempo(){return this.tempo}getBeatDuration(){return 60/this.tempo*1e3}registerSequence(e,t){this.sequences.set(e,t)}getSequenceNames(){return Array.from(this.sequences.keys())}async play(e,t){if(this.metrics.sequencesExecuted++,this.externalConductor&&this.externalConductor.startSequence)try{return await this.externalConductor.startSequence(e,t)}catch(n){console.error(`ðŸŽ¼ EventBus: Error playing sequence ${e}:`,n)}else this.emit("sequence-start",{sequenceName:e,data:t})}getMetrics(){const e=this.getDebugInfo(),t=this.externalConductor?.getStatistics?.()||{};return{sequenceCount:this.sequences.size,sequenceExecutions:this.metrics.sequencesExecuted,eventBusStats:e,conductorStats:t,...this.metrics}}}const H=new G;class M{constructor(e={}){this.violations=[],this.originalEventBusEmit=null,this.originalEventBusSubscribe=null,this.registeredPlugins=new Set,this.config={strictMode:!0,allowedPlugins:[],logViolations:!0,throwOnViolation:!1,enableRuntimeChecks:!0,enforceConductorLogger:"warn",...e},this.config.strictMode&&this.config.enforceConductorLogger!=="off"&&(this.config.enforceConductorLogger="error"),this.config.enableRuntimeChecks&&this.initializeRuntimeChecks()}initializeRuntimeChecks(){this.originalEventBusEmit=B.prototype.emit,B.prototype.emit=this.createValidatedEmit(),this.originalEventBusSubscribe=B.prototype.subscribe,B.prototype.subscribe=this.createValidatedSubscribe(),this.interceptGlobalAccess(),console.log("ðŸŽ¼ SPA Validator: Runtime checks initialized")}createValidatedEmit(){return function(e,t,n={}){const s=M.getInstance();if(typeof e=="string"&&(e.startsWith("musical-conductor:")||e.startsWith("conductor:")))return s.originalEventBusEmit.call(this,e,t,n);if(e==="stage:cue"&&t&&t.meta&&t.meta.__stageCrewInternal)return s.originalEventBusEmit.call(this,e,t,n);const i=new Error().stack||"",r=s.analyzeCallStack(i);if(s.isPluginCall(r)){const o=s.extractLocationFromStack(i),c=s.createViolation("RUNTIME_DIRECT_EVENTBUS_EMIT",r.pluginId,`Plugin '${r.pluginId}' directly called eventBus.emit('${e}')`,i,"critical",{fileUrl:o.fileUrl,lineNumber:o.lineNumber,columnNumber:o.columnNumber,codeSnippet:o.stackLine});if(s.handleViolation(c),s.config.strictMode){console.error(`ðŸš« SPA Validator: Blocked direct eventBus.emit() call from plugin '${r.pluginId}'`),console.error(`ðŸ’¡ Use conductor.play('${r.pluginId}', 'SEQUENCE_NAME', data) instead`);return}}return s.originalEventBusEmit.call(this,e,t,n)}}createValidatedSubscribe(){return function(e,t,n){const s=M.getInstance(),i=new Error().stack||"",r=s.analyzeCallStack(i);if(r.isMusicalConductor)return s.originalEventBusSubscribe.call(this,e,t,n);if(r.isReactComponent){const o=s.extractLocationFromStack(i),c=s.createViolation("RUNTIME_REACT_COMPONENT_EVENTBUS_SUBSCRIBE","react-component",`React component directly called eventBus.subscribe('${e}') - should use conductor.subscribe()`,i,"critical",{fileUrl:o.fileUrl,lineNumber:o.lineNumber,columnNumber:o.columnNumber,codeSnippet:o.stackLine});if(s.handleViolation(c),s.config.strictMode)throw new Error(`React component violation: Use conductor.subscribe('${e}', callback) instead of eventBus.subscribe()`)}if(r.isPlugin&&!r.isInMountMethod){const o=s.extractLocationFromStack(i),c=s.createViolation("RUNTIME_PLUGIN_EVENTBUS_SUBSCRIBE_OUTSIDE_MOUNT",r.pluginId,`Plugin '${r.pluginId}' called eventBus.subscribe() outside mount method`,i,"error",{fileUrl:o.fileUrl,lineNumber:o.lineNumber,columnNumber:o.columnNumber,codeSnippet:o.stackLine});s.handleViolation(c)}return s.originalEventBusSubscribe.call(this,e,t,n)}}interceptGlobalAccess(){if(typeof window>"u")return;let e=null;Object.defineProperty(window,"renderxCommunicationSystem",{get:()=>{const t=new Error().stack||"",n=this.analyzeCallStack(t);return this.isViolatingGlobalAccess(n,t)&&this.handleGlobalAccessViolation(n,t),e},set:t=>{e=t},configurable:!0})}isViolatingGlobalAccess(e,t){return e.source==="MusicalConductor"||t.includes("AppContent")?!1:!!t.includes(".eventBus")}handleGlobalAccessViolation(e,t){const n=this.extractLocationFromStack(t),s=this.createViolation("RUNTIME_GLOBAL_EVENTBUS_ACCESS",e.pluginId||e.source,"Global eventBus access detected - should use conductor methods instead",t,"critical",{fileUrl:n.fileUrl,lineNumber:n.lineNumber,columnNumber:n.columnNumber,codeSnippet:n.stackLine});this.handleViolation(s)}analyzeCallStack(e){const t=e.split(`
`);let n=!1,s=!1,i="unknown";for(const r of t){const o=String(r).replace(/\\\\/g,"/");if(o.includes("/node_modules/musical-conductor/")||o.includes("/musical-conductor/dist/")||o.includes("/musical-conductor/")||o.includes("/dist/modules/communication/")||o.includes("/modules/communication/"))return{isPlugin:!1,pluginId:"MusicalConductor",fileName:r,isReactComponent:!1,isInMountMethod:!1,source:"MusicalConductor",isMusicalConductor:!0};if(o.includes("MusicalConductor")||o.includes("/sequences/MusicalConductor.ts")||o.includes("/sequences/core/")||o.includes("/sequences/plugins/PluginManager")||o.includes("/sequences/plugins/PluginInterfaceFacade")||o.includes("/sequences/plugins/PluginLoader")||o.includes("/sequences/plugins/PluginValidator")||o.includes("/sequences/plugins/PluginManifestLoader")||o.includes("SequenceRegistry")||o.includes("EventSubscriptionManager")||o.includes("ConductorCore")||o.includes("EventOrchestrator")||o.includes("SequenceOrchestrator")||o.includes("/communication/EventBus")||o.includes("/communication/SPAValidator")||o.includes("PluginManager.js")||o.includes("PluginInterfaceFacade.js")||o.includes("PluginLoader.js")||o.includes("PluginValidator.js")||o.includes("PluginManifestLoader.js")||o.includes("SequenceRegistry.js")||o.includes("EventSubscriptionManager.js")||o.includes("ConductorCore.js")||o.includes("EventOrchestrator.js")||o.includes("SequenceOrchestrator.js")||o.includes("EventBus.js")||o.includes("SPAValidator.js"))return i="MusicalConductor",{isPlugin:!1,pluginId:"MusicalConductor",fileName:r,isReactComponent:!1,isInMountMethod:!1,source:i,isMusicalConductor:!0};const c=o.match(/\/components\/([^\/]+\.tsx?)/);c&&(n=!0,i=`React:${c[1]}`),(r.includes(".mount(")||r.includes("mount:"))&&(s=!0);const a=r.match(/\/plugins\/([^\/]+)/);if(a)return{isPlugin:!0,pluginId:a[1],fileName:r,isReactComponent:n,isInMountMethod:s,source:`Plugin:${a[1]}`,isMusicalConductor:!1};const u=r.match(/([^\/]+\.symphony)/);if(u)return{isPlugin:!0,pluginId:u[1],fileName:r,isReactComponent:n,isInMountMethod:s,source:`Plugin:${u[1]}`,isMusicalConductor:!1};r.includes("MusicalConductor")&&(i="MusicalConductor")}return{isPlugin:!1,pluginId:"unknown",fileName:"unknown",isReactComponent:n,isInMountMethod:s,source:i,isMusicalConductor:!1}}extractLocationFromStack(e){if(!e)return{};const t=e.split(`
`);for(const n of t){const s=String(n).trim();if(!s||s.includes("SPAValidator")||s.includes("EventBus"))continue;const i=s.match(/(https?:\/\/[^\s\)]+|file:\/\/[^\s\)]+|\/[\w\-\.\/]+):(\d+):(\d+)/);if(i){const o=i[1],c=Number(i[2]),a=Number(i[3]);return{fileUrl:o,lineNumber:c,columnNumber:a,stackLine:s}}const r=s.match(/\(([^\s\)]+):(\d+):(\d+)\)/);if(r){const o=r[1],c=Number(r[2]),a=Number(r[3]);return{fileUrl:o,lineNumber:c,columnNumber:a,stackLine:s}}}return{stackLine:t[1]||t[0]}}isPluginCall(e){return!(!e.isPlugin||e.isMusicalConductor||this.config.allowedPlugins.includes(e.pluginId))}createViolation(e,t,n,s,i,r={}){return{type:e,pluginId:t,description:n,stackTrace:s,timestamp:new Date,severity:i,...r}}handleViolation(e){if(this.violations.push(e),this.config.logViolations){if(console.error(`ðŸŽ¼ SPA Violation [${e.severity.toUpperCase()}]: ${e.description}`),console.error(`   Plugin: ${e.pluginId}`),console.error(`   Time: ${e.timestamp.toISOString()}`),e.fileUrl&&typeof e.lineNumber=="number"){const t=typeof e.columnNumber=="number"?`:${e.columnNumber}`:"";console.error(`   Location: ${e.fileUrl}:${e.lineNumber}${t}`)}e.codeSnippet&&console.error(`   Code: ${e.codeSnippet.trim()}`),e.severity==="critical"&&console.error(`   Stack: ${e.stackTrace.split(`
`).slice(0,3).join(`
`)}`)}if(this.config.throwOnViolation&&e.severity==="critical")throw new Error(`SPA Violation: ${e.description}`)}registerPlugin(e){this.registeredPlugins.add(e)}detectDirectConsoleUsage(e){try{const t=Function.prototype.toString.call(e);return/(\b|\.)console\.(log|info|warn|error|debug)\b/.test(t)}catch{return!1}}validatePluginMount(e,t){const n=[],s=t.split(/\r?\n/),i=/(^|[^\.\w])eventBus\.emit\s*\(/;for(let c=0;c<s.length;c++){const a=s[c],u=String(a).trim();/^\s*\/\//.test(u)||/^\s*$/.test(u)||i.test(a)&&n.push(`eventBus.emit() at line ${c+1}: ${u}`)}const r=/window\..*eventBus\.emit\s*\(/;for(let c=0;c<s.length;c++){const a=s[c],u=String(a).trim();/^\s*\/\//.test(u)||/^\s*$/.test(u)||r.test(a)&&n.push(`global eventBus access at line ${c+1}: ${u}`)}return n.some(c=>c.includes("eventBus"))&&!/conductor\.play\s*\(/.test(t)&&n.push("Uses eventBus.emit() but no conductor.play() - migrate to SPA"),{valid:n.length===0,violations:n}}getViolations(){return[...this.violations]}getViolationsByPlugin(e){return this.violations.filter(t=>t.pluginId===e)}clearViolations(){this.violations=[]}generateComplianceReport(){const e={},t={},n=[];for(const s of this.violations)e[s.pluginId]=(e[s.pluginId]||0)+1,t[s.severity]=(t[s.severity]||0)+1;for(const[s,i]of Object.entries(e))n.push(`Plugin '${s}' has ${i} violation(s) - migrate to conductor.play() pattern`);return{totalViolations:this.violations.length,violationsByPlugin:e,violationsBySeverity:t,recommendations:n}}static getInstance(){return M.instance||(M.instance=new M),M.instance}static initialize(e={}){return M.instance=new M(e),M.instance}disableRuntimeChecks(){this.originalEventBusEmit&&(B.prototype.emit=this.originalEventBusEmit,console.log("ðŸŽ¼ SPA Validator: Runtime checks disabled"))}}var oe={};let ce=null;function J(){try{const l=typeof globalThis<"u"?globalThis:void 0,e=typeof window<"u"?window:void 0;return l&&l.__CONDUCTOR_ENV__||e&&e.__CONDUCTOR_ENV__||{}}catch{return{}}}function K(){try{const l=J();if(l&&(l.dev===!0||l.mode==="development"))return!0}catch{}try{const l=(0,eval)("import.meta");if(l&&l.env&&(l.env.DEV===!0||l.env.MODE==="development"))return!0}catch{}try{const l=typeof process<"u"&&oe||{};if(l.MC_DEV==="1"||l.MC_DEV==="true"||l.NODE_ENV==="development"||l.npm_lifecycle_event==="dev")return!0}catch{}try{const l=typeof globalThis<"u"?globalThis:void 0;if(l&&(l.MC_DEV===!0||l.MC_DEV==="1"))return!0}catch{}try{const l=typeof window<"u"?window:void 0;if(l&&l.MC_DEV)return!0}catch{}return!1}class ${constructor(e){this.eventSubscriptions=[],this.beatLoggingInitialized=!1,this.eventBus=e,this.spaValidator=M.getInstance(),this.initialize()}static getInstance(e){if(!$.instance){if(!e)throw new Error("EventBus is required for first initialization");$.instance=new $(e)}return $.instance}static resetInstance(){$.instance&&($.instance.cleanup(),$.instance=null)}getEventBus(){return this.eventBus}getSPAValidator(){return this.spaValidator}async initialize(){this.setupBeatExecutionLogging();try{if(K()){const{ConductorLogger:t}=await O(async()=>{const{ConductorLogger:s}=await import("./ConductorLogger-D8vqlgz1.js");return{ConductorLogger:s}},__vite__mapDeps([0,1,2,3]));new t(this.eventBus,!0).init()}}catch(e){console.warn("âš ï¸ ConductorLogger initialization skipped:",e?.message||e)}console.log("ðŸŽ¼ ConductorCore: Initialized successfully")}setupBeatExecutionLogging(){if(this.beatLoggingInitialized){console.log("ðŸŽ¼ Beat execution logging already initialized, skipping...");return}console.log("ðŸŽ¼ ConductorCore: Setting up beat execution logging...");const e=this.eventBus.subscribe("musical-conductor:beat:started",s=>{this.shouldEnableHierarchicalLogging()&&this.logBeatStartedHierarchical(s)}),t=this.eventBus.subscribe("musical-conductor:beat:completed",s=>{this.shouldEnableHierarchicalLogging()&&this.logBeatCompletedHierarchical(s)}),n=this.eventBus.subscribe("musical-conductor:beat:error",s=>{this.shouldEnableHierarchicalLogging()||console.error("ðŸŽ¼ Beat execution error:",s)});this.eventSubscriptions.push(e,t,n),this.beatLoggingInitialized=!0,console.log("âœ… Beat execution logging initialized")}logBeatStartedHierarchical(e){const{sequenceName:t,movementName:n,beatNumber:s,eventType:i,timing:r}=e;console.log(`ðŸŽ¼ â”Œâ”€ Beat ${s} Started`),console.log(`ðŸŽ¼ â”‚  Sequence: ${t}`),console.log(`ðŸŽ¼ â”‚  Movement: ${n}`),console.log(`ðŸŽ¼ â”‚  Event: ${i}`),console.log(`ðŸŽ¼ â”‚  Timing: ${r}`),e.payload&&console.log("ðŸŽ½ â”‚  Data Baton:",e.payload)}logBeatCompletedHierarchical(e){const{sequenceName:t,movementName:n,beatNumber:s,duration:i}=e;console.log(`ðŸŽ¼ â””â”€ Beat ${s} Completed`),console.log(`ðŸŽ¼    Duration: ${i}ms`),console.log(`ðŸŽ¼    Sequence: ${t}`),console.log(`ðŸŽ¼    Movement: ${n}`)}shouldEnableHierarchicalLogging(){return!0}cleanup(){console.log("ðŸŽ¼ ConductorCore: Cleaning up..."),this.eventSubscriptions.forEach(e=>{try{e()}catch(t){console.warn("ðŸŽ¼ Error during event unsubscription:",t)}}),this.eventSubscriptions=[],this.beatLoggingInitialized=!1,console.log("âœ… ConductorCore: Cleanup completed")}isInitialized(){return this.beatLoggingInitialized&&!!this.eventBus&&!!this.spaValidator}}$.instance=null;class ae{constructor(e){this.sequences=new Map,this.eventSubscriptionManager=null,this.eventBus=e}setEventSubscriptionManager(e){this.eventSubscriptionManager=e}register(e){if(!e)throw new Error("Sequence cannot be null or undefined");if(!e.id)throw new Error("Sequence must have an id");if(!e.name)throw new Error("Sequence must have a name");this.validateSequence(e),this.sequences.set(e.id,e),console.log(`ðŸŽ¼ SequenceRegistry: Registered sequence "${e.name}" (id: ${e.id})`),this.eventSubscriptionManager?this.eventSubscriptionManager.emit(d.SEQUENCE_REGISTERED,{sequenceId:e.id,sequenceName:e.name,category:e.category},"SequenceRegistry"):(console.warn("ðŸŽ¼ SequenceRegistry: EventSubscriptionManager not set, using direct eventBus.emit()"),this.eventBus.emit(d.SEQUENCE_REGISTERED,{sequenceId:e.id,sequenceName:e.name,category:e.category}))}unregister(e){if(!e)throw new Error("Sequence ID is required");const t=this.sequences.get(e);t?(this.sequences.delete(e),console.log(`ðŸŽ¼ SequenceRegistry: Unregistered sequence "${t.name}" (id: ${e})`),this.eventSubscriptionManager?this.eventSubscriptionManager.emit(d.SEQUENCE_UNREGISTERED,{sequenceId:e,sequenceName:t.name},"SequenceRegistry"):(console.warn("ðŸŽ¼ SequenceRegistry: EventSubscriptionManager not set, using direct eventBus.emit()"),this.eventBus.emit(d.SEQUENCE_UNREGISTERED,{sequenceId:e,sequenceName:t.name}))):console.warn(`ðŸŽ¼ SequenceRegistry: Sequence with ID "${e}" not found for unregistration`)}getSequenceMap(){return this.sequences}get(e){if(e)return this.sequences.get(e)}getAll(){return Array.from(this.sequences.values())}getIds(){return Array.from(this.sequences.keys())}getNames(){return Array.from(this.sequences.values()).map(e=>e.name)}has(e){return e?this.sequences.has(e):!1}size(){return this.sequences.size}clear(){const e=this.getAll();this.sequences.clear(),console.log(`ðŸŽ¼ SequenceRegistry: Cleared ${e.length} sequences`),e.forEach(t=>{this.eventSubscriptionManager?this.eventSubscriptionManager.emit(d.SEQUENCE_UNREGISTERED,{sequenceId:t.id,sequenceName:t.name},"SequenceRegistry"):(console.warn("ðŸŽ¼ SequenceRegistry: EventSubscriptionManager not set, using direct eventBus.emit()"),this.eventBus.emit(d.SEQUENCE_UNREGISTERED,{sequenceId:t.id,sequenceName:t.name}))})}getByCategory(e){return e?this.getAll().filter(t=>t.category===e):[]}findByName(e){if(e)return this.getAll().find(t=>t.name===e)}validateSequence(e){if(!e.movements||!Array.isArray(e.movements))throw new Error(`Sequence "${e.name}" (id: ${e.id}) must have a movements array`);if(e.movements.length===0)throw new Error(`Sequence "${e.name}" (id: ${e.id}) must have at least one movement`);e.movements.forEach((t,n)=>{if(!t.id)throw new Error(`Movement ${n} in sequence "${e.name}" (id: ${e.id}) must have an id`);if(!t.name)throw new Error(`Movement ${n} in sequence "${e.name}" (id: ${e.id}) must have a name`);if(!t.beats||!Array.isArray(t.beats))throw new Error(`Movement "${t.name}" in sequence "${e.name}" must have a beats array`);if(t.beats.length===0)throw new Error(`Movement "${t.name}" in sequence "${e.name}" must have at least one beat`);t.beats.forEach((s,i)=>{if(typeof s.beat!="number"||s.beat<1)throw new Error(`Beat ${i} in movement "${t.name}" must have a valid beat number (>= 1)`);if(!s.event||typeof s.event!="string")throw new Error(`Beat ${i} in movement "${t.name}" must have a valid event name`);if(!s.dynamics)throw new Error(`Beat ${i} in movement "${t.name}" must have dynamics specified`)})}),console.log(`âœ… SequenceRegistry: Sequence "${e.name}" validation passed`)}getStatistics(){const e=this.getAll(),t={};let n=0,s=0;return e.forEach(i=>{const r=i.category||"uncategorized";t[r]=(t[r]||0)+1,n+=i.movements.length,i.movements.forEach(o=>{s+=o.beats.length})}),{totalSequences:e.length,sequencesByCategory:t,totalMovements:n,totalBeats:s}}}class ue{constructor(e,t){this.eventBus=e,this.spaValidator=t}subscribe(e,t,n){const s=new Error().stack||"",i=this.spaValidator.analyzeCallStack(s);if(!this.isAuthorizedSubscriber(i)){const r=this.spaValidator.createViolation("UNAUTHORIZED_CONDUCTOR_SUBSCRIBE",i.pluginId||"unknown",`Unauthorized conductor.subscribe() call from ${i.source}`,s,"error");if(this.spaValidator.handleViolation(r),this.spaValidator.config.strictMode)throw new Error(`Unauthorized conductor.subscribe() call from ${i.source}`)}return this.eventBus.subscribe(e,t,{...n,conductorManaged:!0,subscribedVia:"conductor"})}unsubscribe(e,t){const n=new Error().stack||"",s=this.spaValidator.analyzeCallStack(n);if(!this.isAuthorizedSubscriber(s)){const i=this.spaValidator.createViolation("UNAUTHORIZED_CONDUCTOR_UNSUBSCRIBE",s.pluginId||"unknown",`Unauthorized conductor.unsubscribe() call from ${s.source}`,n,"error");if(this.spaValidator.handleViolation(i),this.spaValidator.config.strictMode)throw new Error(`Unauthorized conductor.unsubscribe() call from ${s.source}`)}this.eventBus.unsubscribe(e,t)}isAuthorizedSubscriber(e){return!!(e.isReactComponent||e.isPlugin&&e.isInMountMethod||e.source==="MusicalConductor"||e.source?.includes("ConductorCore")||e.source?.includes("SequenceExecutor")||e.source?.includes("PluginManager"))}createManagedSubscription(e,t,n,s){console.log(`ðŸŽ¼ EventSubscriptionManager: Creating managed subscription for ${n} -> ${e}`);const i=r=>{try{t(r)}catch(o){console.error(`ðŸŽ¼ EventSubscriptionManager: Error in subscription callback for ${e}:`,o),console.error(`ðŸŽ¼ Subscriber: ${n}`)}};return this.eventBus.subscribe(e,i,{...s,subscriberId:n,managedByEventSubscriptionManager:!0})}emit(e,t,n){n&&console.log(`ðŸŽ¼ EventSubscriptionManager: ${n} emitting ${e}`),this.eventBus.emit(e,t)}getSubscriptionStatistics(){const e=this.eventBus.getDebugInfo();return{totalSubscriptions:e.totalSubscriptions,subscriptionCounts:e.subscriptionCounts}}validateSubscription(e,t){return t.isDirectEventBusAccess?{isValid:!1,reason:"Direct EventBus access detected",recommendation:"Use conductor.subscribe() instead of eventBus.subscribe()"}:t.isPlugin&&!t.isInMountMethod?{isValid:!1,reason:"Plugin subscribing outside of mount method",recommendation:"Move event subscriptions to the plugin's mount method"}:t.isReactComponent&&t.isDirectEventBusAccess?{isValid:!1,reason:"React component using direct EventBus access",recommendation:"Use conductor.subscribe() in React components"}:{isValid:!0}}}class le{constructor(){this.queue=[],this.priorities=new Map,this.completedCount=0,this.currentlyExecuting=null}enqueue(e){if(!e)throw new Error("Request cannot be null or undefined");e.priority&&this.priorities.set(e.requestId,e.priority),this.insertByPriority(e),console.log(`ðŸŽ¼ ExecutionQueue: Enqueued "${e.sequenceName}" with priority ${e.priority||"NORMAL"} (Queue size: ${this.queue.length})`)}dequeue(){if(this.queue.length===0)return null;const e=this.queue.shift();return console.log(`ðŸŽ¼ ExecutionQueue: Dequeued "${e.sequenceName}"`),e}peek(){return this.queue.length>0?this.queue[0]:null}clear(){const e=this.queue.length;return this.queue=[],this.priorities.clear(),console.log(`ðŸŽ¼ ExecutionQueue: Cleared ${e} requests from queue`),e}getStatus(){return{pending:this.queue.length,executing:this.currentlyExecuting?1:0,completed:this.completedCount,length:this.queue.length,activeSequence:this.currentlyExecuting?.sequenceName||null}}isEmpty(){return this.queue.length===0}size(){return this.queue.length}setCurrentlyExecuting(e){this.currentlyExecuting=e,console.log(e?`ðŸŽ¼ ExecutionQueue: Now executing "${e.sequenceName}"`:"ðŸŽ¼ ExecutionQueue: No sequence currently executing")}markCompleted(e){this.completedCount++,this.currentlyExecuting?.requestId===e.requestId&&(this.currentlyExecuting=null),console.log(`ðŸŽ¼ ExecutionQueue: Marked "${e.sequenceName}" as completed (Total completed: ${this.completedCount})`)}getQueuedRequests(){return[...this.queue]}getCurrentlyExecuting(){return this.currentlyExecuting}setPriority(e,t){this.priorities.set(e,t),console.log(`ðŸŽ¼ ExecutionQueue: Set priority for "${e}" to ${t}`)}getPriority(e){return this.priorities.get(e)||f.NORMAL}insertByPriority(e){const t=e.priority||f.NORMAL;if(t===f.HIGH){this.queue.unshift(e);return}if(t===f.CHAINED){let n=0;for(;n<this.queue.length&&this.queue[n].priority===f.HIGH;)n++;this.queue.splice(n,0,e);return}this.queue.push(e)}getStatistics(){const e={};return this.queue.forEach(t=>{const n=t.priority||f.NORMAL;e[n]=(e[n]||0)+1}),{totalEnqueued:this.completedCount+this.queue.length+(this.currentlyExecuting?1:0),totalCompleted:this.completedCount,currentQueueLength:this.queue.length,priorityDistribution:e}}findBySequenceName(e){return this.queue.filter(t=>t.sequenceName===e)}removeBySequenceName(e){const t=this.queue.length;this.queue=this.queue.filter(s=>s.sequenceName!==e);const n=t-this.queue.length;return n>0&&console.log(`ðŸŽ¼ ExecutionQueue: Removed ${n} requests for sequence "${e}"`),n}}class b{static computeIndent(e){try{const n=b.eventBus?.__conductorLogger;if(!n)return"";const s=n.getDepth?.(e)??0;return"  ".repeat(Math.max(0,s))}catch{return""}}static snapshot(e){if(!e||typeof e!="object")return{};const t={};for(const n of Object.keys(e))t[n]=e[n];return t}static diff(e,t){const n=[],s=[],i=[],r=new Set(Object.keys(e||{})),o=new Set(Object.keys(t||{}));for(const c of o)r.has(c)?b.shallowEqual(e[c],t[c])||i.push(c):n.push(c);for(const c of r)o.has(c)||s.push(c);return{added:n,removed:s,updated:i}}static log(e,t,n){const s=b.diff(t,n),i=s.added.length||s.removed.length||s.updated.length,r="ðŸŽ½ DataBaton";if(!i){const S=b.computeIndent(e.requestId);console.log(`${S}${r}: No changes | seq=${e.sequenceName||"?"} beat=${e.beatNumber??"?"} event=${e.beatEvent||"?"} handler=${e.handlerName||"?"}`);return}const o=[];s.added.length&&o.push(`+${s.added.join(",")}`),s.updated.length&&o.push(`~${s.updated.join(",")}`),s.removed.length&&o.push(`-${s.removed.join(",")}`);const c=[...s.added,...s.updated].slice(0,3),a={};for(const S of c)a[S]=n[S];let u="";try{u=JSON.stringify(a).slice(0,200)}catch{}const h=b.computeIndent(e.requestId);console.log(`${h}${r}: ${o.join(" ")} | seq=${e.sequenceName||"?"} beat=${e.beatNumber??"?"} event=${e.beatEvent||"?"} handler=${e.handlerName||"?"} plugin=${e.pluginId||"?"} req=${e.requestId||"?"} preview=${u}`)}static shallowEqual(e,t){if(e===t)return!0;if(!e||!t||typeof e!="object"||typeof t!="object")return e===t;const n=Object.keys(e),s=Object.keys(t);if(n.length!==s.length)return!1;for(const i of n)if(e[i]!==t[i])return!1;return!0}}b.eventBus=null;class he{constructor(e,t,n){this.isExecutingBeat=!1,this.beatExecutionQueue=[],this.eventBus=e,this.spaValidator=t}async executeBeat(e,t,n,s){if(this.isExecutingBeat)return new Promise((i,r)=>{this.beatExecutionQueue.push({beat:e,context:t,resolve:i,reject:r})});this.isExecutingBeat=!0;try{const i=Date.now();this.eventBus.emit(d.BEAT_STARTED,{sequenceName:n.name,movementName:s.name,beat:e.beat,event:e.event,title:e.title,dynamics:e.dynamics,timing:e.timing,requestId:t.id,payload:t.data});const r=this.createContextualEventData(e,t,n,s),o=b.snapshot(t.payload);r._baton=t.payload,await this.eventBus.emitAsync(e.event,r);const c=b.snapshot(t.payload);b.log({sequenceName:n.name,movementName:s.name,beatEvent:e.event,beatNumber:e.beat,requestId:t.id},o,c);const a=Date.now()-i;this.statisticsManager?.recordBeatExecution(),this.eventBus.emit(d.BEAT_COMPLETED,{sequenceName:n.name,movementName:s.name,beat:e.beat,event:e.event,executionTime:a,requestId:t.id});const u=this.eventBus.__conductorLogger?.getDepth?.(t.id)??0,h="  ".repeat(Math.max(0,u));console.log(`${h}âœ… BeatExecutor: Beat ${e.beat} (${e.event}) completed in ${a}ms`)}catch(i){if(console.error(`âŒ BeatExecutor: Beat ${e.beat} (${e.event}) failed:`,i),t.errors.push({beat:e.beat,error:i instanceof Error?i.message:String(i),timestamp:Date.now()}),this.eventBus.emit(d.BEAT_FAILED,{sequenceName:n.name,movementName:s.name,beat:e.beat,event:e.event,error:i instanceof Error?i.message:String(i),requestId:t.id}),e.errorHandling==="abort-sequence"||e.errorHandling==="abort")throw i;e.errorHandling==="continue"&&console.log("âš ï¸ BeatExecutor: Continuing execution despite beat error (errorHandling: continue)")}finally{if(this.isExecutingBeat=!1,this.beatExecutionQueue.length>0){const i=this.beatExecutionQueue.shift();setImmediate(()=>{this.executeBeat(i.beat,i.context,n,s).then(i.resolve).catch(i.reject)})}}}createContextualEventData(e,t,n,s){const i={...t.data,...e.data},r={sequence:{name:n.name,tempo:n.tempo,key:n.key,timeSignature:n.timeSignature},movement:{name:s.name,description:s.description},beat:{number:e.beat,event:e.event,title:e.title,description:e.description,dynamics:e.dynamics,timing:e.timing},execution:{requestId:t.id,priority:t.priority,currentMovement:t.currentMovement,currentBeat:t.currentBeat,completedBeats:t.completedBeats.length,totalBeats:this.calculateTotalBeats(t.sequence)}};return{...i,_musicalContext:r,_timestamp:Date.now(),_eventBus:this.eventBus}}validateBeat(e){try{if(typeof e.beat!="number"||e.beat<1)throw new Error("Beat must have a valid beat number (>= 1)");if(!e.event||typeof e.event!="string")throw new Error("Beat must have a valid event name");if(!e.title||typeof e.title!="string")throw new Error("Beat must have a valid title");if(!e.dynamics||!Object.values(T).includes(e.dynamics))throw new Error("Beat must have valid dynamics");if(!e.timing||!Object.values(y).includes(e.timing))throw new Error("Beat must have valid timing");if(!e.errorHandling||!["continue","abort-sequence","retry","abort"].includes(e.errorHandling))throw new Error("Beat must have valid error handling strategy");return!0}catch(t){return console.error(`âŒ BeatExecutor: Beat validation failed for beat ${e.beat}:`,t),!1}}getBeatStatistics(e){return{beatNumber:e.beat,event:e.event,dynamics:e.dynamics||"unknown",timing:e.timing||"unknown",errorHandling:e.errorHandling||"continue",hasData:!!e.data&&Object.keys(e.data).length>0,dataKeys:e.data?Object.keys(e.data):[]}}estimateBeatExecutionTime(e,t=120){const n=60/t*1e3;let s=1;switch(e.dynamics){case T.PIANISSIMO:s=.8;break;case T.PIANO:s=.9;break;case T.MEZZO_PIANO:s=.95;break;case T.MEZZO_FORTE:s=1.05;break;case T.FORTE:s=1.1;break;case T.FORTISSIMO:s=1.2;break;default:s=1}let i=1;switch(e.timing){case y.IMMEDIATE:i=0;break;case y.AFTER_BEAT:i=1;break;case y.SYNCHRONIZED:i=.5;break;case y.DELAYED:i=1.5;break;default:i=1}return Math.round(n*s*i)}clearBeatQueue(){this.beatExecutionQueue=[],console.log("ðŸ§¹ BeatExecutor: Beat execution queue cleared")}getExecutionStatus(){return{isExecuting:this.isExecutingBeat,queueLength:this.beatExecutionQueue.length}}calculateTotalBeats(e){return e.movements.reduce((t,n)=>t+n.beats.length,0)}}class de{constructor(e,t,n,s){this.eventBus=e,this.spaValidator=t,this.performanceTracker=s,this.beatExecutor=new he(e,t,n)}async executeMovement(e,t,n){console.log(`ðŸŽµ MovementExecutor: Starting movement "${e.name}" with ${e.beats.length} beats`),this.performanceTracker&&this.performanceTracker.startMovementTiming(n.name,e.name,t.id),this.eventBus.emit(d.MOVEMENT_STARTED,{sequenceName:n.name,movementName:e.name,requestId:t.id,beatsCount:e.beats.length});try{for(let i=0;i<e.beats.length;i++){const r=e.beats[i];t.currentBeat=r.beat,console.log(`ðŸ¥ MovementExecutor: Executing beat ${r.beat} (${i+1}/${e.beats.length})`),await this.handleBeatTiming(r,n),await this.beatExecutor.executeBeat(r,t,n,e),t.completedBeats.push(r.beat)}let s=null;this.performanceTracker&&(s=this.performanceTracker.endMovementTiming(n.name,e.name,t.id,e.beats.length)),this.eventBus.emit(d.MOVEMENT_COMPLETED,{sequenceName:n.name,movementName:e.name,requestId:t.id,beatsExecuted:e.beats.length,duration:s}),console.log(`âœ… MovementExecutor: Movement "${e.name}" completed successfully`)}catch(s){throw this.performanceTracker&&this.performanceTracker.cleanupFailedMovement(n.name,e.name,t.id),console.error(`âŒ MovementExecutor: Movement "${e.name}" failed:`,s),t.errors.push({beat:t.currentBeat,error:s instanceof Error?s.message:String(s),timestamp:Date.now()}),this.eventBus.emit(d.MOVEMENT_FAILED,{sequenceName:n.name,movementName:e.name,requestId:t.id,error:s instanceof Error?s.message:String(s)}),s}}async handleBeatTiming(e,t){if(e.timing===y.IMMEDIATE)return;const s=60/(typeof e?.tempo=="number"&&e.tempo>0?e.tempo:(typeof t.movements?.[t.movements.indexOf]?.tempo=="number"?t.movements?.[0]?.tempo:t.tempo)||120)*1e3;let i=0;switch(e.timing){case y.AFTER_BEAT:case y.ON_BEAT:i=s;break;case y.DELAYED:i=s*1.5;break;case y.SYNCHRONIZED:i=s/2;break;case y.IMMEDIATE:default:i=0}try{const r=J?.(),o=r?.flags?.timing?.maxDelayMs;typeof o=="number"&&o>=0&&(i=Math.min(i,o));const c=r?.flags?.timing?.scale;typeof c=="number"&&isFinite(c)&&c>0&&(i=Math.round(i*c))}catch{}i>0&&(console.log(`â±ï¸ MovementExecutor: Waiting ${i}ms for beat timing (${e.timing})`),await this.sleep(i))}sleep(e){return new Promise(t=>setTimeout(t,e))}validateMovement(e){try{if(!e.name||typeof e.name!="string")throw new Error("Movement must have a valid name");if(!e.beats||!Array.isArray(e.beats))throw new Error("Movement must have a beats array");if(e.beats.length===0)throw new Error("Movement must have at least one beat");return e.beats.forEach((t,n)=>{if(typeof t.beat!="number"||t.beat<1)throw new Error(`Beat ${n} must have a valid beat number (>= 1)`);if(!t.event||typeof t.event!="string")throw new Error(`Beat ${n} must have a valid event name`);if(!t.dynamics)throw new Error(`Beat ${n} must have dynamics specified`);if(!t.timing)throw new Error(`Beat ${n} must have timing specified`)}),!0}catch(t){return console.error(`âŒ MovementExecutor: Movement validation failed for "${e.name}":`,t),!1}}getMovementStatistics(e){const t={},n={},s={};return e.beats.forEach(i=>{t[i.event]=(t[i.event]||0)+1;const r=i.timing||"unknown";n[r]=(n[r]||0)+1;const o=i.dynamics||"unknown";s[o]=(s[o]||0)+1}),{name:e.name,totalBeats:e.beats.length,beatTypes:t,timingDistribution:n,dynamicsDistribution:s}}estimateExecutionTime(e,t=120){const n=60/t*1e3;let s=0;return e.beats.forEach(i=>{switch(i.timing){case y.IMMEDIATE:s+=0;break;case y.AFTER_BEAT:s+=n;break;case y.SYNCHRONIZED:s+=n/2;break;case y.DELAYED:s+=n*1.5;break;default:s+=n}}),Math.round(s)}}class ge{constructor(e,t,n,s,i){this.activeSequence=null,this.sequenceHistory=[],this.isExecutingBeat=!1,this.beatExecutionQueue=[],this.eventBus=e,this.spaValidator=t,this.executionQueue=n,this.statisticsManager=s,this.performanceTracker=i,this.movementExecutor=new de(e,t,s,i)}async executeSequence(e,t){const n=Date.now(),s=e.requestId,i={id:s,sequenceId:t.id,sequenceName:t.name,sequence:t,data:e.data||{},payload:{},startTime:n,currentMovement:0,currentBeat:0,completedBeats:[],errors:[],priority:e.priority||f.NORMAL,executionType:"IMMEDIATE"};this.activeSequence=i,this.executionQueue.setCurrentlyExecuting(e);try{this.eventBus.emit(d.SEQUENCE_STARTED,{sequenceName:t.name,requestId:s,priority:e.priority,data:e.data});for(let o=0;o<t.movements.length;o++){const c=t.movements[o];i.currentMovement=o,i.currentBeat=0,console.log(`ðŸŽ¼ SequenceExecutor: Executing movement "${c.name}" (${o+1}/${t.movements.length})`),await this.movementExecutor.executeMovement(c,i,t)}const r=Date.now()-n;return this.eventBus.emit(d.SEQUENCE_COMPLETED,{sequenceName:t.name,requestId:s,executionTime:r,beatsExecuted:i.completedBeats.length,errors:i.errors.length}),this.sequenceHistory.push(i),this.activeSequence=null,this.executionQueue.markCompleted(e),console.log(`âœ… SequenceExecutor: Sequence "${t.name}" completed in ${r}ms`),s}catch(r){const o=Date.now()-n;throw i.errors.push({beat:i.currentBeat,error:r instanceof Error?r.message:String(r),timestamp:Date.now()}),this.eventBus.emit(d.SEQUENCE_FAILED,{sequenceName:t.name,requestId:s,error:r instanceof Error?r.message:String(r),executionTime:o}),this.sequenceHistory.push(i),this.activeSequence=null,this.executionQueue.markCompleted(e),console.error(`âŒ SequenceExecutor: Sequence "${t.name}" failed:`,r),r}}isSequenceRunning(e){return this.activeSequence?e?this.activeSequence.sequenceName===e:!0:!1}getCurrentSequence(){return this.activeSequence}stopExecution(){this.activeSequence&&(console.log(`ðŸ›‘ SequenceExecutor: Stopping execution of "${this.activeSequence.sequenceName}"`),this.activeSequence.errors.push({beat:this.activeSequence.currentBeat,error:"Sequence execution cancelled",timestamp:Date.now()}),this.eventBus.emit(d.SEQUENCE_CANCELLED,{sequenceName:this.activeSequence.sequenceName,requestId:this.activeSequence.id}),this.sequenceHistory.push(this.activeSequence),this.activeSequence=null)}getExecutionHistory(){return[...this.sequenceHistory]}clearExecutionHistory(){this.sequenceHistory=[],console.log("ðŸ§¹ SequenceExecutor: Execution history cleared")}calculateTotalBeats(e){return e.movements.reduce((t,n)=>t+n.beats.length,0)}getStatistics(){const e=this.statisticsManager.getStatistics();return{totalSequencesExecuted:e.totalSequencesExecuted,totalBeatsExecuted:e.totalBeatsExecuted,averageExecutionTime:e.averageExecutionTime,sequenceCompletionRate:e.sequenceCompletionRate,currentlyExecuting:!!this.activeSequence,executionHistorySize:this.sequenceHistory.length}}}class me{constructor(){this.moduleCache=new Map}async loadPluginModule(e){if(this.moduleCache.has(e))return console.log(`ðŸ“¦ Loading plugin from cache: ${e}`),this.moduleCache.get(e);try{if(!(typeof window<"u"&&typeof window.document<"u")&&e.startsWith("/plugins/")){const r=await O(()=>import("./__vite-browser-external-B1O5LaIO.js"),[]),{pathToFileURL:o}=await O(async()=>{const{pathToFileURL:h}=await import("./__vite-browser-external-B1O5LaIO.js");return{pathToFileURL:h}},[]),c=r.resolve(process.cwd(),e.replace(/^\/?plugins\//,"RenderX/public/plugins/")),a=o(c).href;console.log(`ðŸ”„ [node] Importing plugin via file URL: ${a}`);let u=null;try{if(u=await import(a),u&&u.default&&!u.sequence&&!u.handlers){const h=u.default;h&&(h.sequence||h.handlers)&&(u=h)}}catch(h){console.warn(`âš ï¸ file:// import failed for ${a}. Trying transform fallback.`,h)}if(!u?.sequence&&!u?.handlers)try{const m=(await O(()=>import("./__vite-browser-external-B1O5LaIO.js"),[])).readFileSync(c,"utf-8").replace(/^\s*import\s+[^;]+;?/gm,"").replace(/export const (\w+)\s*=\s*/g,"moduleExports.$1 = ").replace(/export\s+async\s+function\s+(\w+)\s*\(/g,"moduleExports.$1 = async function $1(").replace(/export\s+function\s+(\w+)\s*\(/g,"moduleExports.$1 = function $1(").replace(/export default\s+/g,"moduleExports.default = "),E={};new Function("moduleExports","fetch",m)(E,globalThis.fetch),u=E}catch(h){console.warn("âš ï¸ PluginLoader fallback transform failed:",h)}if(!u)throw new Error(`Failed to load plugin module at ${a}`);return this.moduleCache.set(e,u),u}}catch(i){console.warn("âš ï¸ Node/Jest import path mapping failed, falling back to web import:",i)}const n=`${e.substring(0,e.lastIndexOf("/"))}/dist/plugin.js`;if(K()){try{console.log(`ðŸ”„ Attempting to load plugin: ${e}`);const i=await import(e);return this.moduleCache.set(e,i),console.log(`âœ… Successfully loaded plugin: ${e}`),i}catch{console.log(`âš ï¸ Dev load failed (${e}), trying bundled path as fallback`)}try{console.log(`ðŸ”„ Attempting to load bundled plugin: ${n}`);let i=await import(n);if(i&&i.default&&!i.sequence&&!i.handlers){const r=i.default;r&&(r.sequence||r.handlers)&&(i=r)}return this.moduleCache.set(e,i),console.log(`âœ… Successfully loaded bundled plugin: ${n}`),i}catch{console.warn(`âš ï¸ Failed to load plugin from both dev and bundled paths for ${e}`)}}else{try{console.log(`ðŸ”„ Attempting to load bundled plugin: ${n}`);let i=await import(n);if(i&&i.default&&!i.sequence&&!i.handlers){const r=i.default;r&&(r.sequence||r.handlers)&&(i=r)}return this.moduleCache.set(e,i),console.log(`âœ… Successfully loaded bundled plugin: ${n}`),i}catch{console.log(`âš ï¸ Bundled version not available (${n}), trying original path`)}try{console.log(`ðŸ”„ Attempting to load plugin: ${e}`);let i=await import(e);if(i&&i.default&&!i.sequence&&!i.handlers){const r=i.default;r&&(r.sequence||r.handlers)&&(i=r)}return this.moduleCache.set(e,i),console.log(`âœ… Successfully loaded plugin: ${e}`),i}catch(i){return console.warn(`âš ï¸ Failed to load plugin from original path: ${e}. Error: ${i instanceof Error?i.message:i}`),this.loadPluginModuleComplex(e)}}}async loadPluginModuleComplex(e){try{console.log(`ðŸ”„ Loading plugin module with complex resolution: ${e}`);const t=e.substring(0,e.lastIndexOf("/")),n=t.substring(t.lastIndexOf("/")+1);console.log(`ðŸ” Plugin directory: ${t}`),console.log(`ðŸ” Plugin name: ${n}`);const s=[`${t}/index.js`,`${t}/src/index.js`,`${t}/lib/index.js`,`${t}/dist/index.js`,`${t}/${n}.js`,`${t}/main.js`];for(const i of s)try{console.log(`ðŸ”„ Trying resolution strategy: ${i}`);let r=await import(i);if(r&&r.default&&!r.sequence&&!r.handlers){const o=r.default;o&&(o.sequence||o.handlers)&&(r=o)}return this.moduleCache.set(e,r),console.log(`âœ… Successfully loaded plugin with strategy: ${i}`),r}catch(r){console.log(`âš ï¸ Strategy failed: ${i} - ${r instanceof Error?r.message:r}`)}throw new Error(`Failed to load plugin module: ${e}. All resolution strategies failed.`)}catch(t){throw console.error(`âŒ Complex plugin loading failed for ${e}:`,t),t}}async loadPlugin(e){try{console.log(`ðŸ§  PluginLoader: Loading plugin from: ${e}`);const t=await this.loadPluginModule(e);return!t||typeof t!="object"?(console.warn(`ðŸ§  Failed to load plugin: invalid plugin structure at ${e}`),null):!t.sequence&&!t.handlers&&!t.default?(console.warn(`ðŸ§  Plugin at ${e} missing required exports (sequence, handlers, or default)`),null):t.default&&!t.sequence?(console.log(`ðŸ”„ Using default export for plugin: ${e}`),t.default):(console.log(`âœ… Successfully loaded and validated plugin: ${e}`),t)}catch(t){return console.error(`âŒ Failed to load plugin from ${e}:`,t),null}}async preloadPlugins(e){console.log(`ðŸ”„ Preloading ${e.length} plugins...`);const t=e.map(async i=>{try{return await this.loadPlugin(i)}catch(r){return console.error(`âŒ Failed to preload plugin ${i}:`,r),null}}),n=await Promise.all(t),s=n.filter(i=>i!==null).length;return console.log(`âœ… Preloaded ${s}/${e.length} plugins successfully`),n}isCached(e){return this.moduleCache.has(e)}clearCache(){this.moduleCache.clear(),console.log("ðŸ§¹ PluginLoader: Module cache cleared")}getCacheStatistics(){return{cachedModules:this.moduleCache.size,cachedPaths:Array.from(this.moduleCache.keys())}}removeCached(e){const t=this.moduleCache.delete(e);return t&&console.log(`ðŸ—‘ï¸ Removed plugin from cache: ${e}`),t}validatePluginModule(e){const t=[],n=[];return!e||typeof e!="object"?(t.push("Plugin module is not a valid object"),{isValid:!1,errors:t,warnings:n}):(e.sequence||(e.default?.sequence?n.push("Using sequence from default export"):t.push("Missing required 'sequence' export")),e.handlers||(e.default?.handlers?n.push("Using handlers from default export"):n.push("Missing 'handlers' export - plugin may be event-bus driven")),{isValid:t.length===0,errors:t,warnings:n})}}class fe{validatePluginStructure(e,t,n){const s=[],i=[];try{(!n||typeof n!="string"||n.trim()==="")&&s.push("Plugin ID must be a non-empty string");const r=this.validateSequence(e);s.push(...r.errors),i.push(...r.warnings);const o=this.validateHandlers(t);s.push(...o.errors),i.push(...o.warnings);const c=this.validateCIACompliance(e,t);return s.push(...c.errors),i.push(...c.warnings),{isValid:s.length===0,errors:s,warnings:i}}catch(r){return s.push(`Validation error: ${r instanceof Error?r.message:String(r)}`),{isValid:!1,errors:s,warnings:i}}}validateSequence(e){const t=[],n=[];return e?typeof e!="object"?(t.push("Sequence must be an object"),{isValid:!1,errors:t,warnings:n}):((!e.name||typeof e.name!="string")&&t.push("Sequence must have a valid name (string)"),!e.movements||!Array.isArray(e.movements)?t.push("Sequence must have movements array"):e.movements.length===0?n.push("Sequence has no movements"):e.movements.forEach((s,i)=>{const r=this.validateMovement(s,i);t.push(...r.errors),n.push(...r.warnings)}),e.description&&typeof e.description!="string"&&n.push("Sequence description should be a string"),e.tempo&&(typeof e.tempo!="number"||e.tempo<=0)&&n.push("Sequence tempo should be a positive number"),e.key&&typeof e.key!="string"&&n.push("Sequence key should be a string"),{isValid:t.length===0,errors:t,warnings:n}):(t.push("Sequence is required"),{isValid:!1,errors:t,warnings:n})}validateMovement(e,t){const n=[],s=[];return!e||typeof e!="object"?(n.push(`Movement ${t} must be an object`),{isValid:!1,errors:n,warnings:s}):((!e.name||typeof e.name!="string")&&n.push(`Movement ${t} must have a valid name (string)`),!e.beats||!Array.isArray(e.beats)?n.push(`Movement ${t} must have beats array`):e.beats.length===0?s.push(`Movement ${t} has no beats`):e.beats.forEach((i,r)=>{const o=this.validateBeat(i,t,r);n.push(...o.errors),s.push(...o.warnings)}),{isValid:n.length===0,errors:n,warnings:s})}validateBeat(e,t,n){const s=[],i=[];if(!e||typeof e!="object")return s.push(`Movement ${t}, Beat ${n} must be an object`),{isValid:!1,errors:s,warnings:i};const r=`Movement ${t}, Beat ${n}`;return(typeof e.beat!="number"||e.beat<1)&&s.push(`${r} must have a valid beat number (>= 1)`),(!e.event||typeof e.event!="string")&&s.push(`${r} must have a valid event name (string)`),(!e.title||typeof e.title!="string")&&s.push(`${r} must have a valid title (string)`),e.dynamics||i.push(`${r} missing dynamics property`),e.timing||i.push(`${r} missing timing property`),e.errorHandling?["continue","abort-sequence","retry"].includes(e.errorHandling)||i.push(`${r} has invalid errorHandling value: ${e.errorHandling}`):i.push(`${r} missing errorHandling property`),{isValid:s.length===0,errors:s,warnings:i}}validateHandlers(e){const t=[],n=[];return e?typeof e!="object"?(t.push("Handlers must be an object"),{isValid:!1,errors:t,warnings:n}):(Object.entries(e).forEach(([s,i])=>{typeof i!="function"&&t.push(`Handler for event '${s}' must be a function`)}),Object.keys(e).length===0&&n.push("Handlers object is empty"),{isValid:t.length===0,errors:t,warnings:n}):(n.push("No handlers provided - plugin may be event-bus driven"),{isValid:!0,errors:t,warnings:n})}validateCIACompliance(e,t){const n=[],s=[];if(e&&(e.description||s.push("CIA recommendation: Sequence should have a description"),e.version||s.push("CIA recommendation: Sequence should have a version"),e.movements&&e.movements.forEach(i=>{i.beats&&i.beats.forEach(r=>{r.event&&!r.event.includes("-")&&!r.event.includes(".")&&s.push(`CIA recommendation: Event '${r.event}' should use kebab-case or dot notation`)})})),t){const i=Object.keys(t);i.length>0&&i.forEach(r=>{(r.toLowerCase().includes("window")||r.toLowerCase().includes("document"))&&s.push(`CIA warning: Handler '${r}' may cause memory leaks in SPA environment`)})}return{isValid:n.length===0,errors:n,warnings:s}}validateMetadata(e){const t=[],n=[];return e?typeof e!="object"?(t.push("Metadata must be an object"),{isValid:!1,errors:t,warnings:n}):(e.version?typeof e.version!="string"&&n.push("Metadata version should be a string"):n.push("Metadata should include version"),e.description?typeof e.description!="string"&&n.push("Metadata description should be a string"):n.push("Metadata should include description"),e.author&&typeof e.author!="string"&&n.push("Metadata author should be a string"),{isValid:t.length===0,errors:t,warnings:n}):(n.push("No metadata provided"),{isValid:!0,errors:t,warnings:n})}}class pe{constructor(){this.manifestCache=new Map}async loadManifest(e){if(this.manifestCache.has(e))return console.log(`ðŸ“¦ Loading manifest from cache: ${e}`),this.manifestCache.get(e);try{if(console.log(`ðŸ”„ Loading plugin manifest: ${e}`),!(typeof window<"u"&&typeof window.document<"u")&&e.startsWith("/plugins/"))try{const r=await O(()=>import("./__vite-browser-external-B1O5LaIO.js"),[]),o=await O(()=>import("./__vite-browser-external-B1O5LaIO.js"),[]),c=r.resolve(process.cwd(),e.replace(/^\/?plugins\//,"RenderX/public/plugins/"));if(o.existsSync(c)){const a=o.readFileSync(c,"utf-8"),u=JSON.parse(a),h=this.validateManifest(u);return this.manifestCache.set(e,h),console.log(`âœ… Successfully loaded manifest from local file: ${c}`),console.log(`ðŸ“‹ Found ${h.plugins.length} plugins in manifest`),h}}catch(r){console.warn("âš ï¸ Node local manifest load failed, falling back to fetch:",r)}const n=await fetch(e);if(!n.ok)throw new Error(`Failed to fetch manifest: ${n.status} ${n.statusText}`);const s=await n.json(),i=this.validateManifest(s);return this.manifestCache.set(e,i),console.log(`âœ… Successfully loaded manifest: ${e}`),console.log(`ðŸ“‹ Found ${i.plugins.length} plugins in manifest`),i}catch(t){console.error(`âŒ Failed to load manifest from ${e}:`,t);const n=this.createFallbackManifest();return console.log("ðŸ”„ Using fallback manifest"),n}}validateManifest(e){if(!e||typeof e!="object")throw new Error("Manifest must be a valid JSON object");if((!e.version||typeof e.version!="string")&&(console.warn("âš ï¸ Manifest missing version, using default"),e.version="1.0.0"),!e.plugins||!Array.isArray(e.plugins))throw new Error("Manifest must contain a plugins array");const t=[];return e.plugins.forEach((n,s)=>{try{const i=this.validatePluginEntry(n,s);t.push(i)}catch(i){console.error(`âŒ Invalid plugin entry at index ${s}:`,i)}}),t.length===0&&console.warn("âš ï¸ No valid plugins found in manifest"),{version:e.version,plugins:t,metadata:e.metadata||{}}}validatePluginEntry(e,t){if(!e||typeof e!="object")throw new Error(`Plugin entry ${t} must be an object`);if(!e.name||typeof e.name!="string")throw new Error(`Plugin entry ${t} must have a valid name`);if(!e.path||typeof e.path!="string")throw new Error(`Plugin entry ${t} must have a valid path`);return e.path.endsWith("/")||(e.path+="/"),{name:e.name,path:e.path,version:e.version||"1.0.0",description:e.description||`Plugin: ${e.name}`,autoMount:e.autoMount!==!1,dependencies:Array.isArray(e.dependencies)?e.dependencies:[],author:e.author||"Unknown",license:e.license||"MIT"}}createFallbackManifest(){return{version:"1.0.0",plugins:[{name:"fallback-plugin",path:"fallback/",version:"1.0.0",description:"Fallback plugin for when manifest loading fails",autoMount:!1,dependencies:[],author:"System",license:"MIT"}],metadata:{name:"Fallback Manifest",description:"Generated fallback manifest",author:"MusicalConductor",created:new Date().toISOString()}}}async loadManifestWithFallback(e){for(const t of e)try{const n=await this.loadManifest(t);return console.log(`âœ… Successfully loaded manifest from: ${t}`),n}catch{console.warn(`âš ï¸ Failed to load manifest from ${t}, trying next...`)}return console.warn("âš ï¸ All manifest sources failed, using fallback"),this.createFallbackManifest()}parseManifest(e){try{const t=JSON.parse(e);return this.validateManifest(t)}catch(t){throw console.error("âŒ Failed to parse manifest JSON:",t),new Error(`Invalid manifest JSON: ${t instanceof Error?t.message:String(t)}`)}}filterPlugins(e,t){return e.plugins.filter(n=>!(t.autoMount!==void 0&&n.autoMount!==t.autoMount||t.name&&!n.name.includes(t.name)||t.version&&n.version!==t.version||t.author&&n.author!==t.author))}getManifestStatistics(e){const t=e.plugins.filter(i=>i.autoMount).length,n=[...new Set(e.plugins.map(i=>i.author||"Unknown"))],s=[...new Set(e.plugins.map(i=>i.version))];return{totalPlugins:e.plugins.length,autoMountPlugins:t,manualMountPlugins:e.plugins.length-t,uniqueAuthors:n,versions:s}}clearCache(){this.manifestCache.clear(),console.log("ðŸ§¹ PluginManifestLoader: Cache cleared")}getCachedPaths(){return Array.from(this.manifestCache.keys())}removeCached(e){return this.manifestCache.delete(e)}}const D="__mc_cb_ref__",N="__mc_correlation_id__",Ee=120*1e3;class R{constructor(){this.store=new Map}static getInstance(){return R.instance||(R.instance=new R),R.instance}ensureCorrelationId(e){if(e&&typeof e=="object"&&typeof e[N]=="string")return e[N];const t=`mc-${Date.now()}-${Math.random().toString(36).slice(2,8)}`;if(e&&typeof e=="object")try{e[N]=t}catch{}return t}preserveInPlace(e){const t=this.ensureCorrelationId(e),n=this.getOrCreateEntry(t);let s=0;const i=(r,o)=>{if(!(!r||typeof r!="object")){if(Array.isArray(r)){for(let c=0;c<r.length;c++){const a=r[c],u=`${o}[${c}]`;if(typeof a=="function"){const h=`${u}`;n.fns.set(h,a),r[c]={[D]:h},s++}else a&&typeof a=="object"&&i(a,u)}return}for(const c of Object.keys(r)){if(c===D||c===N)continue;const a=r[c],u=o?`${o}.${c}`:c;if(typeof a=="function")n.fns.set(u,a),r[c]={[D]:u},s++;else if(a&&typeof a=="object"){if(typeof a?.tagName=="string")continue;i(a,u)}}}};try{i(e,"")}catch{}return n.lastAccess=Date.now(),this.purgeOldEntries(),{correlationId:t,count:s}}rehydrateInPlace(e){if(!e||typeof e!="object")return 0;const t=e[N];if(!t||typeof t!="string")return 0;const n=this.store.get(t);if(!n)return 0;let s=0;const i=o=>{if(!(!o||typeof o!="object")){if(Array.isArray(o)){for(let c=0;c<o.length;c++){const a=o[c];if(a&&typeof a=="object"&&D in a){const u=a[D],h=n.fns.get(u);typeof h=="function"&&(o[c]=h,s++)}else a&&typeof a=="object"&&i(a)}return}for(const c of Object.keys(o)){const a=o[c];if(a&&typeof a=="object"&&D in a){const u=a[D],h=n.fns.get(u);typeof h=="function"&&(o[c]=h,s++)}else a&&typeof a=="object"&&i(a)}}};try{i(e)}catch{}const r=(o,c,a)=>{const u=[];let h="";const S=()=>{h&&(u.push(h),h="")};for(let E=0;E<c.length;E++){const g=c[E];if(g===".")S();else if(g==="["){S();let p=E+1,L="";for(;p<c.length&&c[p]!=="]";)L+=c[p++];u.push(parseInt(L,10)),E=p}else h+=g}S();let m=o;for(let E=0;E<u.length;E++){const g=u[E],p=E===u.length-1;if(typeof g=="number"){if(!Array.isArray(m))return;if(p){typeof m[g]!="function"&&(m[g]=a);return}(m[g]==null||typeof m[g]!="object")&&(m[g]={}),m=m[g]}else{if(p){typeof m[g]!="function"&&(m[g]=a);return}(m[g]==null||typeof m[g]!="object")&&(m[g]={}),m=m[g]}}};for(const[o,c]of n.fns.entries())try{r(e,o,c),s++}catch{}return n.lastAccess=Date.now(),this.purgeOldEntries(),s}cleanup(e){this.store.delete(e)}getOrCreateEntry(e){let t=this.store.get(e);return t||(t={fns:new Map,createdAt:Date.now(),lastAccess:Date.now()},this.store.set(e,t)),t}purgeOldEntries(e=Date.now(),t=Ee){for(const[n,s]of this.store.entries())e-s.lastAccess>t&&this.store.delete(n)}}R.instance=null;const j={PLACEHOLDER_KEY:D,CORRELATION_KEY:N},ye=Object.freeze(Object.defineProperty({__proto__:null,CallbackRegistry:R,__internal:j},Symbol.toStringTag,{value:"Module"}));class ve{constructor(e,t,n){this.mountedPlugins=new Map,this.pluginHandlers=new Map,this.pluginSubscriptions=new Map,this.requestContexts=new Map,this.pluginsRegistered=!1,this.discoveredPluginIds=[],this.eventBus=e,this.spaValidator=t,this.sequenceRegistry=n,this.pluginLoader=new me,this.pluginValidator=new fe,this.manifestLoader=new pe}async mount(e,t,n,s){const i=n||e?.name||"unknown-plugin",r=[];try{console.log(`ðŸ§  PluginManager: Attempting to mount plugin: ${i}`);const o=this.pluginValidator.validatePluginStructure(e,t,i);if(!o.isValid)return{success:!1,pluginId:i,message:`Plugin validation failed: ${o.errors.join(", ")}`,reason:"validation_failed",warnings:o.warnings};if(r.push(...o.warnings),this.spaValidator.registerPlugin(i),this.mountedPlugins.has(i)&&console.log(`ðŸ§  Plugin already mounted: ${i} â€” augmenting with additional sequence`),t&&typeof t=="object"&&this.spaValidator.config.enforceConductorLogger!=="off"){for(const[u,h]of Object.entries(t))if(typeof h=="function"&&this.spaValidator.detectDirectConsoleUsage(h)){const m=new Error().stack||"",E=this.spaValidator.createViolation("PLUGIN_DIRECT_CONSOLE_USAGE",i,`Direct console usage detected in ${i}.${u}. Use context.logger.<level>(...) instead of console.<level>(...)`,m,this.spaValidator.config.enforceConductorLogger==="error"?"error":"warning");this.spaValidator.handleViolation(E),this.spaValidator.config.enforceConductorLogger==="error"&&(r.push(`Handler ${u} disabled due to direct console usage`),delete t[u])}}this.sequenceRegistry.register(e);const c={sequence:e,handlers:t||{},metadata:{id:i,version:s?.version||"1.0.0",author:s?.author}},a=this.mountedPlugins.get(i);if(a){const u={...a.handlers,...t},h={...a,handlers:u,metadata:{id:i,version:s?.version||a.metadata?.version||"1.0.0",author:s?.author||a.metadata?.author}};this.mountedPlugins.set(i,h)}else this.mountedPlugins.set(i,c);try{const u=[],h=e?.movements||[];for(const S of h){const m=S?.beats||[];for(const E of m){const g=E?.event,p=E?.handler;if(!g||!p)continue;const L=t?.[p];if(typeof L!="function")continue;const te=this.eventBus.subscribe(g,C=>{try{const x=R.getInstance().rehydrateInPlace(C);x>0&&console.log(`ðŸŽ¼ PluginManager: rehydrated ${x} callback(s) for event ${g}`)}catch(x){console.warn("âš ï¸ PluginManager: callback rehydration skipped:",x?.message||x)}const I=C?._musicalContext?.execution?.requestId||`${i}::__global__`;let v=this.requestContexts.get(I);v?C?.onComponentsLoaded&&(v.onComponentsLoaded=C.onComponentsLoaded):v={payload:{},onComponentsLoaded:C?.onComponentsLoaded,plugin:{id:i,metadata:c.metadata},sequence:c.sequence};const ne=async()=>{const x={log:(...w)=>this.eventBus.emit("musical-conductor:log",{level:"log",message:w,requestId:I,pluginId:i,handlerName:p}),info:(...w)=>this.eventBus.emit("musical-conductor:log",{level:"info",message:w,requestId:I,pluginId:i,handlerName:p}),warn:(...w)=>this.eventBus.emit("musical-conductor:log",{level:"warn",message:w,requestId:I,pluginId:i,handlerName:p}),error:(...w)=>this.eventBus.emit("musical-conductor:log",{level:"error",message:w,requestId:I,pluginId:i,handlerName:p})};this.eventBus.emit("plugin:handler:start",{requestId:I,pluginId:i,handlerName:p});const se=b.snapshot(v.payload);try{const w={...v,logger:x,conductor:{play:(P,z,A,re)=>{try{try{const _=j.CORRELATION_KEY;A&&typeof A=="object"&&_&&!(_ in A)&&C&&typeof C[_]=="string"&&(A[_]=C[_])}catch{}return q.getInstance(this.eventBus).play(P,z,A,re)}catch(V){return console.warn(`ðŸ§  PluginManager: conductor.play unavailable in handler context for ${i}.${p}:`,V?.message||V),null}}},stageCrew:(()=>{try{const P=j.CORRELATION_KEY,z=C?.[P]||`mc-${Date.now()}-${Math.random().toString(36).slice(2,6)}`,{StageCrew:A}=require("../stage/StageCrew.js");return new A(this.eventBus,i)}catch{return}})(),emit:void 0},Q=await L(C,w);Q&&typeof Q=="object"&&(v.payload={...v.payload,...Q});const ie=b.snapshot(v.payload);if(b.log({sequenceName:v.sequence?.name,beatEvent:g,handlerName:p,pluginId:i,requestId:I},se,ie),p==="notifyComponentsLoaded"){const P=v.payload?.preparedComponents||[];if(typeof v.onComponentsLoaded=="function")try{v.onComponentsLoaded(P)}catch{}this.eventBus.emit("components:loaded",{components:P})}}catch(w){console.error(`ðŸ§  PluginManager: Handler execution failed for ${i}.${p}:`,w)}finally{this.eventBus.emit("plugin:handler:end",{requestId:I,pluginId:i,handlerName:p})}};v.chain=(v.chain||Promise.resolve()).then(ne).catch(()=>{}),this.requestContexts.set(I,v)},{pluginId:`${i}:${e.id}`});u.push(te)}}if(u.length>0){const S=this.pluginSubscriptions.get(i)||[];this.pluginSubscriptions.set(i,[...S,...u])}}catch(u){console.warn(`ðŸ§  PluginManager: Failed wiring beat handlers for ${i}:`,u)}if(t&&typeof t=="object"){const u=this.pluginHandlers.get(i)||{};this.pluginHandlers.set(i,{...u,...t})}try{this.eventBus.subscribe(`${i}:sequence:completed`,u=>{const h=u?._musicalContext?.execution?.requestId;h&&this.requestContexts.delete(h)},{pluginId:`${i}:${e.id}:cleanup`})}catch{}return console.log(`âœ… Plugin mounted successfully: ${i}`),console.log(`ðŸŽ¼ Sequence registered: ${e.name}`),{success:!0,pluginId:i,message:`Successfully mounted plugin: ${i}`,warnings:r}}catch(o){return console.error(`âŒ Failed to mount plugin ${i}:`,o),{success:!1,pluginId:i,message:o instanceof Error?o.message:String(o),reason:"mount_error",warnings:r}}}async unmount(e){try{const t=this.pluginSubscriptions.get(e)||[];for(const n of t)try{n?.()}catch{}this.pluginSubscriptions.delete(e),this.mountedPlugins.delete(e),this.pluginHandlers.delete(e)}catch(t){console.warn(`ðŸ§  PluginManager: Failed to unmount ${e}:`,t)}}unmountPlugin(e){try{if(!this.mountedPlugins.has(e))return console.warn(`ðŸ§  Plugin not found for unmounting: ${e}`),!1;const t=this.mountedPlugins.get(e);return this.sequenceRegistry.unregister(t.sequence.name),this.mountedPlugins.delete(e),this.pluginHandlers.delete(e),console.log(`âœ… Plugin unmounted successfully: ${e}`),!0}catch(t){return console.error(`âŒ Failed to unmount plugin ${e}:`,t),!1}}async registerCIAPlugins(){try{if(this.pluginsRegistered){console.log("âš ï¸ Plugins already registered, skipping duplicate registration");return}console.log("ðŸ§  Registering CIA-compliant plugins...");const e=this.getMountedPluginIds().length,t=await this.manifestLoader.loadManifest("/plugins/manifest.json");await this.registerPluginsFromManifest(t);try{this.discoveredPluginIds=t.plugins.map(s=>s.name)}catch{}const n=this.getMountedPluginIds().length;n>e?(this.pluginsRegistered=!0,console.log(`âœ… CIA-compliant plugins registered successfully (mounted: ${n-e}, total: ${n})`)):console.warn("âš ï¸ No CIA plugins were mounted. Leaving pluginsRegistered=false so a later retry can succeed.")}catch(e){console.error("âŒ Failed to register CIA plugins:",e),this.registerFallbackSequences()}}async registerPluginsFromManifest(e){console.log("ðŸŽ¼ PluginManager: Registering plugins from manifest..."),console.log(`ðŸ”Œ Processing ${e.plugins.length} plugins from manifest`);for(const t of e.plugins)try{if(t.autoMount){if(this.mountedPlugins.has(t.name)){console.log(`âš ï¸ Plugin already mounted, skipping: ${t.name}`);continue}console.log(`ðŸ”Œ Auto-mounting plugin: ${t.name} from ${t.path}`);const n=await this.pluginLoader.loadPluginModule(`/plugins/${t.path}index.js`);if(!n.sequence||!n.handlers){console.warn(`âš ï¸ Plugin ${t.name} missing required exports (sequence, handlers)`);continue}const s=await this.mount(n.sequence,n.handlers,n.sequence?.id||t.name,{version:t.version,description:t.description,path:t.path,autoMount:t.autoMount});s.success?console.log(`âœ… Auto-mounted plugin: ${t.name}`):console.error(`âŒ Failed to auto-mount plugin ${t.name}: ${s.message}`)}else console.log(`â­ï¸ Skipping non-auto-mount plugin: ${t.name}`)}catch(n){console.error(`âŒ Error processing plugin ${t.name}:`,n)}}registerFallbackSequences(){console.log("ðŸ”„ Registering fallback sequences..."),[{name:"fallback-sequence",description:"Basic fallback sequence",movements:[{name:"fallback-movement",beats:[{beat:1,event:"fallback-event",title:"Fallback Event",description:"Basic fallback event",dynamics:"forte",timing:"immediate",errorHandling:"continue",data:{}}]}]}].forEach(t=>{this.sequenceRegistry.register(t)}),console.log("âœ… Fallback sequences registered")}getPluginInfo(e){return this.mountedPlugins.get(e)}getMountedPluginIds(){const e=Array.from(this.mountedPlugins.keys());let t=[];try{t=this.sequenceRegistry.getAll().map(s=>s.id)}catch{}const n=new Set;for(const s of e)s&&n.add(s);for(const s of t)s&&n.add(s);for(const s of this.discoveredPluginIds||[])s&&n.add(s);return Array.from(n)}getMountedPlugins(){return this.getMountedPluginIds()}getPluginHandlers(e){return this.mountedPlugins.get(e)?this.pluginHandlers.get(e)||null:(console.warn(`ðŸ§  Plugin not found: ${e}. Available plugins: [${Array.from(this.mountedPlugins.keys()).join(", ")}]`),null)}getStatistics(){return{totalPlugins:this.mountedPlugins.size,mountedPlugins:this.getMountedPluginIds(),pluginsRegistered:this.pluginsRegistered}}getTotalSequences(){return Array.from(this.mountedPlugins.values()).reduce((e,t)=>e+(t.sequence?1:0),0)}reset(){this.mountedPlugins.clear(),this.pluginHandlers.clear(),this.pluginsRegistered=!1,console.log("ðŸ§¹ PluginManager: State reset")}}class Se{constructor(e,t){this.pluginManager=e,this.spaValidator=t}getMountedPlugins(){return this.pluginManager.getMountedPlugins()}play(e,t,n={},s=f.NORMAL,i){try{return console.log(`ðŸŽ¼ PluginInterfaceFacade.play(): ${e} -> ${t}`),this.spaValidator.registerPlugin(e),this.pluginManager.getPluginInfo(e)?i(t,n,s):(console.warn(`ðŸ§  Plugin not found: ${e}. Available plugins: [${this.pluginManager.getMountedPluginIds().join(", ")}]`),Promise.resolve(null))}catch(r){return console.error(`ðŸ§  PluginInterfaceFacade.play() failed for ${e}.${t}:`,r.message),Promise.resolve(null)}}async mount(e,t,n,s){return this.pluginManager.mount(e,t,n,s)}async registerCIAPlugins(){return this.pluginManager.registerCIAPlugins()}executeMovementWithHandler(e,t,n){try{const s=this.pluginManager.getPluginHandlers(e);if(!s)return console.warn(`ðŸ§  No handlers found for sequence: ${e}`),null;const i=s[t];return!i||typeof i!="function"?(console.warn(`ðŸ§  Handler not found or not a function: ${e}.${t}`),null):(console.log(`ðŸŽ¼ Executing handler: ${e}.${t} with data:`,n),i(n))}catch(s){return console.error(`ðŸ§  Handler execution failed for ${e}.${t}:`,s.message),null}}async loadPlugin(e){try{console.log(`ðŸ§  PluginInterfaceFacade: Loading plugin from: ${e}`);const t=await this.pluginManager.pluginLoader.loadPlugin(e);return t?await this.mount(t.sequence,t.handlers):{success:!1,pluginId:"unknown",message:`Failed to load plugin: ${e}`,reason:"load_failed"}}catch(t){return console.warn(`ðŸ§  PluginInterfaceFacade: Failed to load plugin from ${e}:`,t.message),{success:!1,pluginId:"unknown",message:`Failed to load plugin from ${e}: ${t.message}`,reason:"load_error"}}}extractPluginCode(e,t){try{const n=JSON.stringify(e,null,2),s=Object.keys(t).map(i=>`${i}: ${t[i].toString()}`).join(`
`);return`${n}
${s}`}catch(n){return console.warn("ðŸŽ¼ Failed to extract plugin code for validation:",n),""}}async validatePluginPreCompilation(e){try{const t=[],n=`/plugins/${e}/dist/plugin.js`;try{(await fetch(n)).ok||t.push(`Missing bundled artifact: ${n}`)}catch{t.push(`Cannot access bundled artifact: ${n}`)}const s=["index.js","sequence.js","manifest.json"];for(const i of s){const r=`/plugins/${e}/${i}`;try{(await fetch(r)).ok||t.push(`Missing required file: ${r}`)}catch{t.push(`Cannot access required file: ${r}`)}}return{valid:t.length===0,issues:t}}catch(t){return console.warn(`ðŸ”¨ Pre-compilation validation error for ${e}:`,t),{valid:!1,issues:[`Validation error: ${t.message}`]}}}unmountPlugin(e){return this.pluginManager.unmountPlugin(e)}getPluginInfo(e){return this.pluginManager.getPluginInfo(e)}getMountedPluginIds(){return this.pluginManager.getMountedPluginIds()}getPluginStatistics(){const e=this.pluginManager.getMountedPluginIds();return{mountedPlugins:e.length,totalSequences:this.pluginManager.getTotalSequences(),pluginIds:e}}}class be{constructor(e){this.ownershipTracker=e}analyzePriorityConflict(e,t,n,s){return n===f.HIGH?{hasConflict:!0,conflictType:"PRIORITY_CONFLICT",currentOwner:s,resolution:"INTERRUPT",message:`HIGH priority ${t} can interrupt ${s.symphonyName} for resource ${e}`}:{hasConflict:!0,conflictType:"SAME_RESOURCE",currentOwner:s,resolution:"REJECT",message:`Resource ${e} is owned by ${s.symphonyName}, rejecting ${n} priority request from ${t}`}}resolveConflict_Reject(e,t,n){return console.warn(`ðŸŽ¼ ResourceConflictResolver: REJECT - Resource ${e} is owned by ${n.symphonyName}, rejecting request from ${t}`),{success:!1,message:`Resource conflict: ${e} owned by ${n.symphonyName}`}}resolveConflict_Queue(e,t,n){return{...e,data:{...e.data,blockedBy:n.symphonyName}},console.log(`ðŸŽ¼ ResourceConflictResolver: QUEUE - Adding ${e.sequenceName} to queue, waiting for resource ${t} from ${n.symphonyName}`),{success:!0,message:`Request queued waiting for resource ${t}`}}resolveConflict_Interrupt(e,t,n,s,i,r,o){if(s!==f.HIGH)return{success:!1,message:`Only HIGH priority requests can interrupt. Current priority: ${s}`};console.log(`ðŸŽ¼ ResourceConflictResolver: INTERRUPT - HIGH priority ${t} interrupting ${r.symphonyName} for resource ${e}`),console.warn(`ðŸŽ¼ ResourceConflictResolver: Interrupting ${r.symphonyName} (${r.instanceId}) for HIGH priority request`),console.log(`ðŸŽ¼ ResourceConflictResolver: Resource ${e} forcibly transferred from ${r.symphonyName} to ${t}`),o.releaseResourceOwnership(e,r.sequenceExecutionId);const c=o.acquireResourceOwnership(e,t,n,s,i);return{success:c,message:c?`Resource ${e} successfully transferred to ${t}`:`Failed to transfer resource ${e} to ${t}`}}determineOptimalStrategy(e,t,n,s){return t===f.HIGH?"INTERRUPT":s>5&&t===f.NORMAL?"REJECT":Date.now()-n.acquiredAt>3e4?"QUEUE":"REJECT"}getResolutionStatistics(){return{totalConflicts:0,rejectedRequests:0,queuedRequests:0,interruptedOwners:0,averageResolutionTime:0}}canResolvePeacefully(e,t,n){return t===f.HIGH?!1:Date.now()-n.acquiredAt>1e4}}class qe{constructor(){this.resourceOwnership=new Map,this.sequenceInstances=new Map,this.symphonyResourceMap=new Map,this.instanceCounter=0}getResourceOwner(e){return this.resourceOwnership.get(e)}setResourceOwner(e,t,n){try{return this.resourceOwnership.set(e,t),this.symphonyResourceMap.has(n)||this.symphonyResourceMap.set(n,new Set),this.symphonyResourceMap.get(n).add(e),console.log(`ðŸŽ¼ ResourceOwnershipTracker: Resource ${e} acquired by ${n} (${t.instanceId})`),!0}catch(s){return console.error(`ðŸŽ¼ ResourceOwnershipTracker: Failed to set resource owner for ${e}:`,s),!1}}releaseResource(e,t){this.resourceOwnership.delete(e);const n=this.symphonyResourceMap.get(t);n&&(n.delete(e),n.size===0&&this.symphonyResourceMap.delete(t)),console.log(`ðŸŽ¼ ResourceOwnershipTracker: Resource ${e} released from ${t}`)}createSequenceInstance(e,t){const n=`${e}-${++this.instanceCounter}-${Date.now()}`,s={instanceId:n,symphonyName:e,sequenceExecutionId:t,createdAt:Date.now(),resourcesOwned:[]};return this.sequenceInstances.set(n,s),console.log(`ðŸŽ¼ ResourceOwnershipTracker: Created sequence instance ${n} for ${e}`),n}updateInstanceResources(e,t){const n=this.sequenceInstances.get(e);n&&(n.resourcesOwned=[...t])}removeSequenceInstance(e){const t=this.sequenceInstances.get(e);t&&(t.resourcesOwned.forEach(n=>{this.releaseResource(n,t.symphonyName)}),this.sequenceInstances.delete(e),console.log(`ðŸŽ¼ ResourceOwnershipTracker: Removed sequence instance ${e}`))}getAllResourceOwners(){return new Map(this.resourceOwnership)}getSymphonyResourceMap(){return new Map(this.symphonyResourceMap)}getSequenceInstances(){return new Map(this.sequenceInstances)}getResourcesOwnedBySymphony(e){return this.symphonyResourceMap.get(e)||new Set}getActiveInstancesForSymphony(e){return Array.from(this.sequenceInstances.values()).filter(t=>t.symphonyName===e)}isResourceOwned(e){return this.resourceOwnership.has(e)}getOwnershipDuration(e){const t=this.resourceOwnership.get(e);return t?Date.now()-t.acquiredAt:0}getStatistics(){const e=this.resourceOwnership.size,t=this.symphonyResourceMap.size;let n=0,s=0;for(const r of this.resourceOwnership.values())n+=Date.now()-r.acquiredAt,s++;const i=s>0?n/s:0;return{totalResources:e,ownedResources:e,availableResources:0,symphoniesWithResources:t,averageOwnershipDuration:i}}cleanupExpiredInstances(e=3e5){const t=Date.now();let n=0;for(const[s,i]of this.sequenceInstances.entries())t-i.createdAt>e&&(this.removeSequenceInstance(s),n++);return n>0&&console.log(`ðŸ§¹ ResourceOwnershipTracker: Cleaned up ${n} expired instances`),n}reset(){this.resourceOwnership.clear(),this.sequenceInstances.clear(),this.symphonyResourceMap.clear(),this.instanceCounter=0,console.log("ðŸ§¹ ResourceOwnershipTracker: All tracking data reset")}getDebugInfo(){return{resourceOwnership:Object.fromEntries(this.resourceOwnership),sequenceInstances:Object.fromEntries(this.sequenceInstances),symphonyResourceMap:Object.fromEntries(Array.from(this.symphonyResourceMap.entries()).map(([e,t])=>[e,Array.from(t)])),instanceCounter:this.instanceCounter}}}class we{constructor(){this.ownershipTracker=new qe,this.conflictResolver=new be(this.ownershipTracker)}checkResourceConflict(e,t,n,s){const i=this.ownershipTracker.getResourceOwner(e);return i?i.symphonyName===t?i.instanceId===s?{hasConflict:!1,conflictType:"NONE",currentOwner:i,resolution:"ALLOW",message:`Resource ${e} already owned by same instance`}:{hasConflict:!0,conflictType:"INSTANCE_CONFLICT",currentOwner:i,resolution:"REJECT",message:`Resource ${e} owned by different instance of ${t}`}:this.conflictResolver.analyzePriorityConflict(e,t,n,i):{hasConflict:!1,conflictType:"NONE",resolution:"ALLOW",message:`Resource ${e} is available`}}acquireResourceOwnership(e,t,n,s,i){const r=this.checkResourceConflict(e,t,s,n);if(r.resolution==="REJECT")return console.warn(`ðŸŽ¼ ResourceManager: Resource acquisition rejected - ${r.message}`),!1;r.resolution==="INTERRUPT"&&(console.log(`ðŸŽ¼ ResourceManager: Interrupting current owner for HIGH priority request - ${r.message}`),this.releaseResourceOwnership(e,r.currentOwner.sequenceExecutionId));const o={symphonyName:t,instanceId:n,resourceId:e,acquiredAt:Date.now(),priority:s,sequenceExecutionId:i};return this.ownershipTracker.setResourceOwner(e,o,t)}releaseResourceOwnership(e,t){const n=this.ownershipTracker.getResourceOwner(e);if(n){if(t&&n.sequenceExecutionId!==t){console.warn(`ðŸŽ¼ ResourceManager: Cannot release resource ${e} - execution ID mismatch`);return}this.ownershipTracker.releaseResource(e,n.symphonyName),console.log(`ðŸŽ¼ ResourceManager: Released resource ${e} from ${n.symphonyName}`)}}resolveResourceConflictAdvanced(e,t,n,s,i,r){const o=this.checkResourceConflict(e,t,s,n);if(!o.hasConflict){const a=this.acquireResourceOwnership(e,t,n,s,i);return{success:a,message:a?`Resource ${e} acquired successfully`:`Failed to acquire resource ${e}`,strategy:"DIRECT_ACQUISITION"}}const c=o.currentOwner;switch(o.resolution){case"REJECT":return{...this.conflictResolver.resolveConflict_Reject(e,t,c),strategy:"REJECT"};case"QUEUE":return{...this.conflictResolver.resolveConflict_Queue(r,e,c),strategy:"QUEUE"};case"INTERRUPT":return{...this.conflictResolver.resolveConflict_Interrupt(e,t,n,s,i,c,this),strategy:"INTERRUPT"};default:return{success:!1,message:`Unknown resolution strategy: ${o.resolution}`,strategy:"UNKNOWN"}}}getResourceOwnership(){return this.ownershipTracker.getAllResourceOwners()}getSymphonyResourceMap(){return this.ownershipTracker.getSymphonyResourceMap()}getSequenceInstances(){return this.ownershipTracker.getSequenceInstances()}getResourceStatistics(){return this.ownershipTracker.getStatistics()}getResourceOwnershipTracker(){return this.ownershipTracker}reset(){this.ownershipTracker.reset(),console.log("ðŸ§¹ ResourceManager: All resource ownership reset")}}class Me{constructor(e){this.resourceManager=e}checkResourceConflict(e,t,n="NORMAL"){try{const s=this.resourceManager.checkResourceConflict(e,t,n,t);return{hasConflict:s.hasConflict,conflictingResource:e,conflictType:s.hasConflict?"ownership":void 0,resolution:s.resolution==="ALLOW"?"override":s.resolution==="REJECT"?"reject":(s.resolution==="QUEUE","queue"),reason:s.message}}catch(s){return console.error("ðŸ”´ ResourceDelegator: Error checking resource conflict:",s),{hasConflict:!0,conflictType:"access",resolution:"reject",reason:`Error checking resource conflict: ${s.message}`}}}determineConflictType(e,t,n){return this.hasTimingConflict(e,n)?"timing":this.hasDependencyConflict(e,t,n)?"dependency":this.hasAccessConflict(e,t,n)?"access":"ownership"}hasTimingConflict(e,t){return!1}hasDependencyConflict(e,t,n){return!1}hasAccessConflict(e,t,n){return!1}determineResolutionStrategy(e,t){switch(e){case"timing":return"queue";case"dependency":return"queue";case"access":return"reject";case"ownership":return t==="IMMEDIATE"?"override":"queue";default:return"queue"}}acquireResourceOwnership(e,t,n="NORMAL"){try{const s=this.checkResourceConflict(e,t,n);if(s.hasConflict&&s.resolution==="reject")return{acquired:!1,resourceId:e,ownerId:t,reason:s.reason};if(this.resourceManager.acquireResourceOwnership(e,t,t,n,t)){const r=this.calculateExpirationTime(n);return{acquired:!0,resourceId:e,ownerId:t,expiresAt:r,reason:"Resource acquired successfully"}}else return{acquired:!1,resourceId:e,ownerId:t,reason:"Failed to acquire resource"}}catch(s){return console.error("ðŸ”´ ResourceDelegator: Error acquiring resource ownership:",s),{acquired:!1,resourceId:e,ownerId:t,reason:`Error acquiring resource: ${s.message}`}}}calculateExpirationTime(e){const t=Date.now(),n={IMMEDIATE:3e4,HIGH:6e4,NORMAL:3e5,LOW:6e5,BACKGROUND:18e5},s=n[e]||n.NORMAL;return t+s}releaseResourceOwnership(e,t){try{return this.resourceManager.releaseResourceOwnership(e,t),console.log(`âœ… ResourceDelegator: Released resource ${e} from ${t}`),!0}catch(n){return console.error("ðŸ”´ ResourceDelegator: Error releasing resource ownership:",n),!1}}resolveResourceConflictAdvanced(e,t,n="NORMAL"){const s=this.checkResourceConflict(e,t,n);if(!s.hasConflict)return{strategy:"priority-based",action:"allow",details:{originalResourceId:e,resolvedResourceId:e}};switch(s.conflictType){case"timing":return this.resolveTimingConflict(e,t,n);case"dependency":return this.resolveDependencyConflict(e,t,n);case"access":return this.resolveAccessConflict(e,t,n);case"ownership":default:return this.resolveOwnershipConflict(e,t,n)}}resolveTimingConflict(e,t,n){return{strategy:"time-based",action:"queue",details:{originalResourceId:e,queuePosition:1,estimatedWaitTime:1e3}}}resolveDependencyConflict(e,t,n){const s=[];return{strategy:"resource-sharing",action:s.length>0?"modify":"queue",details:{originalResourceId:e,alternativeResources:s,estimatedWaitTime:s.length>0?0:5e3}}}resolveAccessConflict(e,t,n){return{strategy:"priority-based",action:"reject",details:{originalResourceId:e}}}resolveOwnershipConflict(e,t,n){const s=n==="IMMEDIATE"?"allow":"queue";return{strategy:"priority-based",action:s,details:{originalResourceId:e,resolvedResourceId:e,queuePosition:s==="queue"?1:void 0,estimatedWaitTime:s==="queue"?1e4:0}}}getDebugInfo(){return{conflictsResolved:0,resourcesAcquired:0,resourcesReleased:0,activeConflicts:0}}}class $e{constructor(){this.statistics={totalSequencesExecuted:0,totalBeatsExecuted:0,averageExecutionTime:0,totalSequencesQueued:0,currentQueueLength:0,maxQueueLength:0,averageQueueWaitTime:0,errorCount:0,successRate:0,lastExecutionTime:null,sequenceCompletionRate:0,chainedSequences:0}}recordSequenceExecution(e){this.statistics.totalSequencesExecuted++;const t=.1;this.statistics.averageExecutionTime=this.statistics.averageExecutionTime*(1-t)+e*t,this.updateSuccessRate(),console.log(`ðŸ“Š StatisticsManager: Recorded sequence execution (${e.toFixed(2)}ms)`)}recordBeatExecution(){this.statistics.totalBeatsExecuted++}recordError(){this.statistics.errorCount++,this.updateSuccessRate(),console.warn("ðŸ“Š StatisticsManager: Recorded error occurrence")}recordSequenceQueued(){this.statistics.totalSequencesQueued++,this.statistics.currentQueueLength++,this.statistics.maxQueueLength=Math.max(this.statistics.maxQueueLength,this.statistics.currentQueueLength)}recordSequenceDequeued(){this.statistics.currentQueueLength>0&&this.statistics.currentQueueLength--}updateQueueWaitTime(e){this.statistics.averageQueueWaitTime=this.statistics.averageQueueWaitTime*(1-.1)+e*.1}updateSuccessRate(){const e=this.statistics.totalSequencesExecuted+this.statistics.errorCount;e>0?this.statistics.successRate=this.statistics.totalSequencesExecuted/e*100:this.statistics.successRate=100}getStatistics(){return{...this.statistics}}getEnhancedStatistics(e){return{...this.statistics,mountedPlugins:e}}reset(){this.statistics={totalSequencesExecuted:0,totalBeatsExecuted:0,averageExecutionTime:0,totalSequencesQueued:0,currentQueueLength:0,maxQueueLength:0,averageQueueWaitTime:0,errorCount:0,successRate:0,lastExecutionTime:null,sequenceCompletionRate:0,chainedSequences:0},console.log("ðŸ§¹ StatisticsManager: All statistics reset")}getPerformanceSummary(){const e=this.statistics.totalSequencesExecuted+this.statistics.errorCount,t=e>0?this.statistics.errorCount/e*100:0;return{executionEfficiency:this.statistics.successRate,queueEfficiency:this.statistics.averageQueueWaitTime>0?Math.max(0,100-this.statistics.averageQueueWaitTime/1e3):100,errorRate:t,throughput:this.statistics.averageExecutionTime>0?1e3/this.statistics.averageExecutionTime:0}}getQueueAnalytics(){return{currentLoad:this.statistics.currentQueueLength,maxLoadReached:this.statistics.maxQueueLength,averageWaitTime:this.statistics.averageQueueWaitTime,totalProcessed:this.statistics.totalSequencesQueued}}getPerformanceWarnings(){const e=[];return this.statistics.averageExecutionTime>5e3&&e.push("High average execution time (>5s)"),this.statistics.averageQueueWaitTime>1e4&&e.push("High average queue wait time (>10s)"),this.statistics.successRate<95&&e.push("Low success rate (<95%)"),this.statistics.currentQueueLength>10&&e.push("High current queue length (>10)"),this.statistics.errorCount>100&&e.push("High error count (>100)"),e}exportForMonitoring(){return{"conductor.sequences.executed":this.statistics.totalSequencesExecuted,"conductor.beats.executed":this.statistics.totalBeatsExecuted,"conductor.execution.avg_time_ms":this.statistics.averageExecutionTime,"conductor.queue.length":this.statistics.currentQueueLength,"conductor.queue.max_length":this.statistics.maxQueueLength,"conductor.queue.avg_wait_time_ms":this.statistics.averageQueueWaitTime,"conductor.errors.count":this.statistics.errorCount,"conductor.success.rate_percent":this.statistics.successRate}}getDebugInfo(){return{statistics:this.getStatistics(),performanceSummary:this.getPerformanceSummary(),queueAnalytics:this.getQueueAnalytics(),warnings:this.getPerformanceWarnings()}}}class Ce{constructor(){this.beatStartTimes=new Map,this.sequenceTimings=new Map,this.movementStartTimes=new Map,this.completedBeats=[],this.completedMovements=[],this.maxHistorySize=1e3}startBeatTiming(e,t){const n=`${e}-${t}`,s=performance.now();return this.beatStartTimes.set(n,s),console.log(`â±ï¸ PerformanceTracker: Started timing beat ${t} for ${e}`),n}endBeatTiming(e,t){const n=`${e}-${t}`,s=this.beatStartTimes.get(n);if(!s)return console.warn(`â±ï¸ PerformanceTracker: No start time found for beat ${t} in ${e}`),null;const i=performance.now(),r=i-s,o={sequenceName:e,beat:t,startTime:s,endTime:i,duration:r};return this.completedBeats.push(o),this.beatStartTimes.delete(n),this.completedBeats.length>this.maxHistorySize&&(this.completedBeats=this.completedBeats.slice(-this.maxHistorySize/2)),console.log(`â±ï¸ PerformanceTracker: Beat ${t} completed in ${r.toFixed(2)}ms`),r}cleanupFailedBeat(e,t){const n=`${e}-${t}`;this.beatStartTimes.delete(n),console.warn(`â±ï¸ PerformanceTracker: Cleaned up failed beat ${t} for ${e}`)}startMovementTiming(e,t,n){const s=`${e}-${t}-${n}`,i=performance.now();return this.movementStartTimes.set(s,i),console.log(`â±ï¸ PerformanceTracker: Started timing movement ${t} for ${e}`),s}endMovementTiming(e,t,n,s){const i=`${e}-${t}-${n}`,r=this.movementStartTimes.get(i);if(!r)return console.warn(`â±ï¸ PerformanceTracker: No start time found for movement ${t} in ${e}`),null;const o=performance.now(),c=o-r,a={sequenceName:e,movementName:t,requestId:n,startTime:r,endTime:o,duration:c,beatsCount:s};return this.completedMovements.push(a),this.movementStartTimes.delete(i),this.completedMovements.length>this.maxHistorySize&&(this.completedMovements=this.completedMovements.slice(-this.maxHistorySize/2)),console.log(`â±ï¸ PerformanceTracker: Movement ${t} completed in ${c.toFixed(2)}ms`),c}cleanupFailedMovement(e,t,n){const s=`${e}-${t}-${n}`;this.movementStartTimes.delete(s),console.warn(`â±ï¸ PerformanceTracker: Cleaned up failed movement ${t} for ${e}`)}startSequenceTiming(e,t){const n=performance.now();this.sequenceTimings.set(t,{sequenceName:e,startTime:n,beatCount:0}),console.log(`â±ï¸ PerformanceTracker: Started timing sequence ${e} (${t})`)}endSequenceTiming(e){const t=this.sequenceTimings.get(e);if(!t)return console.warn(`â±ï¸ PerformanceTracker: No timing found for execution ${e}`),null;const n=performance.now(),s=n-t.startTime;return t.endTime=n,t.duration=s,console.log(`â±ï¸ PerformanceTracker: Sequence ${t.sequenceName} completed in ${s.toFixed(2)}ms`),this.sequenceTimings.delete(e),s}incrementBeatCount(e){const t=this.sequenceTimings.get(e);t&&t.beatCount++}getCurrentBeatTiming(e,t){const n=`${e}-${t}`,s=this.beatStartTimes.get(n);return s?{startTime:s,elapsed:performance.now()-s}:null}getBeatStatistics(e){const t=e?this.completedBeats.filter(o=>o.sequenceName===e):this.completedBeats;if(t.length===0)return{totalBeats:0,averageDuration:0,minDuration:0,maxDuration:0,recentBeats:[]};const n=t.map(o=>o.duration).filter(o=>o!==void 0),s=n.reduce((o,c)=>o+c,0)/n.length,i=Math.min(...n),r=Math.max(...n);return{totalBeats:t.length,averageDuration:s,minDuration:i,maxDuration:r,recentBeats:t.slice(-10)}}getMovementTimings(e){return(e?this.completedMovements.filter(n=>n.sequenceName===e):this.completedMovements).slice()}getActiveTimings(){const e=performance.now(),t=Array.from(this.beatStartTimes.entries()).map(([i,r])=>({key:i,elapsed:e-r})),n=Array.from(this.sequenceTimings.entries()).map(([i,r])=>({executionId:i,sequenceName:r.sequenceName,elapsed:e-r.startTime})),s=Array.from(this.movementStartTimes.entries()).map(([i,r])=>({key:i,elapsed:e-r}));return{activeBeats:t,activeSequences:n,activeMovements:s}}getPerformanceWarnings(e=5e3,t=3e4){const n=[],s=performance.now();for(const[i,r]of this.beatStartTimes.entries()){const o=s-r;o>e&&n.push(`Long-running beat: ${i} (${o.toFixed(0)}ms)`)}for(const[i,r]of this.sequenceTimings.entries()){const o=s-r.startTime;o>t&&n.push(`Long-running sequence: ${r.sequenceName} (${o.toFixed(0)}ms)`)}return n}reset(){this.beatStartTimes.clear(),this.sequenceTimings.clear(),this.movementStartTimes.clear(),this.completedBeats=[],this.completedMovements=[],console.log("ðŸ§¹ PerformanceTracker: All tracking data reset")}getDebugInfo(){return{activeBeats:this.beatStartTimes.size,activeSequences:this.sequenceTimings.size,completedBeatsHistory:this.completedBeats.length,beatStatistics:this.getBeatStatistics(),warnings:this.getPerformanceWarnings()}}}class Re{constructor(e){this.executedSequenceHashes=new Set,this.recentExecutions=new Map,this.config={idempotencyWindow:5e3,maxHashSetSize:1e3,strictModeThreshold:100,...e}}isDuplicateSequenceRequest(e){const t=performance.now(),n=this.recentExecutions.get(e);if(!n)return{isDuplicate:!1,timeSinceLastExecution:0,reason:"First execution of this sequence"};const s=t-n;if(s<this.config.idempotencyWindow){const r=s<this.config.strictModeThreshold;return{isDuplicate:!0,timeSinceLastExecution:s,reason:r?`React StrictMode duplicate detected (${s.toFixed(0)}ms since last)`:`Duplicate within idempotency window (${s.toFixed(0)}ms since last)`,isStrictMode:r}}return{isDuplicate:!1,timeSinceLastExecution:s,reason:`Outside idempotency window (${s.toFixed(0)}ms since last)`}}recordSequenceExecution(e){const t=performance.now();this.recentExecutions.set(e,t),this.executedSequenceHashes.add(e),this.cleanupOldExecutionRecords(),console.log(`ðŸ” DuplicationDetector: Recorded execution of sequence hash: ${e.substring(0,8)}...`)}isStrictModeDuplicate(e){const t=performance.now();if(e.timestamp&&typeof e.timestamp=="number"){const n=t-e.timestamp;if(n<this.config.strictModeThreshold)return console.warn(`ðŸ” DuplicationDetector: StrictMode duplicate detected - rapid succession (${n.toFixed(0)}ms)`),!0}return e._reactInternalFiber||e._reactInternalInstance?(console.warn("ðŸ” DuplicationDetector: StrictMode duplicate detected - React internal properties"),!0):!1}generateSequenceHash(e,t){try{const n=JSON.stringify(t,Object.keys(t).sort()),s=`${e}:${n}`;let i=0;for(let r=0;r<s.length;r++){const o=s.charCodeAt(r);i=(i<<5)-i+o,i=i&i}return i.toString(36)}catch(n){return console.warn("ðŸ” DuplicationDetector: Failed to generate hash, using fallback:",n),`${e}-${Date.now()}-${Math.random()}`}}cleanupOldExecutionRecords(){const t=performance.now()-this.config.idempotencyWindow;for(const[n,s]of this.recentExecutions.entries())s<t&&this.recentExecutions.delete(n);if(this.executedSequenceHashes.size>this.config.maxHashSetSize){const s=Array.from(this.executedSequenceHashes).slice(-this.config.maxHashSetSize/2);this.executedSequenceHashes=new Set(s),console.log(`ðŸ§¹ DuplicationDetector: Cleaned up hash set, kept ${s.length} most recent entries`)}}getStatistics(){const e=Array.from(this.recentExecutions.values());return{totalHashesTracked:this.executedSequenceHashes.size,recentExecutionsTracked:this.recentExecutions.size,oldestRecentExecution:e.length>0?Math.min(...e):null,newestRecentExecution:e.length>0?Math.max(...e):null,memoryUsageEstimate:this.estimateMemoryUsage()}}estimateMemoryUsage(){const e=this.executedSequenceHashes.size*50,t=this.recentExecutions.size*60;return e+t}updateConfig(e){this.config={...this.config,...e},console.log("ðŸ” DuplicationDetector: Configuration updated:",this.config)}getConfig(){return{...this.config}}hasBeenExecuted(e){return this.executedSequenceHashes.has(e)}getRecentExecutions(e=10){const t=performance.now();return Array.from(this.recentExecutions.entries()).map(([n,s])=>({hash:n.substring(0,8)+"...",timestamp:s,age:t-s})).sort((n,s)=>s.timestamp-n.timestamp).slice(0,e)}reset(){this.executedSequenceHashes.clear(),this.recentExecutions.clear(),console.log("ðŸ§¹ DuplicationDetector: All detection data reset")}getDebugInfo(){return{config:this.getConfig(),statistics:this.getStatistics(),recentExecutions:this.getRecentExecutions(20)}}}class Ie{constructor(e,t,n){this.beatLoggingInitialized=!1,this.eventSubscriptions=[],this.eventBus=e,this.performanceTracker=t,this.config={enableHierarchicalLogging:!0,enableEventEmission:!0,logLevel:"info",...n}}setupBeatExecutionLogging(){if(this.beatLoggingInitialized)return;if(!this.config.enableHierarchicalLogging){console.log("ðŸŽ¼ EventLogger: Hierarchical logging disabled");return}const e=this.eventBus.subscribe(d.BEAT_STARTED,n=>this.logBeatStartedHierarchical(n),this),t=this.eventBus.subscribe(d.BEAT_COMPLETED,n=>this.logBeatCompletedHierarchical(n),this);this.eventSubscriptions.push(e,t),this.beatLoggingInitialized=!0,console.log("ðŸŽ¼ EventLogger: Hierarchical beat logging initialized")}setupMovementExecutionLogging(){if(!this.config.enableHierarchicalLogging){console.log("ðŸŽ¼ EventLogger: Movement hierarchical logging disabled");return}const e=this.eventBus.subscribe(d.MOVEMENT_STARTED,s=>this.logMovementStartedHierarchical(s),this),t=this.eventBus.subscribe(d.MOVEMENT_COMPLETED,s=>this.logMovementCompletedHierarchical(s),this),n=this.eventBus.subscribe(d.MOVEMENT_FAILED,s=>this.logMovementFailedHierarchical(s),this);this.eventSubscriptions.push(e,t,n),console.log("ðŸŽ¼ EventLogger: Hierarchical movement logging initialized")}logBeatStartedHierarchical(e){this.performanceTracker.startBeatTiming(e.sequenceName,e.beat);const t=this.getMovementNameForBeat(e.sequenceName,e.beat),n=`ðŸŽµ Beat ${e.beat} Started: ${e.title||e.event} (${e.event})`;console.group(n),console.log(`%cðŸŽ¼ Sequence: ${e.sequenceName}`,"color: #007BFF; font-weight: bold;"),console.log(`%cðŸŽµ Movement: ${t}`,"color: #6F42C1; font-weight: bold;"),console.log(`%cðŸ“Š Beat: ${e.beat}`,"color: #FD7E14; font-weight: bold;"),console.log(`%cðŸŽ¯ Event: ${e.event}`,"color: #20C997; font-weight: bold;"),console.log({sequence:e.sequenceName,movement:t,beat:e.beat,type:e.sequenceType||"UNKNOWN",timing:e.timing||"immediate",dynamics:e.dynamics||"mf"})}logBeatCompletedHierarchical(e){const t=this.performanceTracker.endBeatTiming(e.sequenceName,e.beat);console.log(t!==null?`%câœ… Completed in ${t.toFixed(2)}ms`:"%câœ… Completed","color: #28A745; font-weight: bold;"),console.groupEnd()}logMovementStartedHierarchical(e){const t=`ðŸŽµ Movement Started: ${e.movementName} (${e.beatsCount} beats)`;console.group(t),console.log(`%cðŸŽ¼ Sequence: ${e.sequenceName}`,"color: #007BFF; font-weight: bold;"),console.log(`%cðŸ†” Request ID: ${e.requestId}`,"color: #6C757D; font-weight: normal;"),console.log(`%cðŸ¥ Beats Count: ${e.beatsCount}`,"color: #17A2B8; font-weight: bold;")}logMovementCompletedHierarchical(e){e.duration!==null&&e.duration!==void 0?console.log(`%câœ… Movement completed in ${e.duration.toFixed(2)}ms`,"color: #28A745; font-weight: bold;"):console.log("%câœ… Movement completed","color: #28A745; font-weight: bold;"),console.log(`%cðŸ¥ Beats executed: ${e.beatsExecuted}`,"color: #17A2B8; font-weight: normal;"),console.groupEnd()}logMovementFailedHierarchical(e){console.log(`%câŒ Movement failed: ${e.error}`,"color: #DC3545; font-weight: bold;"),console.groupEnd()}getMovementNameForBeat(e,t){return`Movement ${Math.ceil(t/4)}`}handleBeatError(e,t,n){this.emitEvent(d.BEAT_FAILED,{sequenceName:e.sequenceName,beat:t.beat,error:n.message,success:!1}),this.config.enableHierarchicalLogging&&(console.log(`%câŒ Error: ${n.message}`,"color: #DC3545; font-weight: bold;"),console.groupEnd(),this.performanceTracker.cleanupFailedBeat(e.sequenceName,t.beat))}emitEvent(e,t){if(this.config.enableEventEmission)try{this.eventBus.emit(e,t),this.config.logLevel==="debug"&&console.log(`ðŸŽ¼ EventLogger: Emitted ${e}`,t)}catch(n){console.error(`ðŸŽ¼ EventLogger: Failed to emit event ${e}:`,n)}}logSequenceStart(e,t,n){(this.config.logLevel==="debug"||this.config.logLevel==="info")&&console.log(`ðŸŽ¼ EventLogger: Starting sequence ${e} (${t})`,n),this.emitEvent(d.SEQUENCE_STARTED,{sequenceName:e,executionId:t,data:n,timestamp:Date.now()})}logSequenceComplete(e,t,n,s){const i=n?"âœ… completed":"âŒ failed",r=s?` in ${s.toFixed(2)}ms`:"";(this.config.logLevel==="debug"||this.config.logLevel==="info")&&console.log(`ðŸŽ¼ EventLogger: Sequence ${e} ${i}${r}`),this.emitEvent(d.SEQUENCE_COMPLETED,{sequenceName:e,executionId:t,success:n,duration:s,timestamp:Date.now()})}logQueueOperation(e,t,n){this.config.logLevel==="debug"&&console.log(`ðŸŽ¼ EventLogger: Queue ${e} - ${t} (queue: ${n})`),this.emitEvent(d.QUEUE_PROCESSED,{operation:e,sequenceName:t,queueLength:n,timestamp:Date.now()})}updateConfig(e){this.config={...this.config,...e},console.log("ðŸŽ¼ EventLogger: Configuration updated:",this.config)}getConfig(){return{...this.config}}cleanup(){this.eventSubscriptions.length>0&&(this.eventSubscriptions.forEach(e=>e()),this.eventSubscriptions=[],this.beatLoggingInitialized=!1,console.log("ðŸ§¹ EventLogger: Event subscriptions cleaned up"))}getDebugInfo(){return{config:this.getConfig(),beatLoggingInitialized:this.beatLoggingInitialized,activeSubscriptions:this.eventSubscriptions.length}}}class Te{constructor(e){this.duplicationDetector=e}generateSequenceHash(e,t,n){try{const s=this.normalizeDataForHashing(t),i=JSON.stringify(s,Object.keys(s).sort()),r=`${e}:${n}:${i}`;let o=0;for(let c=0;c<r.length;c++){const a=r.charCodeAt(c);o=(o<<5)-o+a,o=o&o}return o.toString(36)}catch(s){return console.warn("ðŸ” SequenceValidator: Failed to generate hash, using fallback:",s),`${e}-${n}-${Date.now()}-${Math.random()}`}}normalizeDataForHashing(e){if(!e||typeof e!="object")return e;const t={...e};return delete t.timestamp,delete t._reactInternalFiber,delete t._reactInternalInstance,delete t.__reactInternalInstance,Object.keys(t).forEach(n=>{Array.isArray(t[n])&&(t[n]=[...t[n]].sort())}),t}deduplicateSequenceRequest(e,t,n,s){const i=this.generateSequenceHash(t,n,s);if(t==="Element Library Display Symphony No. 12"){if(this.duplicationDetector.isDuplicateSequenceRequest(i).isDuplicate){const c=this.duplicationDetector.isDuplicateSequenceRequest(i);return console.log(`ðŸŽ¼ SequenceValidator: ElementLibrary Display duplicate check - ${c.reason}`),console.log("ðŸŽ¼ SequenceValidator: Allowing ElementLibrary Display sequence to execute (special handling)"),{isDuplicate:!1,hash:i,reason:"ElementLibrary Display sequence - special handling",shouldExecute:!0}}return{isDuplicate:!1,hash:i,reason:"ElementLibrary Display sequence - first execution",shouldExecute:!0}}const r=this.duplicationDetector.isDuplicateSequenceRequest(i);return r.isDuplicate?{isDuplicate:!0,hash:i,reason:r.reason,shouldExecute:!1}:{isDuplicate:!1,hash:i,reason:"New sequence request",shouldExecute:!0}}isStrictModeDuplicate(e){return this.duplicationDetector.isStrictModeDuplicate(e)}validateSequenceRequest(e,t,n){const s=[],i=[];if(!e||typeof e!="string"?s.push("Sequence name must be a non-empty string"):e.trim().length===0&&s.push("Sequence name cannot be empty or whitespace only"),Object.values(f).includes(n)||s.push(`Invalid priority: ${n}. Must be one of: ${Object.values(f).join(", ")}`),t!=null&&typeof t=="object"){this.isStrictModeDuplicate(t)&&i.push("Potential React StrictMode duplicate detected");try{JSON.stringify(t)}catch{s.push("Sequence data contains circular references")}JSON.stringify(t).length>1e5&&i.push("Sequence data is very large (>100KB), consider optimizing")}return e&&!this.isValidSequenceNameFormat(e)&&i.push("Sequence name format may not follow recommended conventions"),{isValid:s.length===0,errors:s,warnings:i}}isValidSequenceNameFormat(e){return[/^.+\s+Symphony\s+No\.\s+\d+$/i,/^.+\s+Sequence\s+\d+$/i,/^.+\s+Movement\s+\d+$/i,/^[A-Za-z0-9\s\-_.]+$/].some(n=>n.test(e))}getValidationStatistics(){return{totalValidations:0,validSequences:0,invalidSequences:0,duplicatesDetected:0,strictModeDuplicates:0}}reset(){console.log("ðŸ§¹ SequenceValidator: Validation state reset")}getDebugInfo(){return{validationStatistics:this.getValidationStatistics(),duplicationDetectorInfo:this.duplicationDetector.getDebugInfo()}}}class k{createSequenceInstanceId(e,t,n){const s=Date.now(),i=Math.random().toString(36).substr(2,9),r=this.getPriorityCode(n);return`${k.INSTANCE_ID_PREFIX}_${r}_${s}_${i}`}getPriorityCode(e){switch(e){case"HIGH":return"HI";case"NORMAL":return"NOR";case"CHAINED":return"CH";default:return"UNK"}}extractSymphonyName(e){const t=e.split(".");return t.length>=2?t[0].trim():"Default Symphony"}extractResourceId(e,t){return t?.resourceId?t.resourceId:t?.componentId?`component_${t.componentId}`:t?.elementId?`element_${t.elementId}`:t?.canvasId?`canvas_${t.canvasId}`:`symphony_${this.extractSymphonyName(e).toLowerCase().replace(/\s+/g,"_")}`}getMovementNameForBeat(e,t){const s=Math.ceil(t/4);return{name:this.generateMovementName(e,s),number:s,description:`Movement ${s} of ${e}`}}generateMovementName(e,t){return e.includes("Display")?`Display Movement ${t}`:e.includes("Animation")?`Animation Movement ${t}`:e.includes("Interaction")?`Interaction Movement ${t}`:e.includes("Data")?`Data Movement ${t}`:`Movement ${t}`}createExecutionContext(e){return{id:this.extractSequenceInstanceInfo(e.sequenceName,e.data,e.priority).instanceId,sequenceId:e.sequenceId,sequenceName:e.sequenceName,sequence:{},data:e.data,payload:{},startTime:Date.now(),currentMovement:1,currentBeat:0,completedBeats:[],errors:[],executionType:this.determineExecutionType(e),priority:e.priority}}extractSequenceInstanceInfo(e,t,n){return{instanceId:this.createSequenceInstanceId(e,t,n),symphonyName:this.extractSymphonyName(e),resourceId:this.extractResourceId(e,t)}}determineExecutionType(e){return e.priority==="HIGH"?"IMMEDIATE":"CONSECUTIVE"}isAuthorizedSubscriber(e){if(e?.isReactComponent)return!0;const t=["MusicalConductor","SequenceExecutor","EventLogger","StatisticsManager","PerformanceTracker"];return e?.componentName&&t.includes(e.componentName)||e?.authToken&&this.validateAuthToken(e.authToken),!0}validateAuthToken(e){return e.startsWith("conductor_")&&e.length>20}parseSequenceName(e){const t=e.match(/^(.+?)\s+(?:Symphony|Sequence|Movement)\s+No\.\s+(\d+)$/i);if(t)return{symphony:t[1].trim(),number:parseInt(t[2],10),type:"numbered"};const n=e.match(/^(.+?)\s+(.+?)\s+Movement\s+(\d+)$/i);return n?{symphony:n[1].trim(),movement:n[2].trim(),number:parseInt(n[3],10),type:"movement"}:{symphony:this.extractSymphonyName(e),type:"simple"}}generateSequenceHash(e,t){const n={name:e,resourceId:this.extractResourceId(e,t),symphonyName:this.extractSymphonyName(e)},s=JSON.stringify(n);let i=0;for(let r=0;r<s.length;r++){const o=s.charCodeAt(r);i=(i<<5)-i+o,i=i&i}return`${k.SEQUENCE_ID_PREFIX}_${Math.abs(i).toString(36)}`}getDebugInfo(){return{generatedIds:0,parsedSequences:0,authorizedSubscribers:0}}}k.SEQUENCE_ID_PREFIX="seq";k.INSTANCE_ID_PREFIX="inst";class De{constructor(e,t,n,s,i,r,o,c){this.eventBus=e,this.sequenceRegistry=t,this.executionQueue=n,this.sequenceExecutor=s,this.statisticsManager=i,this.sequenceValidator=r,this.sequenceUtilities=o,this.resourceDelegator=c}startSequence(e,t={},n=f.NORMAL){const s=this.generateRequestId(e);try{const i=this.sequenceRegistry.get(e);if(!i)throw this.logSequenceNotFound(e),new Error(`Sequence with ID "${e}" not found`);const r=this.sequenceValidator.deduplicateSequenceRequest(e,i.name,t,n);if(r.isDuplicate)return this.handleDuplicateSequence(e,i.name,r);this.recordSequenceExecution(r.hash);const o=this.extractOrchestrationMetadata(e,i.name,t),c=this.checkResourceConflicts(o,n);if(c.resolution==="REJECT")throw console.warn(`ðŸŽ¼ SequenceOrchestrator: Sequence request rejected - ${c.message}`),new Error(`Resource conflict: ${c.message}`);const a=this.createSequenceRequest(e,i.name,t,n,s,o,c,r.hash);return this.statisticsManager.recordSequenceQueued(),this.executionQueue.enqueue(a),this.processQueueIfIdle(),this.emitSequenceQueuedEvent(e,i.name,s,n),console.log(`ðŸŽ¼ SequenceOrchestrator: Sequence "${i.name}" (id: ${e}) queued successfully`),{requestId:s,success:!0}}catch(i){return console.error(`ðŸŽ¼ SequenceOrchestrator: Failed to start sequence: ${e}`,i),this.statisticsManager.recordError(),{requestId:s,success:!1,reason:i.message}}}async processSequenceQueue(){if(this.executionQueue.isEmpty()||this.sequenceExecutor.isSequenceRunning())return{processed:!1};const e=this.executionQueue.dequeue();if(!e)return{processed:!1};const t=performance.now()-e.queuedAt;this.statisticsManager.updateQueueWaitTime(t);const n=this.sequenceRegistry.get(e.sequenceId);if(!n)return console.error(`âŒ SequenceOrchestrator: Sequence ${e.sequenceId} not found in registry`),this.processSequenceQueue(),{processed:!0,sequenceName:e.sequenceName,success:!1,error:"Sequence not found in registry"};try{return this.statisticsManager.recordSequenceDequeued(),this.statisticsManager.recordSequenceExecution(0),await this.sequenceExecutor.executeSequence(e,n),this.processSequenceQueue(),{processed:!0,sequenceName:e.sequenceName,success:!0}}catch(s){return console.error(`âŒ SequenceOrchestrator: Failed to execute sequence ${e.sequenceName}:`,s),this.processSequenceQueue(),{processed:!0,sequenceName:e.sequenceName,success:!1,error:s.message}}}createExecutionContext(e){const t=this.sequenceUtilities.createExecutionContext(e),n=this.sequenceRegistry.get(e.sequenceId);if(!n)throw new Error(`Sequence ${e.sequenceId} not found`);return{...t,sequence:n,executionType:e.priority==="HIGH"?"IMMEDIATE":"CONSECUTIVE",priority:e.priority}}generateRequestId(e){return`${e}-${Date.now()}-${Math.random().toString(36).substr(2,9)}`}logSequenceNotFound(e,t){console.error(`âŒ SequenceOrchestrator: Sequence with ID "${e}" not found!`),t&&console.error(`âŒ Sequence name: "${t}"`),console.error("âŒ This means the plugin for this sequence is not loaded or registered."),console.error("âŒ Available sequences:",this.sequenceRegistry.getNames()),(e==="ElementLibrary.library-drop-symphony"||t==="ElementLibrary.library-drop-symphony")&&(console.error("âŒ CRITICAL: ElementLibrary.library-drop-symphony not available - drag-and-drop will not work!"),console.error("âŒ Check plugin loading logs above for ElementLibrary.library-drop-symphony errors."))}handleDuplicateSequence(e,t,n){console.warn(`ðŸŽ¼ SequenceOrchestrator: ${n.reason}`);const s=`${e}-duplicate-${Date.now()}-${Math.random().toString(36).substr(2,9)}`;return this.eventBus.emit(d.SEQUENCE_CANCELLED,{sequenceId:e,sequenceName:t,requestId:s,reason:"duplicate-request",hash:n.hash}),{requestId:s,success:!1,isDuplicate:!0,reason:n.reason}}extractOrchestrationMetadata(e,t,n){return{symphonyName:this.sequenceUtilities.extractSymphonyName(t),resourceId:this.sequenceUtilities.extractResourceId(t,n),instanceId:this.sequenceUtilities.createSequenceInstanceId(t,n,"NORMAL")}}checkResourceConflicts(e,t){const n=this.resourceDelegator.checkResourceConflict(e.resourceId,e.instanceId,t);return{hasConflict:n.hasConflict,conflictType:n.hasConflict?"SAME_RESOURCE":"NONE",resolution:n.resolution==="override"?"ALLOW":n.resolution==="reject"?"REJECT":n.resolution==="queue"?"QUEUE":"ALLOW",message:n.reason||"No conflict detected"}}createSequenceRequest(e,t,n,s,i,r,o,c){return{sequenceId:e,sequenceName:t,data:{...n,instanceId:r.instanceId,symphonyName:r.symphonyName,resourceId:r.resourceId,conflictResult:o,sequenceHash:c},priority:s,requestId:i,queuedAt:performance.now()}}recordSequenceExecution(e){console.log(`ðŸŽ¼ SequenceOrchestrator: Recording sequence execution: ${e}`)}processQueueIfIdle(){this.sequenceExecutor.isSequenceRunning()||this.processSequenceQueue()}emitSequenceQueuedEvent(e,t,n,s){this.eventBus.emit(d.SEQUENCE_QUEUED,{sequenceId:e,sequenceName:t,requestId:n,priority:s,queueLength:this.executionQueue.size()})}getDebugInfo(){return{queueSize:this.executionQueue.size(),isExecuting:this.sequenceExecutor.isSequenceRunning(),currentSequence:this.sequenceExecutor.getCurrentSequence()?.sequenceName||null,processedSequences:0}}}class xe{constructor(e){this.debugMode=!1,this.eventBus=e}emitEvent(e,t,n){try{const s=this.createContextualEventData(t,n);this.handleSpecialEventDebugging(e,s);const i=this.eventBus.getSubscriberCount(e);return this.eventBus.emit(e,s),this.debugMode&&console.log(`ðŸŽ¼ EventOrchestrator: Emitted ${e} to ${i} subscribers`),{success:!0,eventType:e,subscriberCount:i}}catch(s){return console.error(`ðŸŽ¼ EventOrchestrator: Failed to emit event ${e}:`,s),{success:!1,eventType:e,subscriberCount:0,error:s.message}}}emitSimpleEvent(e,t){try{const n=this.eventBus.getSubscriberCount(e);return this.eventBus.emit(e,t),this.debugMode&&console.log(`ðŸŽ¼ EventOrchestrator: Emitted simple event ${e} to ${n} subscribers`),{success:!0,eventType:e,subscriberCount:n}}catch(n){return console.error(`ðŸŽ¼ EventOrchestrator: Failed to emit simple event ${e}:`,n),{success:!1,eventType:e,subscriberCount:0,error:n.message}}}createContextualEventData(e,t){return{...e,context:{payload:t.payload,executionId:t.id,sequenceName:t.sequenceName},metadata:{timestamp:Date.now(),beat:t.currentBeat,movement:t.currentMovement}}}handleSpecialEventDebugging(e,t){e.includes("sequence")&&this.debugMode&&console.log(`ðŸ” DEBUG: EventOrchestrator emitting sequence event: ${e}`,{sequenceName:t.context.sequenceName,executionId:t.context.executionId,beat:t.metadata.beat}),e.includes("beat")&&this.debugMode&&console.log(`ðŸ” DEBUG: EventOrchestrator emitting beat event: ${e}`,{beat:t.metadata.beat,movement:t.metadata.movement,sequenceName:t.context.sequenceName})}getSubscriberCount(e){return this.eventBus.getSubscriberCount(e)}hasSubscribers(e){return this.getSubscriberCount(e)>0}setDebugMode(e){this.debugMode=e,console.log(`ðŸŽ¼ EventOrchestrator: Debug mode ${e?"enabled":"disabled"}`)}getActiveEventTypes(){return[]}emitMultipleEvents(e,t){const n=[];for(const s of e){const i=this.emitEvent(s.eventType,s.data,t);if(n.push(i),!i.success){console.warn(`ðŸŽ¼ EventOrchestrator: Stopping multiple event emission due to failure: ${i.error}`);break}}return n}emitEventWithRetry(e,t,n,s=3){let i;for(let r=1;r<=s;r++){if(i=this.emitEvent(e,t,n),i.success)return r>1&&console.log(`ðŸŽ¼ EventOrchestrator: Event ${e} succeeded on attempt ${r}`),i;r<s&&(console.warn(`ðŸŽ¼ EventOrchestrator: Event ${e} failed on attempt ${r}, retrying...`),setTimeout(()=>{},10))}return console.error(`ðŸŽ¼ EventOrchestrator: Event ${e} failed after ${s} attempts`),i}getDebugInfo(){return{debugMode:this.debugMode,totalEventTypes:this.getActiveEventTypes().length,activeEventTypes:this.getActiveEventTypes(),eventBusAvailable:!!this.eventBus}}}class Ae{constructor(e,t,n,s,i,r,o){this.sequenceOrchestrator=e,this.sequenceExecutor=t,this.executionQueue=n,this.statisticsManager=s,this.pluginInterface=i,this.sequenceRegistry=r,this.eventBus=o}queueSequence(e,t={},n=f.NORMAL){const s=this.sequenceOrchestrator.startSequence(e,t,n);if(!s.success){if(s.isDuplicate)return s.requestId;throw new Error(s.reason||"Failed to queue sequence")}return s.requestId}executeNextSequence(){return this.executionQueue.isEmpty()||this.sequenceExecutor.isSequenceRunning()?!1:(this.sequenceOrchestrator.processSequenceQueue(),!0)}isSequenceRunning(e){return this.sequenceExecutor.isSequenceRunning(e)}getCurrentSequence(){return this.sequenceExecutor.getCurrentSequence()}getQueuedSequences(){return this.executionQueue.getQueuedRequests().map(e=>e.sequenceName)}clearSequenceQueue(){const e=this.executionQueue.size();return this.executionQueue.clear(),console.log(`ðŸŽ¼ ConductorAPI: Cleared ${e} sequences from queue`),e}getQueueStatus(){const e=this.executionQueue.peek();return{size:this.executionQueue.size(),isEmpty:this.executionQueue.isEmpty(),isProcessing:this.sequenceExecutor.isSequenceRunning(),nextSequence:e?.sequenceName}}getStatistics(){return this.statisticsManager.getEnhancedStatistics(this.pluginInterface.getMountedPluginIds().length)}getStatus(){return{statistics:this.getStatistics(),eventBus:!!this.eventBus,sequences:this.sequenceRegistry.getNames().length,plugins:this.pluginInterface.getMountedPluginIds().length}}resetStatistics(){this.statisticsManager.reset(),console.log("ðŸŽ¼ ConductorAPI: Statistics reset")}updateDataBaton(e){const t=this.sequenceExecutor.getCurrentSequence();if(!t)return console.warn("ðŸŽ½ ConductorAPI: No active sequence to update data baton"),!1;try{return Object.assign(t.payload,e),console.log(`ðŸŽ½ ConductorAPI: Updated data baton for sequence ${t.sequenceName}`,e),!0}catch(n){return console.error("ðŸŽ½ ConductorAPI: Failed to update data baton:",n),!1}}getDataBaton(){const e=this.sequenceExecutor.getCurrentSequence();return e?{...e.payload}:null}clearDataBaton(){const e=this.sequenceExecutor.getCurrentSequence();if(!e)return console.warn("ðŸŽ½ ConductorAPI: No active sequence to clear data baton"),!1;try{return e.payload={},console.log(`ðŸŽ½ ConductorAPI: Cleared data baton for sequence ${e.sequenceName}`),!0}catch(t){return console.error("ðŸŽ½ ConductorAPI: Failed to clear data baton:",t),!1}}getRegisteredSequences(){return this.sequenceRegistry.getNames()}isSequenceRegistered(e){return this.sequenceRegistry.has(e)}isSequenceRegisteredByName(e){return this.sequenceRegistry.findByName(e)!==void 0}getMountedPlugins(){return this.pluginInterface.getMountedPluginIds()}isPluginMounted(e){return this.pluginInterface.getMountedPluginIds().includes(e)}getDebugInfo(){return{api:{queueStatus:this.getQueueStatus(),statistics:this.getStatistics(),registeredSequences:this.getRegisteredSequences(),mountedPlugins:this.getMountedPlugins()},orchestration:this.sequenceOrchestrator.getDebugInfo()}}}class Be{constructor(e){this.strictModePatterns=new Set(["double-render","strict-mode","development-only","react-strict","duplicate-effect","double-execution"]),this.duplicationDetector=e}checkForDuplication(e,t,n){const s=this.generateSequenceHash(e,t,n);if(!this.duplicationDetector.isDuplicateSequenceRequest(s))return{isDuplicate:!1,hash:s};const r=this.isStrictModeDuplicate(t);return{isDuplicate:!0,hash:s,reason:r.isStrictModeDuplicate?`StrictMode duplicate detected: ${r.patterns.join(", ")}`:"Duplicate sequence request detected",isStrictMode:r.isStrictModeDuplicate}}recordSequenceExecution(e){this.duplicationDetector.recordSequenceExecution(e),console.log(`ðŸŽ¼ StrictModeManager: Recorded sequence execution: ${e.substring(0,8)}...`)}isStrictModeDuplicate(e){const t=[],n=JSON.stringify(e).toLowerCase();for(const i of this.strictModePatterns)n.includes(i)&&t.push(i);this.hasReactDevModeIndicators(e)&&t.push("react-dev-mode"),this.hasDoubleExecutionPatterns(e)&&t.push("double-execution-pattern"),this.hasTimingBasedDuplicatePattern(e)&&t.push("timing-duplicate");const s=t.length>0;return{isStrictModeDuplicate:s,patterns:t,reason:s?`StrictMode patterns detected: ${t.join(", ")}`:void 0}}generateSequenceHash(e,t,n){const s=this.sortObjectKeys(t),i=`${e}:${JSON.stringify(s)}:${n}`;let r=0;for(let o=0;o<i.length;o++){const c=i.charCodeAt(o);r=(r<<5)-r+c,r=r&r}return Math.abs(r).toString(36)}sortObjectKeys(e){if(e===null||typeof e!="object")return e;if(Array.isArray(e))return e.map(s=>this.sortObjectKeys(s));const t={},n=Object.keys(e).sort();for(const s of n)t[s]=this.sortObjectKeys(e[s]);return t}hasReactDevModeIndicators(e){const t=["__reactInternalInstance","_reactInternalFiber","__reactInternalMemoizedUnmaskedChildContext","NODE_ENV"],n=JSON.stringify(e);return t.some(s=>n.includes(s))}hasDoubleExecutionPatterns(e){return!!(e.executionCount&&e.executionCount>1||e.renderCount&&e.renderCount>1||e.effectCount&&e.effectCount>1)}hasTimingBasedDuplicatePattern(e){if(!e.timestamp)return!1;const t=Date.now(),n=typeof e.timestamp=="number"?e.timestamp:parseInt(e.timestamp);return Math.abs(t-n)<10}addStrictModePattern(e){this.strictModePatterns.add(e.toLowerCase()),console.log(`ðŸŽ¼ StrictModeManager: Added StrictMode pattern: ${e}`)}removeStrictModePattern(e){this.strictModePatterns.delete(e.toLowerCase()),console.log(`ðŸŽ¼ StrictModeManager: Removed StrictMode pattern: ${e}`)}getStrictModePatterns(){return Array.from(this.strictModePatterns)}clearExecutionHistory(){this.duplicationDetector.reset(),console.log("ðŸŽ¼ StrictModeManager: Cleared execution history")}getStrictModeStatistics(){return{totalPatterns:this.strictModePatterns.size,patterns:this.getStrictModePatterns(),detectionEnabled:!0}}setStrictModeDetection(e){if(e){const t=["double-render","strict-mode","development-only","react-strict","duplicate-effect","double-execution"];for(const n of t)this.strictModePatterns.add(n)}else this.strictModePatterns.clear();console.log(`ðŸŽ¼ StrictModeManager: StrictMode detection ${e?"enabled":"disabled"}`)}getDebugInfo(){return{strictModePatterns:this.getStrictModePatterns(),totalPatterns:this.strictModePatterns.size,detectionEnabled:this.strictModePatterns.size>0,duplicationDetectorStats:{recordedExecutions:0}}}}class Oe{constructor(e,t,n){this.resourceManager=e,this.resourceDelegator=t,this.sequenceUtilities=n}createSequenceInstanceId(e,t){return this.sequenceUtilities.createSequenceInstanceId(e,{instanceId:t},"NORMAL")}extractSymphonyName(e){return this.sequenceUtilities.extractSymphonyName(e)}extractResourceId(e,t){return this.sequenceUtilities.extractResourceId(e,t)}checkResourceConflict(e,t,n,s){const i=this.resourceDelegator.checkResourceConflict(e,s,n);return{hasConflict:i.hasConflict,conflictType:i.hasConflict?"SAME_RESOURCE":"NONE",resolution:i.resolution==="override"?"ALLOW":i.resolution==="reject"?"REJECT":i.resolution==="queue"?"QUEUE":"ALLOW",message:i.reason||"No conflict detected"}}acquireResourceOwnership(e,t,n,s){this.resourceDelegator.acquireResourceOwnership(e,s)}releaseResourceOwnership(e,t){this.resourceDelegator.releaseResourceOwnership(e,t||"unknown")}getResourceOwnership(){return this.resourceManager.getResourceOwnership()}getSymphonyResourceMap(){return this.resourceManager.getSymphonyResourceMap()}resolveResourceConflictAdvanced(e,t,n,s,i,r){return this.resourceManager.resolveResourceConflictAdvanced(e,t,n,s,i,r)}getResourceDiagnostics(){return{ownership:this.getResourceOwnership(),symphonyResourceMap:this.getSymphonyResourceMap(),activeConflicts:0,resolvedConflicts:0}}clearAllResourceOwnership(){console.log("ðŸŽ¼ ResourceConflictManager: Clearing all resource ownership")}getConflictStatistics(){return{totalConflicts:0,resolvedConflicts:0,activeConflicts:0,conflictResolutionStrategies:{ALLOW:0,REJECT:0,QUEUE:0,INTERRUPT:0}}}isResourceOwned(e){return this.getResourceOwnership().has(e)}getResourceOwner(e){return this.getResourceOwnership().get(e)||null}getResourcesOwnedBySequence(e){const t=this.getResourceOwnership(),n=[];for(const[s,i]of t.entries())i.sequenceExecutionId===e&&n.push(s);return n}getDebugInfo(){return{resourceManager:!!this.resourceManager,resourceDelegator:!!this.resourceDelegator,sequenceUtilities:!!this.sequenceUtilities,diagnostics:this.getResourceDiagnostics(),statistics:this.getConflictStatistics()}}}let Y={version:"unknown"};try{Y=require("../../../package.json")}catch{}class q{get eventBus(){return this.conductorCore.getEventBus()}get sequences(){return this.sequenceRegistry.getSequenceMap()}constructor(e){this.requestCorrelationMap=new Map,this.correlationActiveCounts=new Map,this.eventUnsubscribes=[],this.conductorCore=$.getInstance(e),this.sequenceRegistry=new ae(e),this.eventSubscriptionManager=new ue(e,this.conductorCore.getSPAValidator()),this.sequenceRegistry.setEventSubscriptionManager(this.eventSubscriptionManager),this.executionQueue=new le,this.statisticsManager=new $e,this.performanceTracker=new Ce,this.duplicationDetector=new Re,this.eventLogger=new Ie(e,this.performanceTracker),this.eventLogger.setupBeatExecutionLogging(),this.eventLogger.setupMovementExecutionLogging(),this.sequenceValidator=new Te(this.duplicationDetector),this.sequenceUtilities=new k,this.sequenceExecutor=new ge(e,this.conductorCore.getSPAValidator(),this.executionQueue,this.statisticsManager,this.performanceTracker),this.pluginManager=new ve(e,this.conductorCore.getSPAValidator(),this.sequenceRegistry),this.pluginInterface=new Se(this.pluginManager,this.conductorCore.getSPAValidator()),this.resourceManager=new we,this.resourceDelegator=new Me(this.resourceManager),this.sequenceOrchestrator=new De(e,this.sequenceRegistry,this.executionQueue,this.sequenceExecutor,this.statisticsManager,this.sequenceValidator,this.sequenceUtilities,this.resourceDelegator),this.eventOrchestrator=new xe(e),this.conductorAPI=new Ae(this.sequenceOrchestrator,this.sequenceExecutor,this.executionQueue,this.statisticsManager,this.pluginInterface,this.sequenceRegistry,e),this.strictModeManager=new Be(this.duplicationDetector),this.resourceConflictManager=new Oe(this.resourceManager,this.resourceDelegator,this.sequenceUtilities);try{const t=Y?.version||"unknown";console.log(`ðŸŽ¼ MusicalConductor v${t}: Initialized with core components`)}catch{console.log("ðŸŽ¼ MusicalConductor: Initialized with core components")}}static getInstance(e){if(q.instance)e&&q.instance.eventBus!==e&&console.warn("ðŸŽ¼ MusicalConductor: Attempting to change eventBus on existing singleton instance - ignoring");else{if(!e)throw new Error("EventBus is required for first initialization of Musical Conductor");q.instance=new q(e)}return q.instance}static resetInstance(){q.instance&&$.resetInstance(),q.instance=null,console.log("ðŸ”„ MusicalConductor: Singleton instance reset")}handleBeatError(e,t,n){this.eventLogger.handleBeatError(e,t,n)}registerSequence(e){this.sequenceRegistry.register(e)}unregisterSequence(e){this.sequenceRegistry.unregister(e)}getSequence(e){return this.sequenceRegistry.get(e)}getSequenceByName(e){return this.sequenceRegistry.findByName(e)}getSequenceNames(){return this.sequenceRegistry.getNames()}getRegisteredSequences(){return this.sequenceRegistry.getAll()}getMountedPlugins(){return this.pluginInterface.getMountedPlugins()}play(e,t,n={},s=f.NORMAL){try{const i=R.getInstance(),{correlationId:r,count:o}=i.preserveInPlace(n);o>0&&console.log(`ðŸŽ¼ MusicalConductor.play: preserved ${o} callback(s) for correlationId=${r}`)}catch(i){console.warn("âš ï¸ MusicalConductor.play: callback preservation skipped:",i?.message||i)}return this.pluginInterface.play(e,t,n,s,async(i,r,o)=>{const c=await this.startSequence(i,r,o);try{const a=(await O(()=>Promise.resolve().then(()=>ye),void 0)).__internal.CORRELATION_KEY,u=r?.[a];if(typeof u=="string"){this.requestCorrelationMap.set(c,u);const h=this.correlationActiveCounts.get(u)||0;this.correlationActiveCounts.set(u,h+1)}this.eventUnsubscribes.length===0&&this.installCorrelationCleanupListeners()}catch{}return c})}subscribe(e,t,n){return this.eventSubscriptionManager.subscribe(e,t,n)}on(e,t,n){return this.subscribe(e,t,n)}unsubscribe(e,t){this.eventSubscriptionManager.unsubscribe(e,t)}off(e,t){this.unsubscribe(e,t)}async mount(e,t,n,s){return this.pluginInterface.mount(e,t,n,s)}async registerCIAPlugins(){return this.pluginInterface.registerCIAPlugins()}executeMovementHandler(e,t,n){return this.pluginInterface.executeMovementWithHandler(e,t,n)}async loadPlugin(e){return this.pluginInterface.loadPlugin(e)}unmountPlugin(e){return this.pluginInterface.unmountPlugin(e)}getPluginInfo(e){return this.pluginInterface.getPluginInfo(e)}getMountedPluginIds(){return this.pluginInterface.getMountedPluginIds()}setPriority(e,t){console.log(`ðŸŽ¼ MusicalConductor: Set priority for ${e}: ${t}`)}async startSequence(e,t={},n=f.NORMAL){let s=e;if(!this.sequenceRegistry.has(s)){const r=this.sequenceRegistry.findByName(e);r&&(s=r.id)}const i=this.sequenceOrchestrator.startSequence(s,t,n);if(!i.success){if(i.isDuplicate)return i.requestId;const r=i.reason||"Failed to start sequence";throw/not found/i.test(r)?new Error("Sequence not found"):new Error(r)}return i.requestId}createExecutionContext(e){return this.sequenceOrchestrator.createExecutionContext(e)}getStatistics(){return this.conductorAPI.getStatistics()}getStatus(){return this.conductorAPI.getStatus()}resetStatistics(){this.conductorAPI.resetStatistics(),this.performanceTracker.reset(),this.duplicationDetector.reset(),console.log("ðŸŽ¼ MusicalConductor: All monitoring data reset")}getQueueStatus(){return this.executionQueue.getStatus()}emitEvent(e,t,n){const s=this.eventOrchestrator.emitEvent(e,t,n);if(!s.success)throw new Error(s.error||"Failed to emit event")}queueSequence(e,t={},n=f.NORMAL){return this.conductorAPI.queueSequence(e,t,n)}executeNextSequence(){return this.conductorAPI.executeNextSequence()}isSequenceRunning(e){return this.conductorAPI.isSequenceRunning(e)}getCurrentSequence(){return this.conductorAPI.getCurrentSequence()}updatePayload(e){return this.conductorAPI.updateDataBaton(e)}getPayload(){return this.conductorAPI.getDataBaton()}getQueuedSequences(){return this.conductorAPI.getQueuedSequences()}installCorrelationCleanupListeners(){const e=this.eventBus,t=R.getInstance(),n=s=>{try{const i=s?.requestId,r=i?this.requestCorrelationMap.get(i):void 0;if(typeof r=="string"){const o=(this.correlationActiveCounts.get(r)||1)-1;o<=0?(t.cleanup(r),this.correlationActiveCounts.delete(r),console.log(`ðŸŽ¼ MusicalConductor: cleaned callbacks for correlationId=${r}`)):this.correlationActiveCounts.set(r,o),this.requestCorrelationMap.delete(i)}}catch{}};this.eventUnsubscribes.push(e.subscribe("sequence-completed",n),e.subscribe("sequence-failed",n),e.subscribe("sequence-cancelled",n))}clearSequenceQueue(){return this.conductorAPI.clearSequenceQueue()}getResourceOwnership(){return this.resourceConflictManager.getResourceOwnership()}getSymphonyResourceMap(){return this.resourceConflictManager.getSymphonyResourceMap()}getSequenceInstances(){return this.resourceManager.getSequenceInstances()}}q.instance=null;const F=[];function Z(l){console.log("ðŸŽ¼ Registering all musical sequences with conductor...");let e=0,t=0;for(const s of F)try{l.registerSequence(s),e++,console.log(`âœ… Registered sequence: ${s.name}`)}catch(i){t++,console.error(`âŒ Failed to register sequence: ${s.name}`,i)}console.log(`ðŸŽ¼ Sequence registration complete: ${e} registered, ${t} failed`);const n=new Set(F.map(s=>s.category));console.log(`ðŸ“Š Sequence categories: ${Array.from(n).join(", ")}`)}function X(){const l=[],e=[];for(const t of F){const n=[];t.name||n.push("Missing sequence name"),t.description||n.push("Missing sequence description"),(!t.movements||t.movements.length===0)&&n.push("Missing movements"),t.movements?.forEach((s,i)=>{s.name||n.push(`Movement ${i}: Missing name`),(!s.beats||s.beats.length===0)&&n.push(`Movement ${i}: Missing beats`),s.beats?.forEach((r,o)=>{r.event||n.push(`Movement ${i}, Beat ${o}: Missing event`),r.dynamics||n.push(`Movement ${i}, Beat ${o}: Missing dynamics`)})}),n.length===0?l.push(t.name):e.push({name:t.name,errors:n})}return{valid:l,invalid:e}}function ee(l){console.log("ðŸŽ¼ Initializing Musical Sequences System...");const e=X();e.invalid.length>0&&console.warn("âš ï¸ Some sequences have validation errors:",e.invalid),Z(l);const t=l.getSequenceNames().length,n=t>0;return console.log(`ðŸŽ¼ Musical Sequences System initialized: ${n?"SUCCESS":"FAILED"}`),console.log(`ðŸ“Š Total sequences registered: ${t}`),{success:n,registeredSequences:t,validationResults:e}}let W=!1,U=null;function Pe(){if(W&&U)return console.log("ðŸŽ¼ Communication System already initialized, returning existing instance..."),U;console.log("ðŸŽ¼ Initializing RenderX Evolution Communication System...");const l=q.getInstance(H);H.connectToMainConductor(l);const e=ee(l);return console.log("âœ… Communication System initialized successfully"),console.log(`ðŸŽ¼ Registered ${e.registeredSequences} musical sequences`),e.validationResults.invalid.length>0&&console.warn("âš ï¸ Some sequences have validation issues:",e.validationResults.invalid),U={eventBus:H,conductor:l,sequenceResults:e},W=!0,U}const ke=Object.freeze(Object.defineProperty({__proto__:null,ALL_SEQUENCES:F,ConductorEventBus:G,EventBus:B,MUSICAL_CONDUCTOR_EVENT_TYPES:d,MUSICAL_DYNAMICS:T,MUSICAL_TIMING:y,MusicalConductor:q,SEQUENCE_PRIORITIES:f,eventBus:H,initializeCommunicationSystem:Pe,initializeMusicalSequences:ee,registerAllSequences:Z,validateAllSequences:X},Symbol.toStringTag,{value:"Module"}));export{b as D,d as M,ke as i};

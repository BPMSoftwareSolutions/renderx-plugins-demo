import{createMP4Encoder as G}from"./export.mp4-encoder-i-NQ4cFD.js";async function O(P,e){try{let $=function(t,g,r){return t+(g-t)*r};var T=$;if(e.logger?.info?.("MP4 export started with data:",P,"ctx:",e),typeof document>"u"){e.payload.error="Browser environment required for MP4 export",e.logger?.error("MP4 export failed: Browser environment required");return}const F=P&&Object.keys(P||{}).length>0?P:e.payload||{},{targetId:b,options:s}=F;if(!b){e.payload.error="No target element ID provided";return}const l=document.getElementById(b);if(!l){e.payload.error=`Element with ID "${b}" not found`;return}if(l.tagName.toLowerCase()!=="svg"){e.payload.error=`Element "${b}" is not an SVG element`;return}const R=l.getBoundingClientRect(),a=Math.max(1,Math.floor(s?.width??R.width??400)),i=Math.max(1,Math.floor(s?.height??R.height??300));e.logger?.info?.(`MP4 export dimensions: ${a}x${i}`);let M={left:0,top:0,width:a,height:i};try{const t=l.getBoundingClientRect();t.width>0&&t.height>0&&(M={left:t.left,top:t.top,width:t.width,height:t.height})}catch(t){e.logger?.warn?.("Could not get SVG bounding box:",t)}e.logger?.info?.(`SVG viewBox: ${l.getAttribute("viewBox")}`),e.logger?.info?.(`SVG bbox: ${Math.round(M.width)}x${Math.round(M.height)} at (${Math.round(M.left)}, ${Math.round(M.top)})`),e.logger?.info?.(`SVG CSS size: ${l.style.width} x ${l.style.height}`);const y=document.createElement("canvas");y.width=a,y.height=i;const S=y.getContext("2d");if(!S){e.payload.error="2D context unavailable";return}const k=s?.animation?.keyframes||[],A=Math.max(1,Math.floor(s?.fps??30)),B=Math.max(0,Math.floor(s?.durationMs??0)),v=B>0?Math.max(2,Math.round(A*B/1e3)):1;e.logger?.info?.(`MP4 animation: ${v} frames at ${A}fps (${B}ms duration)`),e.logger?.info?.("Creating MP4 encoder with options:",{width:a,height:i,fps:A,bitrate:s?.bitrate||2e6,codec:s?.codec||"avc1.42001f"});const d=await G({width:a,height:i,fps:A,bitrate:s?.bitrate||2e6,codec:s?.codec||"avc1.42001f"});await d.initialize(),v>1&&d.addFrame(y),e.logger?.info?.("MP4 encoder created successfully"),d.setProgressCallback(t=>{e.logger?.info?.(`MP4 encoding progress: ${Math.round(t*100)}%`)}),d.setCompleteCallback(t=>{try{const g=URL.createObjectURL(t),r=document.createElement("a");r.href=g;const E=(t.type||"").toLowerCase(),z=E.includes("webm")?"webm":(E.includes("mp4"),"mp4");r.download=`${b}-${Date.now()}.${z}`,r.click(),URL.revokeObjectURL(g),e.payload.downloadTriggered=!0,e.payload.videoSize=t.size,e.payload.videoType=t.type,e.logger?.info?.(`Video export completed: ${t.size} bytes (${t.type||"unknown"})`)}catch(g){e.logger?.error?.("Failed to trigger download:",g),e.payload.error=`Download failed: ${g}`}}),d.setErrorCallback(t=>{e.logger?.error?.("MP4 encoding error:",t),e.payload.error=`MP4 encoding failed: ${t.message}`});const N=s?.exportScope??"inner",x=s?.contentSelector;async function I(t){const g=v<=1?0:t/(v-1);let r;if(N==="wrapper"&&!x)r=l.cloneNode(!0);else if(r=document.createElementNS("http://www.w3.org/2000/svg","svg"),r.setAttribute("width",String(a)),r.setAttribute("height",String(i)),r.setAttribute("viewBox",`0 0 ${a} ${i}`),x){const o=l.querySelector(x);if(o){const m=document.createDocumentFragment();l.querySelectorAll("defs, style").forEach(f=>m.appendChild(f.cloneNode(!0))),r.appendChild(m);const w=o.cloneNode(!0);let c=0,n=0,p=a,u=i;try{const f=o.getBBox?.();f&&f.width>0&&f.height>0&&(c=f.x,n=f.y,p=f.width,u=f.height)}catch{}const D=a/p,U=i/u,C=Math.min(D,U),V=(a-p*C)/2,q=(i-u*C)/2;w.setAttribute("transform",`translate(${V-c*C}, ${q-n*C}) scale(${C})`),r.appendChild(w)}}else Array.from(l.children).forEach(m=>{r.appendChild(m.cloneNode(!0))});if(k&&Array.isArray(k)&&k.length)for(const o of k){const m=r.querySelectorAll(o.selector),h=$(Number(o.from),Number(o.to),g);m.forEach(w=>{try{const c=w;if(o.kind==="rotate"){const n=c.getBBox?.(),p=n?n.x+n.width/2:a/2,u=n?n.y+n.height/2:i/2;c.setAttribute("transform",`rotate(${h} ${p} ${u})`)}else if(o.kind==="scale"){const n=c.getBBox?.(),p=n?n.x+n.width/2:a/2,u=n?n.y+n.height/2:i/2;c.setAttribute("transform",`translate(${p} ${u}) scale(${h}) translate(${-p} ${-u})`)}else c.setAttribute(o.attr,String(h))}catch(c){e.logger?.warn?.(`Failed to apply keyframe ${o.selector}:`,c)}})}const z=new XMLSerializer().serializeToString(r),L=`data:image/svg+xml;charset=utf-8,${encodeURIComponent(z)}`;d.addFrame(y),await Promise.race([new Promise((o,m)=>{const h=new Image;h.onload=()=>{try{s?.backgroundColor?(S.fillStyle=s.backgroundColor,S.fillRect(0,0,a,i)):S.clearRect(0,0,a,i),S.drawImage(h,0,0,a,i),o()}catch(w){m(w)}},h.onerror=()=>o(),h.src=L}),new Promise(o=>setTimeout(o,0))]),d.addFrame(y)}for(let t=0;t<v;t++)await I(t);d.addFrame(y),await d.finalize()}catch($){e.logger?.error?.("MP4 export failed:",$),e.payload.error=`MP4 export failed: ${$}`}}export{O as exportSvgToMp4};

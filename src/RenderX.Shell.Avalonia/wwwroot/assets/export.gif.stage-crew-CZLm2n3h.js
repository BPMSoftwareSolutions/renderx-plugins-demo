const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/gif-BTd4lv-c.js","assets/EventRouter-DUQzZvsb.js"])))=>i.map(i=>d[i]);
import{_ as U}from"./global-CMa2Rm43.js";import"./EventRouter-DUQzZvsb.js";async function q($,e,M){const{default:w}=await U(async()=>{const{default:h}=await import("./gif-BTd4lv-c.js").then(r=>r.g);return{default:h}},__vite__mapDeps([0,1])),{default:I}=await U(async()=>{const{default:h}=await import("./gif.worker-BBVOAfM6.js");return{default:h}},[]);return new w({workers:M?.workers,workerScript:I,quality:M?.quality,repeat:M?.repeat,width:$,height:e})}async function X($,e){try{let w=function(o,g,t){return o+(g-o)*t};var M=w;if(typeof document>"u"){e.payload.error="Browser environment required for GIF export";return}const I=$&&Object.keys($||{}).length>0?$:e.payload||{},{targetId:h,options:r}=I;if(!h){e.payload.error="No target element ID provided";return}const n=document.getElementById(h);if(!n){e.payload.error=`Element with ID "${h}" not found`;return}if(n.tagName.toLowerCase()!=="svg"){e.payload.error="Selected element is not an SVG";return}const f=n.getBoundingClientRect();let i=Math.round(r?.width??f.width),s=Math.round(r?.height??f.height);const L=parseFloat(n.style.width)||0,T=parseFloat(n.style.height)||0;if(L>0&&T>0&&(f.width<L*.95||f.height<T*.95)&&(i=Math.round(r?.width??L),s=Math.round(r?.height??T),e.logger?.info?.(`Using CSS dimensions (${i}x${s}) instead of bbox (${Math.round(f.width)}x${Math.round(f.height)}) due to clipping`)),i<=0||s<=0){e.payload.error="Invalid dimensions for export";return}if(e.logger?.info?.(`Exporting SVG "${h}" to GIF (${i}x${s})`),e.logger?.info?.(`SVG element position: left=${n.style.left}, top=${n.style.top}`),e.logger?.info?.(`SVG viewBox: ${n.getAttribute("viewBox")}`),e.logger?.info?.(`SVG bbox: ${Math.round(f.width)}x${Math.round(f.height)} at (${Math.round(f.left)}, ${Math.round(f.top)})`),e.logger?.info?.(`SVG CSS size: ${n.style.width} x ${n.style.height}`),window.EXPORT_SERVER_ENABLED===!0||r?.serverExport===!0)try{const o=new XMLSerializer,g=n.cloneNode(!0);g.setAttribute("width",String(i)),g.setAttribute("height",String(s));const R={svg:o.serializeToString(g),width:i,height:s,fps:Math.max(1,Math.floor(r?.fps??20)),duration:Math.max(0,Math.floor((r?.durationMs??1e4)/1e3)),maxColors:r?.maxColors??256,dither:r?.dither??"sierra2_4a",loop:r?.loop??0,filename:`${h}-${Date.now()}.gif`},z=window.EXPORT_SERVER_PORT||5055,m=await fetch(`http://localhost:${z}/api/export/gif`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(R)});if(!m.ok){const c=await m.json().catch(()=>({}));throw e.logger?.error?.("Server export failed",c),new Error(c?.error||`Export server error: ${m.status} ${m.statusText}`)}const C=await m.blob(),l=URL.createObjectURL(C),d=document.createElement("a");d.href=l,d.download=R.filename,d.click(),URL.revokeObjectURL(l),e.payload.downloadTriggered=!0,e.payload.gifSize=C.size;return}catch(o){e.logger?.warn?.("Server-side GIF export failed, falling back to in-browser encoding",o)}const x=document.createElement("canvas");x.width=i,x.height=s;const v=x.getContext("2d");if(!v){e.payload.error="2D context unavailable";return}const E=await q(i,s,{workers:2,quality:10,repeat:0}),O=r?.exportScope??"inner",_=r?.contentSelector,A=r?.animation?.keyframes||[],B=Math.max(1,Math.floor(r?.fps??5)),F=Math.max(0,Math.floor(r?.durationMs??0)),k=F>0?Math.max(2,Math.round(B*F/1e3)):1,D=k<=1?100:Math.max(1,Math.round(1e3/B));async function V(o){const g=k<=1?0:o/(k-1);let t;if(O==="wrapper"&&!_)t=n.cloneNode(!0);else{t=document.createElementNS("http://www.w3.org/2000/svg","svg"),t.setAttribute("xmlns","http://www.w3.org/2000/svg"),t.setAttribute("xmlns:xlink","http://www.w3.org/1999/xlink");const l=n.getAttribute("viewBox");if(l?t.setAttribute("viewBox",l):t.setAttribute("viewBox",`0 0 ${i} ${s}`),_){const d=n.querySelector(_);if(d){const c=document.createDocumentFragment();n.querySelectorAll("defs, style").forEach(u=>c.appendChild(u.cloneNode(!0))),t.appendChild(c);const y=d.cloneNode(!0);let a=0,p=0,S=i,N=s;try{const u=d.getBBox?.();u&&u.width>0&&u.height>0&&(a=u.x,p=u.y,S=u.width,N=u.height)}catch{}const G=document.createElementNS("http://www.w3.org/2000/svg","g");G.setAttribute("transform",`translate(${-a} ${-p})`),G.appendChild(y),t.appendChild(G),t.setAttribute("viewBox",`${a} ${p} ${S} ${N}`)}else t.innerHTML=n.innerHTML}else t.innerHTML=n.innerHTML}t.setAttribute("width",String(i)),t.setAttribute("height",String(s));const R=r?.excludeSelectors||[];for(const l of R)try{t.querySelectorAll(l).forEach(d=>d.parentNode?.removeChild(d))}catch{}if(A&&Array.isArray(A)&&A.length)for(const l of A){const d=t.querySelectorAll(l.selector),c=w(Number(l.from),Number(l.to),g);d.forEach(b=>{try{const y=b;if(l.kind==="rotate"){const a=y.getBBox?.(),p=a?a.x+a.width/2:i/2,S=a?a.y+a.height/2:s/2;y.setAttribute("transform",`rotate(${c} ${p} ${S})`)}else if(l.kind==="scale"){const a=y.getBBox?.(),p=a?a.x+a.width/2:i/2,S=a?a.y+a.height/2:s/2;y.setAttribute("transform",`translate(${p} ${S}) scale(${c}) translate(${-p} ${-S})`)}else y.setAttribute(l.attr,String(c))}catch{}})}const m=new XMLSerializer().serializeToString(t),C="data:image/svg+xml;charset=utf-8,"+encodeURIComponent(m);await new Promise((l,d)=>{const c=new Image;c.onload=()=>{try{r?.backgroundColor?(v.fillStyle=r.backgroundColor,v.fillRect(0,0,i,s)):v.clearRect(0,0,i,s),v.drawImage(c,0,0,i,s),l()}catch(b){d(b)}},c.onerror=b=>d(b),c.src=C}),E.addFrame(x,{delay:D,copy:!0})}for(let o=0;o<k;o++)await V(o);E.on("finished",o=>{try{const g=URL.createObjectURL(o),t=document.createElement("a");t.href=g,t.download=`${h}-${Date.now()}.gif`,t.click(),URL.revokeObjectURL(g),e.payload.downloadTriggered=!0,e.payload.gifSize=o.size,e.logger?.info?.(`GIF export completed: ${o.size} bytes`)}catch(g){e.logger?.error?.("Failed to trigger download:",g),e.payload.error=`Download failed: ${g}`}}),E.on("progress",o=>{e.logger?.info?.(`GIF encoding progress: ${Math.round(o*100)}%`)}),E.render()}catch(w){e.logger?.error?.("Failed to export SVG to GIF:",w),e.payload.error=String(w),e.payload.downloadTriggered=!1}}export{X as exportSvgToGif};

import{getCanvasOrThrow as O}from"./select.overlay.dom.stage-crew-T3p4uTrs.js";import{recomputeLineSvg as H}from"./line.recompute.stage-crew-Cdi50jWQ.js";import{E as W}from"./EventRouter-DUQzZvsb.js";import{r as _}from"./interactionManifest-BORsh5a3.js";import"./select.overlay.css.stage-crew-CJxa9lQN.js";function k(){if(typeof document>"u")return;const e="rx-adv-line-overlay-styles";let y=document.getElementById(e);y||(y=document.createElement("style"),y.id=e,document.head.appendChild(y)),(y.textContent||"").includes(".rx-adv-line-overlay")||y.appendChild(document.createTextNode(`
  .rx-adv-line-overlay { position:absolute; pointer-events:none; z-index:12; }
  .rx-adv-line-overlay .handle { position:absolute; width:12px; height:12px; border:2px solid #3b82f6; background:#fff; border-radius:50%; pointer-events:auto; box-sizing:border-box; box-shadow:0 0 0 2px rgba(59,130,246,0.35); }
  `))}function K(e){k();const y=O();let t=document.getElementById("rx-adv-line-overlay");if(!t){t=document.createElement("div"),t.id="rx-adv-line-overlay",t.className="rx-adv-line-overlay";const n=document.createElement("div");n.className="handle a";const c=document.createElement("div");c.className="handle b",t.appendChild(n),t.appendChild(c),y.appendChild(t)}if(Array.from(t.querySelectorAll(".handle.curve, .handle.rotate")).forEach(n=>n.remove()),!t.querySelector(".handle.a")){const n=document.createElement("div");n.className="handle a",t.appendChild(n)}if(!t.querySelector(".handle.b")){const n=document.createElement("div");n.className="handle b",t.appendChild(n)}const d=e.getBoundingClientRect(),E=y.getBoundingClientRect();t.style.left=`${Math.round(d.left-E.left)}px`,t.style.top=`${Math.round(d.top-E.top)}px`,t.style.width=`${Math.round(d.width)}px`,t.style.height=`${Math.round(d.height)}px`;try{try{H(e)}catch{}const n=e,c=(n.getAttribute("viewBox")||"0 0 100 100").split(/\s+/).map(o=>parseFloat(o)),[B,P,F,V]=[c[0]||0,c[1]||0,c[2]||100,c[3]||100],x=n.querySelector("line.segment"),s=n.querySelector("path.segment-curve"),g=(o,a)=>({x:(o-B)/F*d.width,y:(a-P)/V*d.height});let l={x:0,y:0},p={x:d.width,y:d.height};if(x&&x.style.display!=="none"){const o=parseFloat(x.getAttribute("x1")||"0"),a=parseFloat(x.getAttribute("y1")||"0"),i=parseFloat(x.getAttribute("x2")||String(100)),r=parseFloat(x.getAttribute("y2")||String(0));l=g(o,a),p=g(i,r)}else if(s&&s.style.display!=="none"){const o=typeof s.getTotalLength=="function"?s.getTotalLength():0;if(o>0&&typeof s.getPointAtLength=="function"){const a=s.getPointAtLength(0),i=s.getPointAtLength(o);l=g(a.x,a.y),p=g(i.x,i.y)}}else{const o=typeof window<"u"?getComputedStyle(e):{},a=(v,b)=>{const m=e.style.getPropertyValue(v),M=typeof o.getPropertyValue=="function"?o.getPropertyValue(v):"",h=parseFloat(String(m||M||b));return Number.isFinite(h)?h:parseFloat(b)},i=a("--x1","0"),r=a("--y1","0"),w=a("--x2",String(d.width)),L=a("--y2",String(r));l={x:i,y:r},p={x:w,y:L}}const $=typeof window<"u"?getComputedStyle(e):{},I=e.style.getPropertyValue("--angle")||(typeof $.getPropertyValue=="function"?$.getPropertyValue("--angle"):"0"),u=parseFloat(I||"0");if(Number.isFinite(u)&&Math.abs(u)>1e-4){const o=u*Math.PI/180,a=(l.x+p.x)/2,i=(l.y+p.y)/2,r=w=>{const L=w.x-a,v=w.y-i,b=Math.cos(o),m=Math.sin(o);return{x:a+L*b-v*m,y:i+L*m+v*b}};l=r(l),p=r(p)}const C=t.querySelector(".handle.a"),q=t.querySelector(".handle.b");C&&(C.style.left=`${Math.round(l.x-5)}px`,C.style.top=`${Math.round(l.y-5)}px`),q&&(q.style.left=`${Math.round(p.x-5)}px`,q.style.top=`${Math.round(p.y-5)}px`)}catch{}return t}function Q(e,y){e._rxAdvLineManipAttached||(e._rxAdvLineManipAttached=!0,e.addEventListener("mousedown",t=>{const d=t.target;if(!d||!d.classList.contains("handle"))return;t.preventDefault();const E=d.classList.contains("a")?"a":"b",n=e.dataset.targetId;if(!n)return;const c=document.getElementById(n);if(!c)return;const B={x:t.clientX,y:t.clientY};let P={x:B.x,y:B.y};const F=async(s,g=0,l=0)=>{const p=s==="start"?"canvas.component.manip.line.start":s==="end"?"canvas.component.manip.line.end":"canvas.component.manip.line.move",$={id:n,handle:E,dx:g,dy:l,phase:s},I=y?.play||window.RenderX?.conductor?.play;if(typeof I=="function")try{await W.publish(p,$,y||window.RenderX?.conductor);return}catch{try{const u=_(p);await I(u.pluginId,u.sequenceId,$);return}catch{}}if(s==="move"){const u=E==="a",C=parseFloat(c.style.getPropertyValue(u?"--x1":"--x2")||"0"),q=parseFloat(c.style.getPropertyValue(u?"--y1":"--y2")||"0"),o=Math.round(C+g),a=Math.round(q+l);c.style.setProperty(u?"--x1":"--x2",`${o}`),c.style.setProperty(u?"--y1":"--y2",`${a}`);const i=c;try{H(i)}catch{}try{const r=(i.getAttribute("viewBox")||"0 0 100 100").split(/\s+/).map(f=>parseFloat(f)),[w,L,v,b]=[r[0]||0,r[1]||0,r[2]||100,r[3]||100],m=c.getBoundingClientRect(),M=(f,S)=>({x:(f-w)/v*m.width,y:(S-L)/b*m.height}),A=i.querySelector("line.segment"),h=i.querySelector("path.segment-curve");let N={x:0,y:0},X={x:m.width,y:m.height};if(A&&A.style.display!=="none"){const f=parseFloat(A.getAttribute("x1")||"0"),S=parseFloat(A.getAttribute("y1")||"0"),R=parseFloat(A.getAttribute("x2")||"100"),z=parseFloat(A.getAttribute("y2")||"0");N=M(f,S),X=M(R,z)}else if(h&&h.style.display!=="none"){const f=typeof h.getTotalLength=="function"?h.getTotalLength():0;if(f>0&&typeof h.getPointAtLength=="function"){const S=h.getPointAtLength(0),R=h.getPointAtLength(f);N=M(S.x,S.y),X=M(R.x,R.y)}}const T=e.querySelector(".handle.a"),Y=e.querySelector(".handle.b");T&&(T.style.left=`${Math.round(N.x-5)}px`,T.style.top=`${Math.round(N.y-5)}px`),Y&&(Y.style.left=`${Math.round(X.x-5)}px`,Y.style.top=`${Math.round(X.y-5)}px`)}catch{const r=e.querySelector(u?".handle.a":".handle.b");r&&(r.style.left=`${o-5}px`,r.style.top=`${a-5}px`)}}},V=s=>{const g=s.clientX-P.x,l=s.clientY-P.y;P={x:s.clientX,y:s.clientY},F("move",g,l)},x=()=>{F("end"),document.removeEventListener("mousemove",V),document.removeEventListener("mouseup",x)};F("start"),document.addEventListener("mousemove",V),document.addEventListener("mouseup",x)}))}export{Q as attachAdvancedLineManipHandlers,K as ensureAdvancedLineOverlayFor};

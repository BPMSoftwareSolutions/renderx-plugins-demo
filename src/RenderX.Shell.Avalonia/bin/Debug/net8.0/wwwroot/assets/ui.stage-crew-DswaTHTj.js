import{S as g}from"./chunk-FUFL4N7I-ClPrRS59.js";import{r as y}from"./interactionManifest-BORsh5a3.js";var u={},n={isInitialized:!1,schemasLoaded:!1},s=!1,p=!1;async function I(a,e){if(s||p){e.logger?.info?.("UI Init skipped (in-flight/done)");return}s=!0;try{const r=[{event:"control:panel:ui:config:load",handler:c},{event:"control:panel:ui:resolver:init",handler:h},{event:"control:panel:ui:schemas:load",handler:v},{event:"control:panel:ui:observers:register",handler:m},{event:"control:panel:ui:ready:notify",handler:w}],o=[];for(const l of r){const d=typeof performance<"u"&&performance.now?performance.now():Date.now();try{await Promise.resolve(l.handler(a,e));const t=typeof performance<"u"&&performance.now?performance.now():Date.now();o.push({event:l.event,dur:t-d,status:"ok"})}catch(t){const f=typeof performance<"u"&&performance.now?performance.now():Date.now();throw o.push({event:l.event,dur:f-d,status:"error",error:String(t)}),t}}e.payload.uiInitTelemetry={subBeats:o};const i=o.reduce((l,d)=>l+d.dur,0);e.logger?.info?.(`UI Init (batched) â€” ${Math.round(i)}ms`,{subBeats:o})}finally{s=!1,p=!0}}function c(a,e){try{e.payload.configLoaded=!0,e.logger?.info?.("Control Panel config initialized")}catch(r){e.payload.configLoaded=!1,e.payload.error=String(r),e.logger?.error?.("Failed to initialize config:",r)}}function h(a,e){try{const r=a.config||{},o=new g(r);n.config=r,n.resolver=o,e.payload.resolver=o,e.payload.resolverInitialized=!0,e.logger?.info?.("Schema resolver initialized")}catch(r){e.payload.resolverInitialized=!1,e.payload.error=String(r),e.logger?.error?.("Failed to initialize resolver:",r)}}async function v(a,e){try{const r=e.payload.resolver||n.resolver;if(!r)throw new Error("Resolver not initialized");const o=a.componentTypes||["button","input","container","line","heading","paragraph","image","svg"];if(typeof fetch>"u"||typeof globalThis>"u"||typeof process<"u"&&u&&!1){e.payload.schemasLoaded=!0,e.logger?.info?.("Component schemas loaded");return}await r.loadComponentSchemas(o),e.payload.schemasLoaded=!0,e.logger?.info?.("Component schemas loaded")}catch(r){e.payload.schemasLoaded=!1,e.payload.error=String(r),e.logger?.error?.("Failed to load schemas:",r)}}function m(a,e){try{e.payload.observersRegistered=!0,e.logger?.info?.("UI observers registered")}catch(r){e.payload.observersRegistered=!1,e.payload.error=String(r),e.logger?.error?.("Failed to register observers:",r)}}function w(a,e){try{n.isInitialized=!0,e.payload.uiReady=!0,e.payload.timestamp=Date.now(),e.logger?.info?.("Control Panel UI ready")}catch(r){e.payload.uiReady=!1,e.payload.error=String(r),e.logger?.error?.("Failed to notify UI ready:",r)}}function b(a,e){try{const{selectedElement:r}=a||{},o=n.resolver;if(!o||!r){e.payload.fields=[];return}const i=o.generatePropertyFields(r);e.payload.fields=i,e.payload.fieldsGenerated=!0,e.logger?.info?.(`Generated ${i.length} property fields`)}catch(r){e.payload.fields=[],e.payload.fieldsGenerated=!1,e.payload.error=String(r),e.logger?.error?.("Failed to generate fields:",r)}}function D(a,e){try{const{selectedElement:r}=a||{},o=n.resolver;if(!o||!r){e.payload.sections=[];return}const i=o.generateSections(r.header.type);e.payload.sections=i,e.payload.sectionsGenerated=!0,e.logger?.info?.(`Generated ${i.length} sections`)}catch(r){e.payload.sections=[],e.payload.sectionsGenerated=!1,e.payload.error=String(r),e.logger?.error?.("Failed to generate sections:",r)}}function E(a,e){try{e.payload.viewRendered=!0,e.payload.renderTimestamp=Date.now(),e.logger?.info?.("UI view rendered")}catch(r){e.payload.viewRendered=!1,e.payload.error=String(r),e.logger?.error?.("Failed to render view:",r)}}function $(a,e){try{const{fieldKey:r,value:o,selectedElement:i}=a||{};if(!r||o===void 0||!i)throw new Error("Field change requires fieldKey, value, and selectedElement");e.payload.fieldKey=r,e.payload.value=o,e.payload.selectedElement=i,e.payload.fieldPrepared=!0,e.logger?.info?.(`Field change prepared: ${r} = ${o}`)}catch(r){e.payload.fieldPrepared=!1,e.payload.error=String(r),e.logger?.error?.("Failed to prepare field change:",r)}}function R(a,e){try{const{fieldKey:r,value:o,selectedElement:i}=e.payload||{};if(!i?.header?.id)throw new Error("Selected element ID is required for field dispatch");if(e?.conductor?.play)try{const l=y("canvas.component.update");e.conductor.play(l.pluginId,l.sequenceId,{id:i.header.id,attribute:r,value:o}),e.payload.fieldDispatched=!0,e.logger?.info?.(`Field change dispatched to canvas: ${r} = ${o}`)}catch(l){e.payload.fieldDispatched=!1,e.payload.error=`Failed to dispatch to canvas: ${l}`,e.logger?.error?.("Failed to dispatch to canvas:",l)}else e.payload.fieldDispatched=!1,e.payload.error="Conductor not available for field dispatch",e.logger?.warn?.("Conductor not available for field dispatch")}catch(r){e.payload.fieldDispatched=!1,e.payload.error=String(r),e.logger?.error?.("Failed to dispatch field change:",r)}}function T(a,e){try{e.payload.isDirty=!0,e.payload.dirtyTimestamp=Date.now(),e.logger?.info?.("UI marked as dirty")}catch(r){e.payload.error=String(r),e.logger?.error?.("Failed to set dirty state:",r)}}function U(a,e){try{e.payload.refreshAwaited=!0,e.logger?.info?.("Awaiting UI refresh")}catch(r){e.payload.error=String(r),e.logger?.error?.("Failed to await refresh:",r)}}function z(a,e){try{const{field:r,value:o}=a||{},i=n.resolver;if(!i||!r){e.payload.isValid=!0,e.payload.errors=[];return}const l=i.validateField(r,o);e.payload.isValid=l.isValid,e.payload.errors=l.errors,e.payload.fieldKey=r.key,e.logger?.info?.(`Field validation: ${r.key} - ${l.isValid?"valid":"invalid"}`)}catch(r){e.payload.isValid=!1,e.payload.errors=[String(r)],e.payload.error=String(r),e.logger?.error?.("Failed to validate field:",r)}}function V(a,e){try{const{fieldKey:r}=e.payload||{};e.payload.errorsMerged=!0,e.logger?.info?.(`Validation errors merged for field: ${r}`)}catch(r){e.payload.errorsMerged=!1,e.payload.error=String(r),e.logger?.error?.("Failed to merge errors:",r)}}function C(a,e){try{e.payload.viewUpdated=!0,e.payload.updateTimestamp=Date.now(),e.logger?.info?.("View updated for validation")}catch(r){e.payload.viewUpdated=!1,e.payload.error=String(r),e.logger?.error?.("Failed to update view:",r)}}function G(a,e){try{const{sectionId:r}=a||{};if(!r)throw new Error("Section toggle requires sectionId");e.payload.sectionId=r,e.payload.sectionToggled=!0,e.logger?.info?.(`Section toggled: ${r}`)}catch(r){e.payload.sectionToggled=!1,e.payload.error=String(r),e.logger?.error?.("Failed to toggle section:",r)}}export{U as awaitRefresh,R as dispatchField,b as generateFields,D as generateSections,c as initConfig,I as initMovement,h as initResolver,v as loadSchemas,V as mergeErrors,w as notifyReady,$ as prepareField,m as registerObservers,E as renderView,T as setDirty,G as toggleSection,C as updateView,z as validateField};

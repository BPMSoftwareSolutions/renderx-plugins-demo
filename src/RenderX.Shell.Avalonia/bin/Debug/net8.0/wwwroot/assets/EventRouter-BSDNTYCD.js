const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/ajv-DfNq1LhF.js","assets/EventRouter-DUQzZvsb.js"])))=>i.map(i=>d[i]);
import{g as p,i as g,_ as $,a as T}from"./global-CMa2Rm43.js";import"./EventRouter-DUQzZvsb.js";const f=new Map,E=new Set(["control.panel.selection.updated","canvas.component.selection.changed"]),l=new Map;function R(e,r){let s=0,t=null;return c=>{const u=Date.now();u-s>=r?(s=u,e(c)):(t=c,setTimeout(()=>{const i=Date.now();if(i-s>=r&&t!==null){s=i;const o=t;t=null,e(o)}},r-(u-s)))}}function m(e,r){let s=null;return t=>{s&&clearTimeout(s),s=setTimeout(()=>e(t),r)}}const w=[],U={async init(){await T()},subscribe(e,r){const s=l.get(e)||new Set;s.add(r),l.set(e,s);try{if(E.has(e)&&f.has(e)){const t=f.get(e);Promise.resolve().then(()=>{try{r(t)}catch{}})}}catch{}return()=>{const t=l.get(e);t&&(t.delete(r),t.size===0&&l.delete(e))}},async publish(e,r,s){typeof window<"u"&&(window.__DEBUG_EVENTROUTER=window.__DEBUG_EVENTROUTER||[],window.__DEBUG_EVENTROUTER.push(`publish(${e})`));let t=p(e);if(!t&&typeof window<"u"){const o=window.RenderX?.getTopicDef;if(o){t=o(e),typeof window<"u"&&window.__DEBUG_EVENTROUTER.push(`used_global_getTopicDef(${e}): ${!!t}`);try{console.log(`[EventRouter] Used global getTopicDef for '${e}', found: ${!!t}`)}catch{}}}if(!t){typeof window<"u"&&window.__DEBUG_EVENTROUTER.push(`no_topic_def(${e})`);try{console.warn(`[EventRouter] No topic definition found for '${e}'`)}catch{}throw new Error(`Unknown topic: ${e}`)}typeof window<"u"&&window.__DEBUG_EVENTROUTER.push(`found_topic_def(${e}): routes=${t.routes?.length||0}`);try{console.log(`[EventRouter] Topic '${e}' definition:`,{routes:t.routes?.length||0,hasThrottle:!!t.perf?.throttleMs,hasDebounce:!!t.perf?.debounceMs})}catch{}if(w.includes(e)){try{console.warn(`[topics] Blocking immediate republish of '${e}' to prevent feedback loop`)}catch{}return}try{if(g("lint.topics.runtime-validate")&&t.payloadSchema){const o=await $(()=>import("./ajv-DfNq1LhF.js").then(_=>_.a),__vite__mapDeps([0,1])),d=o?.default||o,a=new d({allErrors:!0}).compile(t.payloadSchema);if(!a(r)){const y=(a.errors||[]).map(h=>`${h.instancePath||h.dataPath||""} ${h.message||""}`.trim()).join("; ");throw new Error(`Payload validation failed for ${e}: ${y}`)}}}catch{}const c=s&&typeof s.play=="function"?s:typeof window<"u"?window.RenderX?.conductor||window.renderxCommunicationSystem?.conductor:void 0;try{const o=c?.__rxId,d=typeof window<"u"?window.RenderX?.conductor?.__rxId:void 0;console.log(`[EventRouter] resolvedConductor id=${o} (global id=${d}) for '${e}'`)}catch{}let u=async o=>{typeof window<"u"&&window.__DEBUG_EVENTROUTER.push(`deliver_start(${e}): routes=${t.routes?.length||0}`);try{console.log(`[EventRouter] Starting delivery for '${e}' with ${t.routes?.length||0} routes`)}catch{}for(const n of t.routes){typeof window<"u"&&window.__DEBUG_EVENTROUTER.push(`routing_to: ${n.pluginId}::${n.sequenceId}`);try{const a=!!(c&&typeof c.play=="function");try{console.log(`[topics] Routing '${e}' -> ${n.pluginId}::${n.sequenceId} (hasPlay=${a})`)}catch{}await c?.play?.(n.pluginId,n.sequenceId,o),typeof window<"u"&&window.__DEBUG_EVENTROUTER.push(`routed_success: ${n.pluginId}::${n.sequenceId}`)}catch(a){typeof window<"u"&&window.__DEBUG_EVENTROUTER.push(`route_error: ${n.pluginId}::${n.sequenceId} - ${a}`);try{console.warn(`[topics] Failed to route '${e}' -> ${n.pluginId}::${n.sequenceId}:`,a)}catch{}}}try{E.has(e)&&f.set(e,o)}catch{}const d=l.get(e);if(d)for(const n of Array.from(d))try{n(o)}catch{}};const i=t.perf||{};if(typeof i.throttleMs=="number"&&i.throttleMs>0){const o=u;R(n=>o(n),i.throttleMs)(r);return}if(typeof i.debounceMs=="number"&&i.debounceMs>0){const o=u;m(n=>o(n),i.debounceMs)(r);return}w.push(e);try{await u(r)}finally{w.pop()}},reset(){try{l.clear(),f.clear(),w.length=0}catch{}}};export{U as EventRouter};

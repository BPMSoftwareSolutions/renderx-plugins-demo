import { build } from 'esbuild';
import path from 'node:path';
import fs from 'node:fs';

const projectRoot = process.cwd();
const entry = path.resolve(projectRoot, 'tools/avalonia-integration/build/entry.js');
const outfile = path.resolve(projectRoot, 'tools/avalonia-integration/Resources/conductor-bundle.js');

// Ensure output directory exists
fs.mkdirSync(path.dirname(outfile), { recursive: true });

(async () => {
  try {
    await build({
      entryPoints: [entry],
      outfile,
      bundle: true,
      format: 'iife',
      globalName: 'MusicalConductorBundle',
      platform: 'browser',
      target: ['es2020'],
      sourcemap: false,
      minify: false,
      logLevel: 'info',
      // Avoid code-splitting; produce a single file suitable for Jint
      splitting: false,
      // Silence legal comment banners to keep the file compact
      legalComments: 'none',
      banner: {
        js: `/* Auto-generated by esbuild. Source: dist/modules/communication. Do not edit directly. */`,
      },
    });

    console.log(`✅ Built MusicalConductor bundle -> ${outfile}`);
  } catch (err) {
    console.error('❌ Failed to build MusicalConductor bundle:', err);
    process.exit(1);
  }
})();

